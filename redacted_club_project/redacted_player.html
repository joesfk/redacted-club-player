<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta http-equiv="Content-Security-Policy" content="default-src 'self'; style-src 'self' 'unsafe-inline' https://fonts.googleapis.com; font-src https://fonts.gstatic.com; img-src 'self' data:; media-src 'self'; script-src 'self' 'unsafe-inline';">
<title>‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë</title>
<link rel="icon" type="image/svg+xml" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 32 32'%3E%3Crect width='32' height='32' rx='4' fill='%23050505'/%3E%3Crect x='2' y='2' width='28' height='28' rx='3' fill='none' stroke='%2300ff41' stroke-width='1.5' opacity='0.6'/%3E%3Ctext x='16' y='23' text-anchor='middle' font-family='monospace' font-size='18' font-weight='bold' fill='%2300ff41'%3ERC%3C/text%3E%3C/svg%3E">
<style>
  @import url('https://fonts.googleapis.com/css2?family=Share+Tech+Mono&family=VT323&display=swap');
  :root{--green:#00ff41;--green-dim:#00aa2a;--green-dark:#00752b;--green-ghost:#004d18;--red:#ff0040;--amber:#ffaa00;--cyan:#00aaff;--bg:#050505;--sidebar-w:220px}
  *{margin:0;padding:0;box-sizing:border-box}
  html,body{width:100%;height:100%;background:#000;overflow:hidden;cursor:default;user-select:none;font-family:'Share Tech Mono',monospace}

  /* ‚ïê‚ïê‚ïê STAGE & ENVIRONMENT ‚ïê‚ïê‚ïê */
  #stage{width:100%;height:100%;perspective:2000px;overflow:hidden;display:flex;align-items:center;justify-content:center;background:#000}
  #bg-env{position:fixed;inset:0;z-index:0;opacity:0;background:radial-gradient(ellipse at center,#0a0a0a 0%,#000 70%);transition:opacity 2s ease-in-out}

  /* SERVER ROOM */
  #server-room{
    position:fixed;inset:0;z-index:0;opacity:0;pointer-events:none;
    background:
      radial-gradient(circle at 20% 80%, rgba(0,255,65,0.03) 0%, transparent 15%),
      radial-gradient(circle at 80% 60%, rgba(0,170,255,0.02) 0%, transparent 20%),
      radial-gradient(circle at 50% 100%, rgba(255,0,64,0.02) 0%, transparent 25%),
      linear-gradient(180deg, #000000 0%, #0a0a0a 50%, #000000 100%);
    transition:opacity 2s ease-in-out;
  }
  #server-room::before{
    content:'';position:absolute;inset:0;
    background:
      repeating-linear-gradient(90deg, transparent 0px, transparent 100px, rgba(0,255,65,0.01) 100px, rgba(0,255,65,0.01) 101px),
      repeating-linear-gradient(0deg, transparent 0px, transparent 150px, rgba(0,255,65,0.015) 150px, rgba(0,255,65,0.015) 151px);
  }
  #server-room::after{
    content:'‚ñà TERMINAL 07 ‚ñà';
    position:absolute;bottom:8%;left:50%;transform:translateX(-50%);
    font-family:'VT323',monospace;font-size:14px;color:rgba(0,255,65,0.3);
    text-shadow:0 0 10px rgba(0,255,65,0.5);letter-spacing:4px;
  }

  /* BG MONITORS */
  .bg-monitor{
    position:absolute;opacity:0;transition:opacity 2s ease-in-out;
    border:1px solid rgba(0,255,65,0.1);background:rgba(0,0,0,0.8);
    box-shadow:0 0 10px rgba(0,255,65,0.1);
  }
  .bg-monitor::before{
    content:'‚ñà';font-family:'VT323',monospace;color:rgba(0,255,65,0.2);
    position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);
    font-size:20px;animation:flicker 3s infinite;
  }

  /* ‚ïê‚ïê‚ïê TERMINAL SURFACE & CRT ‚ïê‚ïê‚ïê */
  #terminal-surface{
    width:100vw;height:100vh;position:relative;z-index:1;
    transform-style:preserve-3d;transition:all 2.5s cubic-bezier(0.4, 0.0, 0.2, 1);
    background:var(--bg);border-radius:18px;overflow:hidden;
    box-shadow:inset 0 0 80px rgba(0,255,65,.03),inset 0 0 200px rgba(0,0,0,.5),0 0 40px rgba(0,255,65,.06),0 0 2px rgba(0,255,65,.1);
  }

  /* CRT BEZEL */
  #crt-bezel{
    position:fixed;inset:0;z-index:5;pointer-events:none;opacity:0;
    transition:opacity 2s ease-in-out;
  }
  #crt-bezel::before{
    content:'';position:absolute;
    top:17%;left:50%;transform:translateX(-50%);
    width:36%;height:66%;
    border:20px solid #1a1a1a;
    border-radius:12px;
    box-shadow:
      inset 0 0 20px rgba(0,0,0,0.9),
      inset 0 0 40px rgba(0,0,0,0.6),
      0 0 30px rgba(0,0,0,0.8),
      0 10px 40px rgba(0,0,0,0.9);
  }
  #crt-bezel::after{
    content:'';position:absolute;
    top:calc(17% - 45px);left:50%;transform:translateX(-50%);
    width:calc(36% + 40px);height:30px;
    background:linear-gradient(180deg, #0d0d0d 0%, #1a1a1a 50%, #0d0d0d 100%);
    border-radius:6px 6px 0 0;
    box-shadow:0 2px 10px rgba(0,0,0,0.8);
  }
  #terminal-surface::before{content:'';position:absolute;inset:0;z-index:99;pointer-events:none;
    background:radial-gradient(ellipse at 50% 50%,transparent 0%,transparent 50%,rgba(0,0,0,.15) 80%,rgba(0,0,0,.4) 100%)}
  #terminal-surface::after{content:'';position:absolute;inset:0;z-index:100;pointer-events:none;
    background:repeating-linear-gradient(0deg,transparent,transparent 2px,rgba(0,0,0,.08) 2px,rgba(0,0,0,.08) 3px)}
  #flicker-layer{position:absolute;inset:0;z-index:101;pointer-events:none;background:rgba(0,255,65,.008);animation:flicker .12s infinite}

  @keyframes flicker{0%{opacity:.28}5%{opacity:.35}10%{opacity:.24}15%{opacity:.91}20%{opacity:.18}25%{opacity:.84}30%{opacity:.66}40%{opacity:.27}50%{opacity:.96}55%{opacity:.09}65%{opacity:.72}75%{opacity:.37}85%{opacity:.7}100%{opacity:.28}}
  @keyframes boot-fade{from{opacity:0;transform:translateY(4px)}to{opacity:1;transform:translateY(0)}}
  @keyframes blink{0%,100%{opacity:1}50%{opacity:0}}
  @keyframes progress-pulse{0%,100%{box-shadow:0 0 4px rgba(0,255,65,.2)}50%{box-shadow:0 0 10px rgba(0,255,65,.5)}}
  @keyframes screen-tear{0%,100%{clip-path:inset(0)}10%{clip-path:inset(15% 0 60% 0);transform:translateX(-5px)}20%{clip-path:inset(40% 0 30% 0);transform:translateX(8px)}30%{clip-path:inset(70% 0 10% 0);transform:translateX(-3px)}40%{clip-path:inset(0);transform:none}}
  @keyframes sidebar-reveal{from{opacity:0;transform:translateX(20px)}to{opacity:1;transform:translateX(0)}}
  @keyframes taskbar-add{from{opacity:0;transform:translateX(10px);max-height:0}to{opacity:1;transform:translateX(0);max-height:30px}}

  #screensaver-overlay{position:fixed;inset:0;z-index:500;background:#000;display:none;cursor:none}
  #screensaver-overlay.active{display:block}
  #screensaver-canvas{width:100%;height:100%}
  #screensaver-text{position:absolute;bottom:30px;width:100%;text-align:center;font-family:'VT323',monospace;font-size:14px;color:rgba(0,255,65,0.3);letter-spacing:4px}

  /* ‚ïê‚ïê‚ïê WELCOME & BOOT ‚ïê‚ïê‚ïê */
  #welcome-screen{position:fixed;inset:0;background:#000;z-index:400;display:flex;align-items:center;justify-content:center;flex-direction:column;font-family:'VT323',monospace;color:var(--green);cursor:pointer;transition:opacity 1s}
  #welcome-screen.hidden{opacity:0;pointer-events:none}
  #welcome-art{font-size:10px;line-height:1.15;letter-spacing:1px;text-align:center;white-space:pre;text-shadow:0 0 8px rgba(0,255,65,.4),0 0 20px rgba(0,255,65,.15);margin-bottom:30px}
  #welcome-subtitle{font-family:'Share Tech Mono',monospace;font-size:13px;color:var(--green-dim);letter-spacing:4px;text-transform:uppercase;margin-bottom:40px;text-shadow:0 0 10px rgba(0,255,65,.3)}
  #welcome-prompt{font-family:'Share Tech Mono',monospace;font-size:14px;color:var(--green-dark);animation:blink 1.2s infinite;letter-spacing:2px}
  #welcome-tagline{font-family:'Share Tech Mono',monospace;font-size:11px;color:var(--green-ghost);margin-top:20px;max-width:400px;text-align:center;line-height:1.6}

  /* BOOT SCREEN */
  #boot-screen{position:fixed;inset:0;background:#000;z-index:300;display:flex;align-items:center;justify-content:center;flex-direction:column;font-family:'VT323',monospace;color:var(--green);transition:opacity .8s;opacity:0;pointer-events:none}
  #boot-screen.active{opacity:1;pointer-events:auto}
  #boot-screen.hidden{opacity:0;pointer-events:none}
  #boot-text{font-size:14px;text-align:left;max-width:550px;line-height:1.7}
  #boot-text .boot-line{opacity:0;animation:boot-fade .15s ease forwards}

  /* ‚ïê‚ïê‚ïê LAYOUT ‚ïê‚ïê‚ïê */
  #main-grid{width:100%;height:100%;display:grid;grid-template-columns:1fr 0px;transition:grid-template-columns .6s ease;padding:14px;gap:0}
  #main-grid.sidebar-open{grid-template-columns:1fr var(--sidebar-w);gap:12px}

  /* TERMINAL */
  #terminal{display:flex;flex-direction:column;min-width:0;overflow:hidden;color:var(--green);position:relative}
  #header{border-bottom:1px solid var(--green-ghost);padding-bottom:8px;margin-bottom:8px;display:flex;justify-content:space-between;align-items:center;flex-shrink:0}
  #header .title{font-family:'VT323',monospace;font-size:22px;letter-spacing:2px;position:relative;
    text-shadow:0 0 5px rgba(0,255,65,.6),0 0 10px rgba(0,255,65,.3),0 0 20px rgba(0,255,65,.1)}
  #header .title::before,#header .title::after{content:attr(data-text);position:absolute;left:0;top:0;width:100%;height:100%}
  #header .title::before{color:var(--red);animation:screen-tear 4s infinite;opacity:.4;z-index:-1}
  #header .title::after{color:var(--cyan);animation:screen-tear 4s infinite reverse;opacity:.3;z-index:-1}
  #header .status{font-size:10px;color:var(--green-dark)}

  #terminal,#terminal *{text-shadow:0 0 4px rgba(0,255,65,.15),0 0 8px rgba(0,255,65,.06)}
  #header .title{text-shadow:0 0 5px rgba(0,255,65,.6),0 0 10px rgba(0,255,65,.3),0 0 20px rgba(0,255,65,.1)}
  #output .line{text-shadow:0.5px 0 rgba(255,0,64,.08),-0.5px 0 rgba(0,170,255,.08),0 0 4px rgba(0,255,65,.12)}

  #output{flex:1;overflow-y:auto;padding-right:8px;font-size:14px;line-height:1.55;scrollbar-width:thin;scrollbar-color:var(--green-ghost) transparent}
  #output::-webkit-scrollbar{width:3px}#output::-webkit-scrollbar-track{background:transparent}#output::-webkit-scrollbar-thumb{background:var(--green-ghost)}
  .line{animation:boot-fade .2s ease forwards;white-space:pre-wrap;word-break:break-all}
  .line.dim{color:var(--green-dark)}.line.ghost{color:var(--green-ghost);font-size:12px}.line.error{color:var(--red)}.line.warning{color:var(--amber)}.line.cyan{color:var(--cyan)}
  .line.system{color:var(--green-dim);font-style:italic}
  .ghost-text{color:var(--bg);cursor:default;transition:color .5s;font-size:11px}
  .ghost-text:hover{color:var(--green-ghost)}
  .ghost-text::selection{background:var(--green);color:#000}
  .track-entry{padding:4px 0;cursor:pointer;transition:all .15s}
  .track-entry:hover{padding-left:8px;color:#fff;text-shadow:0 0 6px rgba(255,255,255,.4)}
  .track-entry.playing{color:var(--amber);text-shadow:0 0 6px rgba(255,170,0,.4)}
  .track-entry.locked{color:var(--green-dark);cursor:not-allowed}
  .track-entry.locked:hover{padding-left:0;color:var(--red);text-shadow:0 0 6px rgba(255,0,64,.2)}

  #input-line{flex-shrink:0;display:flex;align-items:center;padding:12px 10px;border:1px solid var(--green-dark);border-radius:4px;margin-top:10px;background:rgba(0,255,65,0.03);box-shadow:0 0 8px rgba(0,255,65,0.1) inset}
  #prompt{font-size:16px;color:var(--green);margin-right:8px;white-space:nowrap;text-shadow:0 0 6px rgba(0,255,65,0.4)}
  #cmd-input{flex:1;background:transparent;border:none;outline:none;font-family:'Share Tech Mono',monospace;font-size:16px;color:var(--green);caret-color:var(--green)}
  #cmd-input::placeholder{color:rgba(0,255,65,0.35)}
  #input-line:focus-within{border-color:var(--green);box-shadow:0 0 12px rgba(0,255,65,0.2) inset,0 0 8px rgba(0,255,65,0.15)}

  /* ‚ïê‚ïê‚ïê SIDEBAR & TASKBAR ‚ïê‚ïê‚ïê */
  #sidebar{overflow:hidden;opacity:0;display:flex;flex-direction:column;border-left:1px solid var(--green-ghost);padding-left:12px;transition:opacity .4s ease;min-width:0}
  #main-grid.sidebar-open #sidebar{opacity:1;animation:sidebar-reveal .6s ease forwards}


  /* TASKBAR */
  #taskbar-label{font-family:'VT323',monospace;font-size:11px;color:var(--green-dark);letter-spacing:2px;margin-bottom:8px}
  #taskbar{display:flex;flex-direction:column;gap:2px;margin-bottom:8px}
  .taskbar-item{display:flex;align-items:center;gap:6px;padding:4px 6px;cursor:pointer;font-family:'Share Tech Mono',monospace;font-size:11px;color:var(--green-dark);transition:all .15s;border:1px solid transparent;border-radius:2px}
  .taskbar-item:hover{color:var(--green);padding-left:10px;border-color:var(--green-ghost)}
  .taskbar-item.active{color:var(--green);text-shadow:0 0 6px rgba(0,255,65,.4)}
  .taskbar-item .indicator{width:4px;height:4px;border-radius:50%;background:var(--green-ghost);flex-shrink:0}
  .taskbar-item.active .indicator{background:var(--green);box-shadow:0 0 4px var(--green)}
  .taskbar-item .tb-icon{font-size:12px}
  .sidebar-divider{border-top:1px solid var(--green-ghost);margin:8px 0}
  #sidebar-status{font-family:'VT323',monospace;font-size:11px;color:var(--green-dark);letter-spacing:1px}
  #sidebar-status div{padding:2px 0}
  #sidebar-tier{color:var(--green-dark)}
  #sidebar-secrets{color:var(--green-dark)}
  #sidebar-socials{margin-top:auto;padding-bottom:8px;font-family:'VT323',monospace}
  .social-link{
    display:block;padding:6px 8px;margin:3px 0;color:var(--green);text-decoration:none;
    font-family:'VT323',monospace;font-size:14px;letter-spacing:2px;
    background:rgba(0,255,65,0.06);border:1px solid var(--green-dark);
    transition:background .15s,border-color .15s,color .15s,box-shadow .15s;
  }
  .social-link:hover{background:rgba(0,255,65,0.18);border-color:var(--green);box-shadow:0 0 8px rgba(0,255,65,0.3)}
  .social-link::before{content:'[ ';color:var(--green-dim)}
  .social-link::after{content:' ]';color:var(--green-dim)}

  ::selection{background:var(--green);color:#000}

  @media(max-width:700px){
    :root{--sidebar-w:160px}
    #header .title{font-size:18px}#output{font-size:13px}
    #welcome-art{font-size:7px}
  }
  @media(max-width:500px){
    #main-grid.sidebar-open{grid-template-columns:1fr 0px;gap:0}
    #main-grid.sidebar-open #sidebar{opacity:0;pointer-events:none}
  }

  /* ‚ïê‚ïê‚ïê POPUP BASE STYLES ‚ïê‚ïê‚ïê */
  #donut-popup{
    position:fixed;
    right:20px;
    top:50%;
    margin-top:-150px;
    width:320px;
    background:rgba(0,20,10,0.98);
    border:2px solid var(--green);
    box-shadow:0 0 30px rgba(0,255,65,0.5),inset 0 0 20px rgba(0,0,0,0.8);
    z-index:9999;
    display:none;
    font-family:'VT323',monospace;
  }
  #donut-popup.show{display:block}
  .popup-titlebar{
    background:var(--green);
    color:#000;
    padding:4px 8px;
    display:flex;
    justify-content:space-between;
    align-items:center;
    font-size:14px;
    font-weight:bold;
    cursor:move;
    user-select:none;
  }
  .dragging{
    will-change:transform;
    pointer-events:none;
  }
  .dragging *{
    transition:none !important;
  }
  .popup-close{
    cursor:pointer;
    padding:0 6px;
    background:#000;
    color:var(--green);
    border:1px solid var(--green);
  }
  .popup-close:hover{background:var(--green);color:#000}
  .donut-content{
    padding:20px;
    text-align:center;
    color:var(--green);
    min-height:150px;
  }

  /* ‚ïê‚ïê‚ïê CALC.EXE ‚ïê‚ïê‚ïê */
  #calc-popup{
    position:fixed;
    right:300px;
    top:120px;
    width:220px;
    background:rgba(0,20,10,0.98);
    border:2px solid var(--green);
    box-shadow:0 0 30px rgba(0,255,65,0.5),inset 0 0 20px rgba(0,0,0,0.8);
    z-index:9997;
    display:none;
    font-family:'VT323',monospace;
  }
  #calc-popup.show{display:block;}
  #calc-display{
    background:#000;
    color:var(--green);
    padding:15px;
    font-size:24px;
    text-align:right;
    border:1px solid var(--green-dark);
    margin:10px;
    min-height:40px;
  }
  .calc-buttons{
    display:grid;
    grid-template-columns:repeat(4, 1fr);
    gap:5px;
    padding:10px;
  }
  .calc-btn{
    background:rgba(0,255,65,0.1);
    border:1px solid var(--green);
    color:var(--green);
    padding:15px;
    cursor:pointer;
    font-family:'VT323',monospace;
    font-size:18px;
  }
  .calc-btn:hover{background:var(--green);color:#000;}
  .calc-btn:active{background:var(--cyan);color:#000;}
  
  /* ‚ïê‚ïê‚ïê FILES.EXE ‚ïê‚ïê‚ïê */
  #files-popup{
    position:fixed;
    left:180px;
    top:90px;
    width:540px;
    background:rgba(0,20,10,0.98);
    border:2px solid var(--green);
    box-shadow:0 0 30px rgba(0,255,65,0.5),inset 0 0 20px rgba(0,0,0,0.8);
    z-index:9997;
    display:none;
    font-family:'VT323',monospace;
  }
  #files-popup.show{display:flex;flex-direction:column;}
  #files-address-bar{
    background:#000;
    border-bottom:1px solid var(--green-dark);
    padding:4px 8px;
    display:flex;
    align-items:center;
    gap:6px;
    font-size:13px;
  }
  #files-address-bar .addr-label{color:var(--green-dark);}
  #files-address-bar .addr-path{
    color:var(--green);
    flex:1;
    background:rgba(0,0,0,0.5);
    border:1px solid var(--green-dark);
    padding:2px 6px;
    font-size:14px;
  }
  #files-main{
    display:flex;
    min-height:300px;
    max-height:360px;
  }
  #files-tree{
    width:155px;
    min-width:155px;
    border-right:1px solid var(--green-dark);
    overflow-y:auto;
    background:rgba(0,0,0,0.3);
    padding:4px 0;
  }
  .tree-item{
    padding:2px 6px 2px 8px;
    cursor:pointer;
    color:var(--green-dim);
    font-size:13px;
    white-space:nowrap;
    display:flex;
    align-items:center;
    gap:4px;
  }
  .tree-item:hover{background:rgba(0,255,65,0.08);color:var(--green);}
  .tree-item.active{background:rgba(0,255,65,0.12);color:var(--green);}
  .tree-sub{padding-left:14px;}
  .tree-sub .tree-item{padding-left:4px;}
  .tree-sub .tree-sub .tree-item{padding-left:4px;}
  #files-panel{
    flex:1;
    display:flex;
    flex-direction:column;
    overflow:hidden;
  }
  #files-col-header{
    display:flex;
    align-items:center;
    padding:0 6px;
    border-bottom:1px solid var(--green-dark);
    background:rgba(0,255,65,0.03);
    font-size:12px;
    color:var(--green-dim);
    flex-shrink:0;
  }
  #files-col-header span{padding:2px 4px;border-right:1px solid var(--green-dark);}
  #files-col-header .col-name{flex:1;}
  #files-col-header .col-size{width:55px;text-align:right;}
  #files-col-header .col-type{width:70px;}
  #files-col-header .col-date{width:65px;border-right:none;}
  #files-list{
    flex:1;
    overflow-y:auto;
    background:#000;
  }
  .file-row{
    display:flex;
    align-items:center;
    padding:2px 6px;
    cursor:pointer;
    color:var(--green);
    font-size:14px;
  }
  .file-row:hover{background:rgba(0,255,65,0.08);}
  .file-row.selected{background:var(--green);color:#000;}
  .file-row .file-icon{width:20px;text-align:center;margin-right:4px;flex-shrink:0;}
  .file-row .file-name{flex:1;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;}
  .file-row .file-size{width:55px;text-align:right;color:var(--green-dim);font-size:13px;flex-shrink:0;}
  .file-row .file-type{width:70px;color:var(--green-dim);font-size:13px;flex-shrink:0;}
  .file-row .file-date{width:65px;color:var(--green-dim);font-size:13px;flex-shrink:0;}
  .file-row.locked{color:var(--green-dark);cursor:default;}
  .file-row.locked:hover{background:transparent;}
  #files-statusbar{
    background:rgba(0,255,65,0.03);
    border-top:1px solid var(--green-dark);
    padding:3px 8px;
    font-size:12px;
    color:var(--green-dark);
    display:flex;
    justify-content:space-between;
    flex-shrink:0;
  }

  /* ‚ïê‚ïê‚ïê NOTEPAD.EXE ‚ïê‚ïê‚ïê */
  #notepad-popup,.notepad-instance{
    position:fixed;
    left:300px;
    top:150px;
    width:400px;
    background:rgba(0,20,10,0.98);
    border:2px solid var(--green);
    box-shadow:0 0 30px rgba(0,255,65,0.5),inset 0 0 20px rgba(0,0,0,0.8);
    z-index:9996;
    display:none;
    font-family:'VT323',monospace;
  }
  #notepad-popup.show,.notepad-instance.show{display:block;}
  #notepad-textarea,.notepad-content{
    width:100%;
    height:300px;
    background:#000;
    color:var(--green);
    border:1px solid var(--green-dark);
    padding:10px;
    font-family:'VT323',monospace;
    font-size:14px;
    box-sizing:border-box;
    overflow-y:auto;
    white-space:pre-wrap;
    word-wrap:break-word;
    line-height:1.5;
  }
  #notepad-textarea .file-heading,.notepad-content .file-heading{color:var(--amber);font-size:16px;margin-bottom:8px;display:block;}
  #notepad-textarea .file-warn,.notepad-content .file-warn{color:var(--amber);}
  #notepad-textarea .file-error,.notepad-content .file-error{color:var(--red);}
  #notepad-textarea .file-ghost,.notepad-content .file-ghost{color:var(--green-dark);font-style:italic;}
  #notepad-textarea .file-dim,.notepad-content .file-dim{color:var(--green-dim);}
  #notepad-textarea:empty:before{
    content:'Type your notes here...';
    color:var(--green-dark);
  }
  
  /* ‚ïê‚ïê‚ïê MATRIX.EXE ‚ïê‚ïê‚ïê */
  #matrix-popup{
    position:fixed;
    right:50px;
    top:300px;
    width:300px;
    height:350px;
    background:rgba(0,0,0,0.95);
    border:2px solid var(--green);
    box-shadow:0 0 30px rgba(0,255,65,0.5);
    z-index:9995;
    display:none;
    font-family:'VT323',monospace;
    overflow:hidden;
  }
  #matrix-popup.show{display:block;}
  #matrix-canvas{
    width:100%;
    height:100%;
    display:block;
  }

  /* ‚ïê‚ïê‚ïê TRON.EXE ‚ïê‚ïê‚ïê */
  #tron-popup{
    position:fixed;
    left:350px;
    top:180px;
    width:420px;
    background:rgba(0,5,20,0.98);
    border:2px solid #00ffff;
    box-shadow:0 0 30px rgba(0,255,255,0.4),inset 0 0 20px rgba(0,0,0,0.8);
    z-index:9994;
    display:none;
    font-family:'VT323',monospace;
  }
  #tron-popup.show{display:block;}
  #tron-popup .popup-titlebar{
    background:rgba(0,255,255,0.15);
    border-bottom:1px solid #00ffff;
    color:#00ffff;
  }
  #tron-canvas{
    display:block;
    background:#0a0a2e;
    border:2px solid rgba(0,255,255,0.3);
    margin:10px;
  }
  #tron-info{
    display:flex;
    justify-content:space-between;
    padding:0 20px 10px 20px;
    color:#00ffff;
    font-size:16px;
  }
  #tron-controls{
    padding:0 20px 10px 20px;
    color:rgba(0,255,255,0.5);
    font-size:12px;
    text-align:center;
  }
  .tron-game-over{
    position:absolute;
    top:50%;
    left:50%;
    transform:translate(-50%, -50%);
    background:rgba(0,0,0,0.9);
    border:2px solid #00ffff;
    padding:20px;
    color:#00ffff;
    font-size:20px;
    text-align:center;
    display:none;
  }
  .tron-game-over.show{display:block;}

  /* ‚ïê‚ïê‚ïê PINCODE.EXE ‚ïê‚ïê‚ïê */
  #pincode-popup{
    position:fixed;
    right:100px;
    top:50%;
    transform:translateY(-50%);
    width:280px;
    background:rgba(0,20,10,0.98);
    border:2px solid var(--green);
    box-shadow:0 0 30px rgba(0,255,65,0.5),inset 0 0 20px rgba(0,0,0,0.8);
    z-index:9993;
    display:none;
    font-family:'VT323',monospace;
  }
  #pincode-popup.show{display:block;}
  #pin-display{
    background:#000;
    color:var(--green);
    padding:20px;
    font-size:32px;
    text-align:center;
    border:2px solid var(--green-dark);
    margin:15px;
    min-height:50px;
    letter-spacing:8px;
    font-weight:bold;
  }
  #pin-display.error{
    animation:shake-pin 0.3s;
    border-color:var(--red);
    color:var(--red);
  }
  #pin-display.success{
    border-color:var(--cyan);
    color:var(--cyan);
    animation:pulse-pin 0.5s;
  }
  @keyframes shake-pin{
    0%, 100%{transform:translateX(0);}
    25%{transform:translateX(-10px);}
    75%{transform:translateX(10px);}
  }
  @keyframes pulse-pin{
    0%, 100%{box-shadow:0 0 5px var(--cyan);}
    50%{box-shadow:0 0 20px var(--cyan);}
  }
  .pin-keypad{
    display:grid;
    grid-template-columns:repeat(3, 1fr);
    gap:8px;
    padding:15px;
  }
  .pin-btn{
    background:rgba(0,255,65,0.1);
    border:2px solid var(--green);
    color:var(--green);
    padding:20px;
    cursor:pointer;
    font-family:'VT323',monospace;
    font-size:24px;
    font-weight:bold;
  }
  .pin-btn:hover{background:var(--green);color:#000;}
  .pin-btn:active{background:var(--cyan);color:#000;}
  .pin-btn.wide{grid-column:span 2;}

  /* ‚ïê‚ïê‚ïê SIDEBAR BUTTONS ‚ïê‚ïê‚ïê */
  #music-fab,#gallery-fab{
    width:100%;
    height:44px;
    background:rgba(0,20,10,0.95);
    border:2px solid var(--green);
    border-radius:6px;
    color:var(--green);
    font-size:20px;
    display:flex;
    align-items:center;
    justify-content:center;
    cursor:pointer;
    box-shadow:0 0 10px rgba(0,255,65,0.3);
    transition:all .2s ease;
    user-select:none;
    margin-bottom:4px;
  }
  #music-fab:hover,#gallery-fab:hover{
    box-shadow:0 0 18px rgba(0,255,65,0.6);
    border-color:#4f4;
    background:rgba(0,255,65,0.08);
  }
  #music-fab.playing{
    animation:fab-pulse 2s ease-in-out infinite;
  }
  @keyframes fab-pulse{
    0%,100%{box-shadow:0 0 10px rgba(0,255,65,0.3);border-color:var(--green);}
    50%{box-shadow:0 0 20px rgba(0,255,65,0.7);border-color:#4f4;}
  }

  /* ‚ïê‚ïê‚ïê DECODE.EXE ‚ïê‚ïê‚ïê */
  #decode-popup{
    position:fixed;
    left:50%;top:50%;
    transform:translate(-50%,-50%);
    width:480px;
    background:rgba(0,20,10,0.98);
    border:2px solid var(--green);
    box-shadow:0 0 30px rgba(0,255,65,0.3),inset 0 0 20px rgba(0,0,0,0.8);
    z-index:9993;
    display:none;
    font-family:'VT323',monospace;
  }
  #decode-popup.show{display:block;}
  .decode-signal-list{padding:10px 15px;}
  .decode-signal-item{
    padding:8px 10px;margin-bottom:6px;
    border:1px solid var(--green-dark);
    background:rgba(0,255,65,0.05);
    cursor:pointer;
    display:flex;justify-content:space-between;align-items:center;
    transition:background 0.2s,border-color 0.2s;
  }
  .decode-signal-item:hover{background:rgba(0,255,65,0.12);border-color:var(--green);}
  .decode-signal-item.completed{border-color:var(--cyan);opacity:0.5;cursor:default;pointer-events:none;}
  .decode-signal-item .sig-name{color:var(--green);font-size:16px;}
  .decode-signal-item .sig-freq{color:var(--green-dim);font-size:13px;}
  .decode-signal-item .sig-status{font-size:12px;}
  .decode-game{padding:10px 15px;display:none;}
  .decode-game.active{display:block;}
  .decode-header{
    display:flex;justify-content:space-between;align-items:center;
    margin-bottom:10px;padding:6px 0;
    border-bottom:1px solid var(--green-dark);
  }
  .decode-header .signal-label{color:var(--amber);font-size:16px;}
  .decode-header .match-pct{color:var(--green);font-size:18px;}
  .decode-back-btn{
    background:none;border:1px solid var(--green-dark);
    color:var(--green-dim);padding:3px 8px;cursor:pointer;
    font-family:'VT323',monospace;font-size:13px;
  }
  .decode-back-btn:hover{border-color:var(--green);color:var(--green);}
  .decode-waveform{
    display:flex;gap:4px;justify-content:center;
    align-items:flex-end;height:140px;
    padding:10px 5px;
    background:rgba(0,0,0,0.5);
    border:1px solid var(--green-dark);
    position:relative;
  }
  .decode-bar-col{
    flex:1;height:100%;display:flex;flex-direction:column;
    justify-content:flex-end;align-items:center;
    position:relative;cursor:pointer;
  }
  .decode-bar-target{
    position:absolute;bottom:0;width:100%;
    background:rgba(0,255,65,0.08);
    border-top:2px dashed rgba(0,255,65,0.25);
    transition:height 0.3s;
    pointer-events:none;
  }
  .decode-bar-input{
    width:100%;
    background:var(--green);
    opacity:0.7;
    transition:height 0.15s ease-out;
    min-height:2px;
    box-shadow:0 0 6px rgba(0,255,65,0.4);
  }
  .decode-bar-input.matched{
    opacity:1;
    background:var(--cyan);
    box-shadow:0 0 10px rgba(0,170,255,0.6);
  }
  .decode-corruption{
    height:4px;margin:8px 0;
    background:rgba(255,0,64,0.15);
    border:1px solid rgba(255,0,64,0.3);
    position:relative;overflow:hidden;
  }
  .decode-corruption-fill{
    position:absolute;left:0;top:0;bottom:0;
    width:0%;
    background:linear-gradient(90deg,var(--red),var(--amber));
    transition:width 0.5s linear;
  }
  .decode-status{
    text-align:center;padding:6px;
    color:var(--green-dim);font-size:13px;
    min-height:22px;
  }
  .decode-override{
    display:flex;align-items:center;gap:6px;
    padding:6px 15px 12px;
    border-top:1px solid var(--green-dark);
    margin-top:6px;
  }
  .decode-override label{color:var(--green-dark);font-size:11px;white-space:nowrap;}
  .decode-override input{
    flex:1;background:rgba(0,0,0,0.6);border:1px solid var(--green-dark);
    color:var(--green);font-family:'VT323',monospace;font-size:13px;
    padding:3px 6px;outline:none;
  }
  .decode-override input:focus{border-color:var(--green);}
  @keyframes decode-success{
    0%{box-shadow:0 0 30px rgba(0,255,65,0.3);}
    50%{box-shadow:0 0 60px rgba(0,170,255,0.8),0 0 100px rgba(0,170,255,0.3);}
    100%{box-shadow:0 0 30px rgba(0,255,65,0.3);}
  }
  .decode-success-flash{animation:decode-success 1s ease-out;}

  /* ‚ïê‚ïê‚ïê POOL.EXE ‚ïê‚ïê‚ïê */
  #pool-popup{
    position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);width:660px;
    background:rgba(0,20,10,0.98);border:2px solid var(--green);
    box-shadow:0 0 30px rgba(0,255,65,0.5),inset 0 0 20px rgba(0,0,0,0.8);
    z-index:9994;display:none;font-family:'VT323',monospace;
  }
  #pool-popup.show{display:block}
  #pool-popup .popup-titlebar{background:rgba(0,80,30,0.6);border-bottom:1px solid var(--green);color:var(--green)}
  #pool-canvas{display:block;width:100%;cursor:crosshair}
  .pool-hud{display:flex;justify-content:space-between;align-items:center;padding:6px 10px;font-size:13px;color:var(--green-dark)}
  .pool-turn{color:var(--green);font-size:14px}
  .pool-pocketed{display:flex;gap:3px;align-items:center}
  .pool-ball-icon{width:12px;height:12px;border-radius:50%;display:inline-block;border:1px solid rgba(255,255,255,0.3)}
  .pool-msg{text-align:center;padding:4px;font-size:13px;color:var(--amber);min-height:18px}
  .pool-game-over{position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);background:rgba(0,0,0,0.9);border:2px solid var(--green);padding:25px 40px;color:var(--green);font-size:22px;text-align:center;display:none;z-index:10}
  .pool-game-over.show{display:block}

  /* ‚ïê‚ïê‚ïê PLAYER.EXE ‚ïê‚ïê‚ïê */
  #player-popup{
    position:fixed;
    left:50%;
    top:50%;
    transform:translate(-50%,-50%);
    width:420px;
    max-height:85vh;
    overflow-y:auto;
    background:rgba(0,20,10,0.98);
    border:2px solid var(--green);
    box-shadow:0 0 30px rgba(0,255,65,0.5),inset 0 0 20px rgba(0,0,0,0.8);
    z-index:9992;
    display:none;
    font-family:'VT323',monospace;
  }
  #player-popup.show{display:block;}
  .player-track-entry:hover{background:rgba(0,255,65,0.15) !important;}
  .player-controls{display:flex;align-items:center;gap:8px;margin-top:12px}
  .player-controls button{
    background:rgba(0,255,65,0.08);border:1px solid var(--green-dark);color:var(--green);
    padding:10px 14px;cursor:pointer;font-family:'VT323',monospace;font-size:18px;
    transition:background .15s,border-color .15s;
  }
  .player-controls button:hover{background:rgba(0,255,65,0.2);border-color:var(--green)}
  .player-controls .play-main{
    flex:1;background:var(--green);color:#000;border:none;font-size:20px;padding:12px 20px;font-weight:bold;
  }
  .player-controls .play-main:hover{background:#33ff66}
  #player-progress-wrap{
    position:relative;width:100%;height:6px;background:rgba(0,255,65,0.1);
    border:1px solid var(--green-dark);margin-top:14px;cursor:pointer;
  }
  #player-progress-bar{height:100%;background:var(--green);width:0%;transition:width .3s linear}
  .player-vol-row{display:flex;align-items:center;gap:10px;margin-top:10px}
  .player-vol-row label{color:var(--green-dark);font-size:13px;min-width:32px}
  .player-vol-row input[type=range]{flex:1;-webkit-appearance:none;appearance:none;height:6px;background:rgba(0,255,65,0.15);border:1px solid var(--green-dark);outline:none;cursor:pointer}
  .player-vol-row input[type=range]::-webkit-slider-thumb{-webkit-appearance:none;width:14px;height:14px;background:var(--green);border:none;cursor:pointer}
  .player-vol-row input[type=range]::-moz-range-thumb{width:14px;height:14px;background:var(--green);border:none;cursor:pointer}
  .player-info-row{display:flex;justify-content:space-between;font-size:13px;color:var(--green-dark);margin-top:8px}
  
  /* ‚ïê‚ïê‚ïê SCANNER & RADAR ‚ïê‚ïê‚ïê */
  #scanner-popup{
    position:fixed;
    left:50px;
    top:100px;
    width:520px;
    background:rgba(0,20,10,0.98);
    border:2px solid var(--green);
    box-shadow:0 0 30px rgba(0,255,65,0.5),inset 0 0 20px rgba(0,0,0,0.8);
    z-index:9993;
    display:none;
    font-family:'VT323',monospace;
  }
  #scanner-popup.show{display:block;}

  #radar-popup{
    position:fixed;
    left:550px;
    top:100px;
    background:rgba(0,20,10,0.98);
    border:2px solid var(--green);
    box-shadow:0 0 30px rgba(0,255,65,0.5),inset 0 0 20px rgba(0,0,0,0.8);
    z-index:9992;
    display:none;
    font-family:'VT323',monospace;
  }
  #radar-popup.show{display:block;}

  /* ‚ïê‚ïê‚ïê EASTER EGGS ‚ïê‚ïê‚ïê */
  #jpark-overlay{
    position:fixed;
    top:0;
    left:0;
    width:100%;
    height:100%;
    background:rgba(0,0,0,0.95);
    display:none;
    justify-content:center;
    align-items:center;
    z-index:99999;
    animation:fadeIn 0.3s;
  }
  #jpark-overlay.show{display:flex;}
  #jpark-overlay.fadeout{animation:fadeOut 0.5s;}
  #jpark-overlay img{
    max-width:90%;
    max-height:90%;
    border:3px solid var(--red);
    box-shadow:0 0 50px rgba(255,65,65,0.8);
  }
  #jesus-overlay{
    position:fixed;
    top:0;left:0;width:100%;height:100%;
    background:rgba(0,0,0,0.95);
    display:none;
    justify-content:center;
    align-items:center;
    z-index:99999;
    animation:fadeIn 0.3s;
  }
  #jesus-overlay.show{display:flex;}
  #jesus-overlay.fadeout{animation:fadeOut 0.5s;}
  #jesus-overlay img{
    max-width:90%;
    max-height:90%;
    border:3px solid var(--amber);
    box-shadow:0 0 50px rgba(255,170,0,0.8);
  }
  @keyframes fadeIn{
    from{opacity:0;}
    to{opacity:1;}
  }
  @keyframes fadeOut{
    from{opacity:1;}
    to{opacity:0;}
  }

  #echoes-popup{
    position:fixed;
    left:550px;
    top:560px;
    background:rgba(0,20,10,0.98);
    border:2px solid var(--green);
    box-shadow:0 0 30px rgba(0,255,65,0.5),inset 0 0 20px rgba(0,0,0,0.8);
    z-index:9991;
    display:none;
    font-family:'VT323',monospace;
  }
  #echoes-popup.show{display:block;}
  #spectrum-canvas{image-rendering:pixelated;}
  #signal-indicator.active{
    border-color:var(--green);
    box-shadow:0 0 15px var(--green);
    animation:pulse 0.5s ease infinite;
  }
  @keyframes pulse{
    0%,100%{transform:scale(1);}
    50%{transform:scale(1.1);}
  }
  
  #player-volume{
    -webkit-appearance:none;
    background:rgba(0,255,65,0.2);
    height:4px;
    border-radius:2px;
    width:100%;
  }
  #player-volume::-webkit-slider-thumb{
    -webkit-appearance:none;
    width:12px;
    height:12px;
    background:var(--green);
    cursor:pointer;
    border-radius:50%;
  }

  /* ‚ïê‚ïê‚ïê GALLERY.EXE ‚ïê‚ïê‚ïê */
  #gallery-popup{
    position:fixed;
    left:100px;
    top:80px;
    width:600px;
    max-height:80vh;
    background:rgba(0,20,10,0.98);
    border:2px solid var(--green);
    box-shadow:0 0 30px rgba(0,255,65,0.5),inset 0 0 20px rgba(0,0,0,0.8);
    z-index:9990;
    display:none;
    font-family:'VT323',monospace;
    overflow:hidden;
  }
  #gallery-popup.show{display:block;}
  #gallery-grid{
    display:grid;
    grid-template-columns:repeat(3, 1fr);
    gap:10px;
    padding:15px;
    max-height:calc(80vh - 120px);
    overflow-y:auto;
  }
  .gallery-item{
    position:relative;
    aspect-ratio:1;
    background:#000;
    border:1px solid var(--green-dark);
    cursor:pointer;
    overflow:hidden;
  }
  .gallery-item img{
    width:100%;
    height:100%;
    object-fit:cover;
    filter:grayscale(1) brightness(0.8) contrast(1.2);
    transition:filter 0.3s;
  }
  .gallery-item:hover img{
    filter:grayscale(0.3) brightness(1) contrast(1.2);
  }
  .gallery-item:hover{
    border-color:var(--green);
    box-shadow:0 0 10px rgba(0,255,65,0.3);
  }

  .gallery-item.locked{
    background:repeating-linear-gradient(45deg, #000 0px, #000 10px, #001a00 10px, #001a00 20px);
    cursor:not-allowed;
  }
  .gallery-item.locked:hover{
    border-color:var(--red);
    box-shadow:0 0 10px rgba(255,0,0,0.3);
  }

  #gallery-lightbox{
    position:fixed;
    inset:0;
    background:rgba(0,0,0,0.95);
    z-index:10000;
    display:none;
    align-items:center;
    justify-content:center;
  }
  #gallery-lightbox.show{display:flex;}
  #gallery-lightbox img{
    max-width:90%;
    max-height:90vh;
    border:2px solid var(--green);
    box-shadow:0 0 50px rgba(0,255,65,0.5);
  }
  #gallery-lightbox-close{
    position:absolute;
    top:20px;
    right:20px;
    font-size:30px;
    color:var(--green);
    cursor:pointer;
    background:rgba(0,0,0,0.8);
    padding:10px 20px;
    border:2px solid var(--green);
  }
  #gallery-lightbox-close:hover{
    background:var(--green);
    color:#000;
  }

  #pin-hint{
    text-align:center;
    padding:10px;
    font-size:12px;
    color:var(--green-dark);
  }

  /* ‚ïê‚ïê‚ïê SNAKE.EXE ‚ïê‚ïê‚ïê */
  #snake-popup{
    position:fixed;
    left:50%;
    top:50%;
    transform:translate(-50%, -50%);
    width:420px;
    background:rgba(0,20,10,0.98);
    border:2px solid var(--green);
    box-shadow:0 0 30px rgba(0,255,65,0.5),inset 0 0 20px rgba(0,0,0,0.8);
    z-index:9994;
    display:none;
    font-family:'VT323',monospace;
  }
  #snake-popup.show{display:block;}
  #snake-canvas{
    width:400px;
    height:400px;
    background:#000;
    border:1px solid var(--green-dark);
    display:block;
    margin:10px auto;
  }
  .snake-info{
    display:flex;
    justify-content:space-between;
    padding:0 10px 10px 10px;
    font-size:16px;
  }
  .snake-controls{
    padding:10px;
    text-align:center;
    font-size:14px;
    color:var(--green-dark);
  }
  #snake-start-btn{
    background:rgba(0,255,65,0.2);
    border:1px solid var(--green);
    color:var(--green);
    padding:8px 20px;
    cursor:pointer;
    font-family:'VT323',monospace;
    font-size:16px;
    margin-top:5px;
  }
  #snake-start-btn:hover{background:var(--green);color:#000;}

  /* TRON RESPONSIVE */
  #tron-popup{
    left:50%;
    top:50%;
    transform:translate(-50%, -50%);
  }
  #tron-canvas{
    width:400px;
    height:400px;
  }

  .window-can-interact{
    box-shadow:0 0 40px rgba(0,255,65,0.8),inset 0 0 20px rgba(0,0,0,0.8) !important;
    border-color:var(--cyan) !important;
  }

  /* ‚ïê‚ïê‚ïê SYNTH.EXE ‚ïê‚ïê‚ïê */
  #synth-popup{
    position:fixed;left:50%;top:50%;transform:translate(-50%,-50%);
    width:540px;max-height:90vh;overflow-y:auto;
    background:rgba(0,20,10,0.98);border:2px solid var(--green);
    box-shadow:0 0 30px rgba(0,255,65,0.5),inset 0 0 20px rgba(0,0,0,0.8);
    z-index:9991;display:none;font-family:'VT323',monospace;
  }
  #synth-popup.show{display:block}
  .synth-wave-btn{
    flex:1;background:rgba(0,255,65,0.1);border:1px solid var(--green-dark);
    color:var(--green-dark);padding:8px;cursor:pointer;
    font-family:'VT323',monospace;font-size:14px;transition:all .15s;
  }
  .synth-wave-btn:hover{background:rgba(0,255,65,0.2);color:var(--green)}
  .synth-wave-btn.active{background:var(--green);color:#000;border-color:var(--green);box-shadow:0 0 8px rgba(0,255,65,0.4)}
  #synth-keyboard{position:relative;height:110px;background:#000;border:2px solid var(--green-dark);margin-bottom:12px}
  .synth-key{
    position:absolute;cursor:pointer;user-select:none;transition:background .05s;
    display:flex;align-items:flex-end;justify-content:center;padding-bottom:4px;
    font-size:9px;font-family:'VT323',monospace;box-sizing:border-box;
  }
  .synth-key.white{
    background:rgba(0,255,65,0.08);border:1px solid var(--green-dark);
    color:var(--green-dark);height:100%;bottom:0;
  }
  .synth-key.black{
    background:rgba(0,20,10,0.95);border:1px solid var(--green);
    color:var(--green);height:58%;top:0;z-index:2;
  }
  .synth-key.white:hover{background:rgba(0,255,65,0.25)}
  .synth-key.black:hover{background:rgba(0,255,65,0.15)}
  .synth-key.active{background:var(--green) !important;color:#000 !important;box-shadow:0 0 10px var(--green)}
  .synth-section{border-top:1px solid var(--green-dark);padding-top:10px;margin-bottom:10px}
  .synth-section-label{color:var(--green-dark);font-size:10px;margin-bottom:6px;font-family:monospace}
  .synth-step{
    background:rgba(0,255,65,0.05);border:1px solid var(--green-dark);
    height:38px;cursor:pointer;display:flex;flex-direction:column;
    align-items:center;justify-content:center;font-size:8px;
    color:var(--green-dark);transition:all .1s;position:relative;
  }
  .synth-step:hover{background:rgba(0,255,65,0.15)}
  .synth-step.has-note{background:rgba(0,255,65,0.25);border-color:var(--green);color:var(--green)}
  .synth-step.playing{background:var(--amber);border-color:var(--amber);box-shadow:0 0 8px rgba(255,170,0,0.6);color:#000}
  .synth-btn{
    background:rgba(0,255,65,0.1);border:1px solid var(--green);color:var(--green);
    padding:4px 10px;cursor:pointer;font-family:'VT323',monospace;font-size:12px;
    transition:all .15s;
  }
  .synth-btn:hover{background:rgba(0,255,65,0.25)}
  .synth-btn.rec{border-color:var(--red);color:var(--red);background:rgba(255,0,64,0.15)}
  .synth-btn.rec.active{background:rgba(255,0,64,0.5);color:#fff}
  .synth-btn.stop-active{background:var(--green);color:#000}
  #synth-popup input[type="range"]{
    -webkit-appearance:none;appearance:none;background:rgba(0,255,65,0.1);
    height:4px;border-radius:2px;outline:none;width:100%;
  }
  #synth-popup input[type="range"]::-webkit-slider-thumb{
    -webkit-appearance:none;appearance:none;width:12px;height:12px;
    background:var(--green);border-radius:50%;cursor:pointer;
    box-shadow:0 0 4px rgba(0,255,65,0.6);
  }
  #synth-popup input[type="range"]::-moz-range-thumb{
    width:12px;height:12px;background:var(--green);border-radius:50%;
    cursor:pointer;border:none;box-shadow:0 0 4px rgba(0,255,65,0.6);
  }

  /* ‚ïê‚ïê‚ïê DRUMS.EXE ‚ïê‚ïê‚ïê */
  #drums-popup{
    position:fixed;left:50%;top:50%;transform:translate(-50%,-50%);
    width:640px;max-height:90vh;overflow-y:auto;
    background:rgba(0,20,10,0.98);border:2px solid var(--green);
    box-shadow:0 0 30px rgba(0,255,65,0.5),inset 0 0 20px rgba(0,0,0,0.8);
    z-index:9990;display:none;font-family:'VT323',monospace;
  }
  #drums-popup.show{display:block}
  #drums-pads{display:grid;grid-template-columns:repeat(4,1fr);gap:6px;margin-bottom:14px}
  .drum-pad{
    background:rgba(0,255,65,0.08);border:2px solid var(--green-dark);
    color:var(--green);padding:14px 4px;text-align:center;cursor:pointer;
    font-family:'VT323',monospace;font-size:13px;user-select:none;
    transition:all .05s;
  }
  .drum-pad:hover{background:rgba(0,255,65,0.2);border-color:var(--green)}
  .drum-pad.hit{background:var(--green) !important;color:#000 !important;box-shadow:0 0 12px var(--green)}
  @keyframes drum-flash{0%{background:var(--green)}100%{background:rgba(0,255,65,0.08)}}
  .drum-grid-row{display:flex;gap:2px;margin-bottom:2px;align-items:center}
  .drum-row-label{
    width:40px;min-width:40px;font-size:9px;color:var(--green-dark);
    text-align:right;padding-right:4px;
  }
  .drum-cell{
    flex:1;height:24px;background:rgba(0,255,65,0.03);border:1px solid rgba(0,255,65,0.15);
    cursor:pointer;transition:all .08s;
  }
  .drum-cell:hover{background:rgba(0,255,65,0.12)}
  .drum-cell.on{background:rgba(0,255,65,0.35);border-color:var(--green)}
  .drum-cell.playing{border-color:var(--amber);box-shadow:0 0 4px rgba(255,170,0,0.4)}
  .drum-cell.on.playing{background:var(--amber);border-color:var(--amber);box-shadow:0 0 8px rgba(255,170,0,0.6)}
  #drums-popup input[type="range"]{
    -webkit-appearance:none;appearance:none;background:rgba(0,255,65,0.1);
    height:4px;border-radius:2px;outline:none;width:100%;
  }
  #drums-popup input[type="range"]::-webkit-slider-thumb{
    -webkit-appearance:none;appearance:none;width:12px;height:12px;
    background:var(--green);border-radius:50%;cursor:pointer;
    box-shadow:0 0 4px rgba(0,255,65,0.6);
  }
  #drums-popup input[type="range"]::-moz-range-thumb{
    width:12px;height:12px;background:var(--green);border-radius:50%;
    cursor:pointer;border:none;box-shadow:0 0 4px rgba(0,255,65,0.6);
  }
</style>
</head>
<body>

<!-- ‚ïê‚ïê‚ïê WELCOME & BOOT ‚ïê‚ïê‚ïê -->
<div id="welcome-screen">
  <div id="welcome-art"></div>
  <div id="welcome-subtitle">‚ñì‚ñì‚ñì TRANSMISSION IN PROGRESS ‚ñì‚ñì‚ñì</div>
  <div id="welcome-prompt">[ PRESS ANY KEY TO TUNE IN ]</div>
  <div id="welcome-tagline">You have intercepted an unauthorized broadcast.<br>Contents: 7 audio files. Some encrypted.<br>No one knows you're listening.</div>
</div>

<div id="boot-screen"><div id="boot-text"></div></div>
<div id="screensaver-overlay"><canvas id="screensaver-canvas"></canvas><div id="screensaver-text">PRESS ANY KEY</div></div>

<!-- ‚ïê‚ïê‚ïê STAGE & TERMINAL ‚ïê‚ïê‚ïê -->
<div id="stage">
  <div id="bg-env"></div>
  <div id="server-room">
    <div class="bg-monitor" style="width:80px;height:60px;top:20%;left:15%;"></div>
    <div class="bg-monitor" style="width:100px;height:75px;top:45%;left:10%;"></div>
    <div class="bg-monitor" style="width:90px;height:68px;top:25%;right:12%;"></div>
    <div class="bg-monitor" style="width:85px;height:64px;top:50%;right:8%;"></div>
    <div class="bg-monitor" style="width:70px;height:52px;top:65%;left:20%;"></div>
    <div class="bg-monitor" style="width:75px;height:56px;top:68%;right:18%;"></div>
  </div>
  <div id="crt-bezel"></div>
  <div id="terminal-surface">
    <div id="flicker-layer"></div>
    <div id="main-grid">
      <div id="terminal">
        <div id="header">
          <div class="title" data-text="‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë://‚ñà‚ñà‚ñà">‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë://‚ñà‚ñà‚ñà</div>
          <div class="status"><span id="clock">00:00:00</span> ‚îÇ <span id="session-id">SES-0000</span> ‚îÇ <span id="conn-status">‚ñ†</span></div>
        </div>
        <div id="output"></div>
        <div id="input-line">
          <span id="prompt">$&gt;</span>
          <input type="text" id="cmd-input" autocomplete="off" spellcheck="false" placeholder="Type a command... (try 'help')">
        </div>
      </div>
      
<!-- ‚ïê‚ïê‚ïê CALC.EXE ‚ïê‚ïê‚ïê -->
<!-- ‚ïê‚ïê‚ïê FILES.EXE ‚ïê‚ïê‚ïê -->
<div id="files-popup">
  <div class="popup-titlebar">
    <span>üìÇ FILES.EXE</span>
    <span class="popup-close" onclick="document.getElementById('files-popup').classList.remove('show')">‚úï</span>
  </div>
  <div id="files-address-bar">
    <span class="addr-label">Address</span>
    <span class="addr-path" id="files-addr-path">C:\RCPLAYER\</span>
  </div>
  <div id="files-main">
    <div id="files-tree"></div>
    <div id="files-panel">
      <div id="files-col-header">
        <span class="col-name">Name</span>
        <span class="col-size">Size</span>
        <span class="col-type">Type</span>
        <span class="col-date">Modified</span>
      </div>
      <div id="files-list"></div>
    </div>
  </div>
  <div id="files-statusbar">
    <span id="files-status-left">Ready</span>
    <span id="files-status-right"></span>
  </div>
</div>

<div id="calc-popup">
  <div class="popup-titlebar">
    <span>üßÆ CALC.EXE</span>
    <span class="popup-close" onclick="document.getElementById('calc-popup').classList.remove('show')">‚úï</span>
  </div>
  <div style="padding:10px;">
    <div id="calc-display">0</div>
    <div class="calc-buttons">
      <button class="calc-btn" onclick="calcPress('7')">7</button>
      <button class="calc-btn" onclick="calcPress('8')">8</button>
      <button class="calc-btn" onclick="calcPress('9')">9</button>
      <button class="calc-btn" onclick="calcPress('/')">/</button>
      <button class="calc-btn" onclick="calcPress('4')">4</button>
      <button class="calc-btn" onclick="calcPress('5')">5</button>
      <button class="calc-btn" onclick="calcPress('6')">6</button>
      <button class="calc-btn" onclick="calcPress('*')">*</button>
      <button class="calc-btn" onclick="calcPress('1')">1</button>
      <button class="calc-btn" onclick="calcPress('2')">2</button>
      <button class="calc-btn" onclick="calcPress('3')">3</button>
      <button class="calc-btn" onclick="calcPress('-')">-</button>
      <button class="calc-btn" onclick="calcPress('0')">0</button>
      <button class="calc-btn" onclick="calcPress('.')">.</button>
      <button class="calc-btn" onclick="calcEqual()">=</button>
      <button class="calc-btn" onclick="calcPress('+')">+</button>
    </div>
    <button class="calc-btn" onclick="calcClear()" style="width:calc(100% - 10px);margin:5px">C</button>
  </div>
</div>

<!-- ‚ïê‚ïê‚ïê NOTEPAD.EXE ‚ïê‚ïê‚ïê -->
<div id="notepad-popup">
  <div class="popup-titlebar">
    <span>üìù NOTEPAD.EXE</span>
    <span class="popup-close" onclick="document.getElementById('notepad-popup').classList.remove('show')">‚úï</span>
  </div>
  <div style="padding:10px;">
    <div id="notepad-textarea" contenteditable="true" style="outline:none;" spellcheck="false">Type your notes here...</div>
  </div>
</div>

<!-- ‚ïê‚ïê‚ïê MATRIX.EXE ‚ïê‚ïê‚ïê -->
<div id="matrix-popup">
  <div class="popup-titlebar">
    <span>üü¢ MATRIX.EXE</span>
    <span class="popup-close" onclick="document.getElementById('matrix-popup').classList.remove('show');stopMatrix()">‚úï</span>
  </div>
  <canvas id="matrix-canvas"></canvas>
</div>


<!-- ‚ïê‚ïê‚ïê SNAKE.EXE ‚ïê‚ïê‚ïê -->
<div id="snake-popup">
  <div class="popup-titlebar">
    <span>üêç SNAKE.EXE</span>
    <span class="popup-close" onclick="document.getElementById('snake-popup').classList.remove('show');stopSnake()">‚úï</span>
  </div>
  <div id="snake-info">
    <div>SCORE: <span id="snake-score">0</span></div>
    <div>HIGH: <span id="snake-highscore">0</span></div>
  </div>
  <div style="position:relative;">
    <canvas id="snake-canvas" width="400" height="400"></canvas>
    <div class="snake-game-over" id="snake-game-over">
      <div>GAME OVER</div>
      <div style="font-size:14px;margin:10px 0;color:var(--green);">Score: <span id="snake-final-score">0</span></div>
      <button onclick="startSnake()" style="background:var(--green);color:#000;border:none;padding:8px 20px;cursor:pointer;font-family:'VT323',monospace;font-size:14px;">PLAY AGAIN</button>
    </div>
  </div>
  <div id="snake-controls">Use ARROW KEYS or WASD to move ‚Ä¢ Press SPACE to start</div>
</div>

<!-- ‚ïê‚ïê‚ïê TRON.EXE ‚ïê‚ïê‚ïê -->
<div id="tron-popup">
  <div class="popup-titlebar">
    <span>‚ö° LIGHTCYCLE.EXE</span>
    <span class="popup-close" onclick="document.getElementById('tron-popup').classList.remove('show');stopTron()">‚úï</span>
  </div>
  <div id="tron-info">
    <div>WINS: <span id="tron-wins">0</span></div>
    <div id="tron-round-result"></div>
  </div>
  <div style="position:relative;">
    <canvas id="tron-canvas" width="400" height="400"></canvas>
    <div class="tron-game-over" id="tron-game-over">
      <div id="tron-game-over-text">DEREZZED</div>
      <div style="font-size:14px;margin:10px 0;color:#00ffff;">Wins: <span id="tron-final-wins">0</span></div>
      <button onclick="startTron()" style="background:#00ffff;color:#000;border:none;padding:8px 20px;cursor:pointer;font-family:'VT323',monospace;font-size:14px;">PLAY AGAIN</button>
    </div>
  </div>
  <div id="tron-controls">Use ARROW KEYS or WASD to turn ‚Ä¢ Press SPACE to start</div>
</div>

<!-- ‚ïê‚ïê‚ïê POOL.EXE ‚ïê‚ïê‚ïê -->
<div id="pool-popup">
  <div class="popup-titlebar">
    <span>üé± POOL.EXE</span>
    <span class="popup-close" onclick="closePool()">‚úï</span>
  </div>
  <div style="position:relative;padding:0 10px 0 10px;">
    <canvas id="pool-canvas" width="1280" height="680"></canvas>
    <div class="pool-game-over" id="pool-game-over">
      <div id="pool-game-over-text">YOU WIN</div>
      <div style="font-size:14px;margin:10px 0;color:var(--green-dim);" id="pool-game-over-sub"></div>
      <button onclick="Pool.resetGame()" style="background:var(--green);color:#000;border:none;padding:8px 20px;cursor:pointer;font-family:'VT323',monospace;font-size:14px;">PLAY AGAIN</button>
    </div>
  </div>
  <div class="pool-msg" id="pool-msg">Click and drag from the cue ball to shoot</div>
  <div class="pool-hud">
    <div><span>YOU (</span><span id="pool-p1-type">--</span><span>): </span><span class="pool-pocketed" id="pool-p1-pocketed"></span></div>
    <div class="pool-turn" id="pool-turn">YOUR SHOT</div>
    <div><span>BOT (</span><span id="pool-p2-type">--</span><span>): </span><span class="pool-pocketed" id="pool-p2-pocketed"></span></div>
  </div>
</div>

<!-- ‚ïê‚ïê‚ïê PINCODE.EXE ‚ïê‚ïê‚ïê -->
<div id="pincode-popup">
  <div class="popup-titlebar">
    <span>üîê SECURE.EXE</span>
    <span class="popup-close" onclick="document.getElementById('pincode-popup').classList.remove('show');resetPin()">‚úï</span>
  </div>
  <div id="pin-display">----</div>
  <div class="pin-keypad">
    <button class="pin-btn" onclick="pinPress(1)">1</button>
    <button class="pin-btn" onclick="pinPress(2)">2</button>
    <button class="pin-btn" onclick="pinPress(3)">3</button>
    <button class="pin-btn" onclick="pinPress(4)">4</button>
    <button class="pin-btn" onclick="pinPress(5)">5</button>
    <button class="pin-btn" onclick="pinPress(6)">6</button>
    <button class="pin-btn" onclick="pinPress(7)">7</button>
    <button class="pin-btn" onclick="pinPress(8)">8</button>
    <button class="pin-btn" onclick="pinPress(9)">9</button>
    <button class="pin-btn" onclick="pinClear()">CLR</button>
    <button class="pin-btn" onclick="pinPress(0)">0</button>
    <button class="pin-btn" onclick="pinSubmit()">OK</button>
  </div>
  <div id="pin-hint">Enter 4-digit code</div>
</div>


<!-- ‚ïê‚ïê‚ïê DECODE.EXE ‚ïê‚ïê‚ïê -->
<div id="decode-popup">
  <div class="popup-titlebar">
    <span>üîì DECODE.EXE</span>
    <span class="popup-close" onclick="closeDecode()">‚úï</span>
  </div>
  <div id="decode-list" class="decode-signal-list">
    <div style="color:var(--green-dim);font-size:13px;margin-bottom:8px;border-bottom:1px solid var(--green-dark);padding-bottom:6px;">
      ENCRYPTED SIGNALS ‚Äî select to decrypt
    </div>
    <div id="decode-signals"></div>
    <div id="decode-empty" style="color:var(--green-dark);font-size:13px;padding:20px;text-align:center;">
      No locked signals available.<br>
      <span style="font-size:11px;">Use SCANNER.EXE to find and lock signals first.</span>
    </div>
  </div>
  <div id="decode-game" class="decode-game">
    <div class="decode-header">
      <button class="decode-back-btn" onclick="decodeShowList()">‚óÑ BACK</button>
      <span id="decode-signal-label" class="signal-label"></span>
      <span id="decode-match" class="match-pct">0%</span>
    </div>
    <div style="color:var(--green-dim);font-size:11px;text-align:center;margin-bottom:6px;">
      CLICK BARS TO MATCH TARGET PATTERN
    </div>
    <div id="decode-waveform" class="decode-waveform"></div>
    <div class="decode-corruption">
      <div id="decode-corruption-fill" class="decode-corruption-fill"></div>
    </div>
    <div id="decode-status" class="decode-status"></div>
  </div>
  <div class="decode-override">
    <label>OVERRIDE://</label>
    <input type="text" id="decode-override-input" maxlength="20" placeholder="master key" onkeydown="if(event.key==='Enter')decodeOverride()">
  </div>
</div>

<!-- ‚ïê‚ïê‚ïê PLAYER.EXE ‚ïê‚ïê‚ïê -->
<div id="player-popup">
  <div class="popup-titlebar">
    <span>üéµ PLAYER.EXE</span>
    <span class="popup-close" onclick="document.getElementById('player-popup').classList.remove('show');stopTrack()">‚úï</span>
  </div>
  <div style="padding:15px;">
    <div style="margin-bottom:12px;color:var(--green);font-size:16px;font-weight:bold;letter-spacing:2px;">REDACTED CLUB - EP</div>
    <div id="player-track-list"></div>
    <div style="margin-top:15px;padding-top:15px;border-top:1px solid var(--green-dark);">
      <div id="player-now-playing" style="color:var(--green);font-size:14px;margin-bottom:6px;">No track playing</div>
      <div id="player-progress-wrap" onclick="seekTrack(event)">
        <div id="player-progress-bar"></div>
      </div>
      <div class="player-info-row">
        <span id="player-time">0:00</span>
        <span id="player-duration">0:00</span>
      </div>
      <div class="player-controls">
        <button id="player-prev" title="Previous">‚óÑ‚óÑ</button>
        <button id="player-play" class="play-main" title="Play/Pause">‚ñ∂ PLAY</button>
        <button id="player-next" title="Next">‚ñ∫‚ñ∫</button>
      </div>
      <div class="player-vol-row">
        <label>VOL</label>
        <input type="range" id="player-volume" min="0" max="100" value="70">
        <span id="player-volume-display" style="color:var(--green);font-size:13px;min-width:30px;text-align:right;">70%</span>
      </div>
    </div>
  </div>
</div>

<!-- ‚ïê‚ïê‚ïê SCANNER & RADAR ‚ïê‚ïê‚ïê -->
<div id="radar-popup" class="donut-popup">
  <div class="popup-titlebar">
    <span>üì° RADAR.EXE</span>
    <span class="popup-close" onclick="document.getElementById('radar-popup').classList.remove('show')">‚úï</span>
  </div>
  <div style="padding:12px;">
    <div style="background:rgba(0,0,0,0.8);border:2px solid var(--green-dark);position:relative;aspect-ratio:1;max-width:400px;">
      <canvas id="radar-canvas" width="400" height="400" style="display:block;width:100%;"></canvas>
      <div style="position:absolute;top:5px;left:8px;font-size:10px;color:rgba(0,255,65,0.5);font-family:monospace;">SONAR</div>
      <div id="scanner-status" style="position:absolute;bottom:5px;left:8px;right:8px;color:var(--amber);font-size:10px;font-family:monospace;"></div>
    </div>
  </div>
</div>

<!-- SCANNER CONTROLS -->
<div id="scanner-popup" class="donut-popup">
  <div class="popup-titlebar">
    <span>üéõÔ∏è SCANNER.EXE</span>
    <span class="popup-close" onclick="document.getElementById('scanner-popup').classList.remove('show');stopScanner()">‚úï</span>
  </div>
  <div style="padding:15px;max-width:400px;">

    <!-- Control Knobs -->
    <div style="display:grid;grid-template-columns:1fr 1fr;gap:15px;margin-bottom:15px;">
      <!-- Frequency Knob -->
      <div style="text-align:center;">
        <div style="color:var(--green-dark);font-size:10px;margin-bottom:8px;font-family:monospace;">FREQUENCY</div>
        <div style="position:relative;width:90px;height:90px;margin:0 auto;background:radial-gradient(circle, #000 50%, #0a0a0a 100%);border:3px solid var(--green-dark);border-radius:50%;cursor:pointer;" id="frequency-knob-container" onmousedown="handleKnobClick(event, 'frequency')">
          <div id="frequency-indicator" style="position:absolute;top:10px;left:50%;width:3px;height:35px;background:var(--green);transform-origin:bottom;transform:translateX(-50%) rotate(180deg);box-shadow:0 0 5px var(--green);"></div>
          <div style="position:absolute;top:50%;left:50%;transform:translate(-50%, -50%);width:18px;height:18px;background:#000;border:2px solid var(--green);border-radius:50%;"></div>
        </div>
        <div id="frequency-value" style="color:var(--green);font-size:14px;margin-top:6px;font-family:monospace;">97.7 MHz</div>
        <input type="number" id="frequency-input" value="97.7" min="80" max="120" step="0.1" style="width:80px;margin-top:6px;background:#000;border:1px solid var(--green-dark);color:var(--green);padding:4px;font-family:monospace;font-size:12px;text-align:center;" onchange="setFrequencyFromInput()" onkeypress="if(event.key==='Enter') setFrequencyFromInput()">
      </div>

      <!-- Amplitude Knob -->
      <div style="text-align:center;">
        <div style="color:var(--green-dark);font-size:10px;margin-bottom:8px;font-family:monospace;">AMPLITUDE</div>
        <div style="position:relative;width:90px;height:90px;margin:0 auto;background:radial-gradient(circle, #000 50%, #0a0a0a 100%);border:3px solid var(--green-dark);border-radius:50%;cursor:pointer;" id="amplitude-knob-container" onmousedown="handleKnobClick(event, 'amplitude')">
          <div id="amplitude-indicator" style="position:absolute;top:10px;left:50%;width:3px;height:35px;background:var(--green);transform-origin:bottom;transform:translateX(-50%) rotate(180deg);box-shadow:0 0 5px var(--green);"></div>
          <div style="position:absolute;top:50%;left:50%;transform:translate(-50%, -50%);width:18px;height:18px;background:#000;border:2px solid var(--green);border-radius:50%;"></div>
        </div>
        <div id="amplitude-value" style="color:var(--green);font-size:14px;margin-top:6px;font-family:monospace;">50</div>
        <input type="number" id="amplitude-input" value="50" min="0" max="100" step="1" style="width:80px;margin-top:6px;background:#000;border:1px solid var(--green-dark);color:var(--green);padding:4px;font-family:monospace;font-size:12px;text-align:center;" onchange="setAmplitudeFromInput()" onkeypress="if(event.key==='Enter') setAmplitudeFromInput()">
      </div>
    </div>

    <!-- Spectrum Display -->
    <div style="background:rgba(0,0,0,0.5);border:1px solid var(--green-dark);padding:10px;position:relative;margin-bottom:15px;">
      <div style="color:var(--green-dark);font-size:10px;margin-bottom:8px;font-family:monospace;text-align:center;">SIGNAL CLARITY</div>
      <canvas id="noise-canvas" width="400" height="80" style="display:block;width:100%;border:1px solid rgba(0,255,65,0.2);"></canvas>
      <div style="display:flex;justify-content:space-between;margin-top:6px;font-size:10px;font-family:monospace;color:rgba(0,255,65,0.5);">
        <span>NOISY</span>
        <span id="signal-clarity-text">--</span>
        <span>CLEAR</span>
      </div>
    </div>

    <!-- Ping & Lock Controls -->
    <div style="display:grid;grid-template-columns:2fr 1fr;gap:8px;margin-bottom:12px;">
      <button id="ping-btn" onclick="sendPing()" style="background:var(--green);border:none;color:#000;padding:16px;cursor:pointer;font-family:'VT323',monospace;font-size:20px;font-weight:bold;box-shadow:0 0 10px rgba(0,255,65,0.3);">‚ñ∂ PING</button>
      <button id="lock-signal-btn" onclick="attemptLockSignal()" disabled style="background:rgba(0,255,65,0.1);border:1px solid var(--green-dark);color:var(--green-dark);padding:16px;cursor:not-allowed;font-family:'VT323',monospace;font-size:16px;">LOCK</button>
    </div>

    <!-- Window Toggle Controls -->
    <div style="display:grid;grid-template-columns:1fr 1fr;gap:8px;border-top:1px solid var(--green-dark);padding-top:12px;">
      <button id="radar-toggle-btn" onclick="toggleWindow('radar-popup')" style="background:rgba(0,0,0,0.5);border:1px solid rgba(255,65,65,0.5);color:rgba(255,65,65,0.5);padding:10px;cursor:not-allowed;font-family:'VT323',monospace;font-size:14px;">üîí RADAR</button>
      <button onclick="toggleWindow('echoes-popup')" style="background:rgba(0,255,65,0.1);border:1px solid var(--green-dark);color:var(--green);padding:10px;cursor:pointer;font-family:'VT323',monospace;font-size:14px;">üìã ECHOES</button>
    </div>

  </div>
</div>

<!-- ECHOES -->
<div id="echoes-popup" class="donut-popup">
  <div class="popup-titlebar">
    <span>üìã ECHOES.EXE</span>
    <span class="popup-close" onclick="document.getElementById('echoes-popup').classList.remove('show')">‚úï</span>
  </div>
  <div style="padding:15px;max-width:350px;">
    <div id="echoes-container" style="display:none;">
      <div style="color:var(--green);font-size:12px;margin-bottom:8px;font-family:monospace;">‚ñ∂ ECHOES DETECTED:</div>
      <div id="echoes-list" style="font-size:11px;font-family:monospace;max-height:400px;overflow-y:auto;"></div>
    </div>
    <div id="no-echoes-msg" style="color:var(--green-dark);font-size:12px;font-family:monospace;text-align:center;padding:20px;">
      No signals detected yet.<br>Send a PING to scan for echoes.
    </div>
  </div>
</div>


<!-- ‚ïê‚ïê‚ïê SYNTH.EXE ‚ïê‚ïê‚ïê -->
<div id="synth-popup">
  <div class="popup-titlebar">
    <span>üéπ SYNTH.EXE</span>
    <span class="popup-close" onclick="document.getElementById('synth-popup').classList.remove('show');stopSynth()">‚úï</span>
  </div>
  <div style="padding:12px;">

    <!-- Waveform Selector -->
    <div style="display:flex;gap:4px;margin-bottom:12px;">
      <button class="synth-wave-btn active" data-wave="sine" onclick="setSynthWave('sine')">SINE</button>
      <button class="synth-wave-btn" data-wave="square" onclick="setSynthWave('square')">SQUARE</button>
      <button class="synth-wave-btn" data-wave="sawtooth" onclick="setSynthWave('sawtooth')">SAW</button>
      <button class="synth-wave-btn" data-wave="triangle" onclick="setSynthWave('triangle')">TRI</button>
    </div>

    <!-- Keyboard -->
    <div id="synth-keyboard"></div>

    <!-- Octave Shift -->
    <div style="display:flex;gap:8px;align-items:center;justify-content:center;margin-bottom:12px;">
      <button class="synth-btn" onclick="synthShiftOctave(-1)">‚óÑ OCT</button>
      <span id="synth-octave-display" style="color:var(--green);font-size:14px;min-width:90px;text-align:center;">OCT 3-4</span>
      <button class="synth-btn" onclick="synthShiftOctave(1)">OCT ‚ñ∫</button>
    </div>

    <!-- ADSR -->
    <div class="synth-section">
      <div class="synth-section-label">ENVELOPE (ADSR)</div>
      <div style="display:grid;grid-template-columns:1fr 1fr 1fr 1fr;gap:8px;">
        <div><div style="font-size:10px;color:var(--green-dark)">ATK</div>
          <input type="range" id="synth-attack" min="1" max="1000" value="10" oninput="updateSynthADSR()">
          <div id="synth-atk-val" style="font-size:9px;color:var(--green);text-align:center">10ms</div></div>
        <div><div style="font-size:10px;color:var(--green-dark)">DEC</div>
          <input type="range" id="synth-decay" min="1" max="1000" value="200" oninput="updateSynthADSR()">
          <div id="synth-dec-val" style="font-size:9px;color:var(--green);text-align:center">200ms</div></div>
        <div><div style="font-size:10px;color:var(--green-dark)">SUS</div>
          <input type="range" id="synth-sustain" min="0" max="100" value="70" oninput="updateSynthADSR()">
          <div id="synth-sus-val" style="font-size:9px;color:var(--green);text-align:center">70%</div></div>
        <div><div style="font-size:10px;color:var(--green-dark)">REL</div>
          <input type="range" id="synth-release" min="10" max="2000" value="300" oninput="updateSynthADSR()">
          <div id="synth-rel-val" style="font-size:9px;color:var(--green);text-align:center">300ms</div></div>
      </div>
    </div>

    <!-- Filter -->
    <div class="synth-section">
      <div class="synth-section-label">LOW-PASS FILTER</div>
      <div style="display:grid;grid-template-columns:2fr 1fr;gap:10px;">
        <div><div style="font-size:10px;color:var(--green-dark)">CUTOFF</div>
          <input type="range" id="synth-cutoff" min="100" max="20000" value="8000" oninput="updateSynthFilter()">
          <div id="synth-cut-val" style="font-size:9px;color:var(--green);text-align:center">8000 Hz</div></div>
        <div><div style="font-size:10px;color:var(--green-dark)">RES</div>
          <input type="range" id="synth-reso" min="0" max="30" value="1" step="0.5" oninput="updateSynthFilter()">
          <div id="synth-res-val" style="font-size:9px;color:var(--green);text-align:center">1.0</div></div>
      </div>
    </div>

    <!-- Volume -->
    <div class="synth-section">
      <div style="display:flex;justify-content:space-between">
        <div class="synth-section-label">VOLUME</div>
        <span id="synth-vol-val" style="font-size:10px;color:var(--green)">50%</span>
      </div>
      <input type="range" id="synth-volume" min="0" max="100" value="50" oninput="updateSynthVol()">
    </div>

    <!-- 16-Step Sequencer -->
    <div class="synth-section">
      <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:6px;">
        <div class="synth-section-label" style="margin:0">SEQUENCER</div>
        <div style="display:flex;gap:4px;">
          <button id="synth-rec-btn" class="synth-btn rec" onclick="transportToggleRec()">‚óè REC</button>
          <button id="synth-play-btn" class="synth-btn" onclick="transportToggle()">‚ñ∂ PLAY</button>
          <button class="synth-btn" onclick="synthClearSeq()">CLR</button>
        </div>
      </div>
      <div id="synth-seq-grid" style="display:grid;grid-template-columns:repeat(16,1fr);gap:2px;margin-bottom:8px;"></div>
      <div style="display:flex;justify-content:space-between;align-items:center;">
        <div style="font-size:10px;color:var(--green-dark)">BPM</div>
        <span id="synth-bpm-val" style="font-size:10px;color:var(--green)">120</span>
      </div>
      <input type="range" id="synth-bpm" min="60" max="200" value="120" step="5" oninput="updateSynthBPM()">
    </div>

    <div style="color:var(--green-dark);font-size:9px;text-align:center;margin-top:8px;">
      KEYS: A-L = white ‚Ä¢ W E T Y U I O P = black ‚Ä¢ REC then play to sequence
    </div>
  </div>
</div>

<!-- ‚ïê‚ïê‚ïê DONUT.EXE ‚ïê‚ïê‚ïê -->
<div id="donut-popup">
  <div class="popup-titlebar">
    <span>üç© DONUT.EXE</span>
    <span class="popup-close" onclick="document.getElementById('donut-popup').classList.remove('show')">‚úï</span>
  </div>
  <div class="donut-content" id="donut-content"></div>
</div>

<!-- ‚ïê‚ïê‚ïê DRUMS.EXE ‚ïê‚ïê‚ïê -->
<div id="drums-popup">
  <div class="popup-titlebar">
    <span>ü•Å DRUMS.EXE</span>
    <span class="popup-close" onclick="document.getElementById('drums-popup').classList.remove('show');stopDrums()">‚úï</span>
  </div>
  <div style="padding:12px;">

    <!-- 8 Drum Pads -->
    <div id="drums-pads"></div>

    <!-- 16-Step Grid (8 rows √ó 16 cols) -->
    <div id="drums-grid"></div>

    <!-- Transport -->
    <div style="display:flex;justify-content:space-between;align-items:center;margin-top:10px;margin-bottom:10px;">
      <div style="display:flex;gap:4px;">
        <button id="drums-rec-btn" class="synth-btn rec" onclick="transportToggleRec()">‚óè REC</button>
        <button id="drums-play-btn" class="synth-btn" onclick="transportToggle()">‚ñ∂ PLAY</button>
        <button class="synth-btn" onclick="drumClear()">CLR</button>
      </div>
      <div style="display:flex;align-items:center;gap:8px;">
        <span style="font-size:10px;color:var(--green-dark)">BPM</span>
        <input type="range" id="drums-bpm" min="60" max="200" value="120" step="5" oninput="updateDrumsBPM()" style="width:100px;">
        <span id="drums-bpm-val" style="font-size:10px;color:var(--green);min-width:24px">120</span>
      </div>
    </div>

    <!-- Volume -->
    <div style="display:flex;align-items:center;gap:8px;">
      <span style="font-size:10px;color:var(--green-dark)">VOL</span>
      <input type="range" id="drums-volume" min="0" max="100" value="50" oninput="updateDrumsVol()" style="flex:1;">
      <span id="drums-vol-val" style="font-size:10px;color:var(--green);min-width:30px">50%</span>
    </div>

    <div style="color:var(--green-dark);font-size:9px;text-align:center;margin-top:8px;">
      KEYS 1-8 = pads ‚Ä¢ Click grid to program ‚Ä¢ Transport syncs with SYNTH.EXE
    </div>
  </div>
</div>

<!-- ‚ïê‚ïê‚ïê GALLERY.EXE ‚ïê‚ïê‚ïê -->
<div id="gallery-popup">
  <div class="popup-titlebar">
    <span>üñºÔ∏è GALLERY.EXE</span>
    <span class="popup-close" onclick="document.getElementById('gallery-popup').classList.remove('show')">‚úï</span>
  </div>
  <div id="gallery-grid"></div>
</div>

<!-- LIGHTBOX -->
<div id="gallery-lightbox" onclick="this.classList.remove('show')">
  <div id="gallery-lightbox-close">‚úï CLOSE</div>
  <div style="text-align:center;margin-bottom:20px;">
    <img id="gallery-lightbox-img" src="" alt="">
    <div id="gallery-lightbox-info" style="margin-top:20px;color:var(--green);"></div>
  </div>
</div>


<!-- ‚ïê‚ïê‚ïê SIDEBAR ‚ïê‚ïê‚ïê -->
<div id="sidebar">
  <div id="music-fab" onclick="toggleWindow('player-popup')" title="PLAYER.EXE">‚ô´</div>
  <div id="gallery-fab" onclick="toggleWindow('gallery-popup');renderGallery()" title="GALLERY.EXE">üñº</div>
  <div class="sidebar-divider"></div>
  <div id="taskbar-label">PROCESSES</div>
  <div id="taskbar"></div>
  <div class="sidebar-divider"></div>
  <div id="sidebar-status">
    <div id="sidebar-secrets">SECRETS: 0/10</div>
  </div>
  <div id="sidebar-socials">
    <div class="sidebar-divider"></div>
    <div style="font-size:10px;color:var(--green-dark);letter-spacing:1px;margin-bottom:6px;">CONNECT</div>
    <a href="#" target="_blank" rel="noopener" class="social-link" title="Instagram">IG</a>
    <a href="#" target="_blank" rel="noopener" class="social-link" title="Spotify">SPOTIFY</a>
    <a href="#" target="_blank" rel="noopener" class="social-link" title="Bandcamp">BANDCAMP</a>
    <a href="#" target="_blank" rel="noopener" class="social-link" title="YouTube">YT</a>
  </div>
</div>
    </div>
  </div>
</div>

<!-- ‚ïê‚ïê‚ïê AUDIO & EASTER EGGS ‚ïê‚ïê‚ïê -->
<audio id="audio-player" preload="auto"></audio>
<input type="file" id="restore-file-input" accept=".json" style="display:none">
<div id="jpark-overlay">
  <img src="./redacted_assets/images/GIFs/jurassic-park.gif" alt="Jurassic Park Error">
</div>
<div id="jesus-overlay">
  <img src="./redacted_assets/images/GIFs/dancing-jesus.gif" alt="Dancing Jesus">
</div>

<script>
const CONFIG={
  artist:'REDACTED CLUB',format:'mp3',audioPath:'./redacted_assets/audio/',
  defaultVolume:0.7,
  pinLength:4,
  colors:{green:'#00ff41',greenDim:'#00aa2a',greenDark:'#00752b',amber:'#ffaa00',red:'#ff0040',cyan:'#00aaff'},
  storage:{prefix:'rcplayer_',secrets:'rcplayer_secrets',discovered:'rcplayer_discovered',discoveredCmds:'rcplayer_discoveredCmds',progression:'rcplayer_progression',snakeHigh:'rcplayer_snakeHighScore',tronWins:'rcplayer_tronWins'},
  tracks:[
    // Main EP - Always Visible
    {id:'RC-001',title:'CASINO',file_mp3:'Casino.mp3',file_wav:'Casino.wav',visible:true,locked:false},
    {id:'RC-002',title:'DRUNK N STUMBLIN',file_mp3:'DnS.mp3',file_wav:'DnS.wav',visible:true,locked:false},
    {id:'RC-003',title:'DESTROY ARCHITECTURE',file_mp3:'DA.mp3',file_wav:'DA.wav',visible:true,locked:false},
    {id:'RC-004',title:'COULD BE WORSE',file_mp3:'Could Be 5.mp3',file_wav:'Could Be 5.wav',visible:true,locked:false},

    // Hidden Bonus Tracks - Unlock with codes
    {id:'RC-005',title:'‚ñà‚ñà‚ñà ‚ñà‚ñà‚ñà‚ñà ‚ñà‚ñà‚ñà‚ñà‚ñà',file_mp3:'One Last Drink 2.mp3',file_wav:'One Last Drink 2.wav',visible:false,locked:true,unlockCode:'SIGNAL'},
    {id:'RC-006',title:'‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà ‚ñà‚ñà‚ñà‚ñà',file_mp3:'Sundee Arvo.mp3',file_wav:'Sundee Arvo.wav',visible:false,locked:true,unlockCode:'BENEATH'},

    // Secret Track - Master Code
    {id:'RC-007',title:'‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà ‚ñà‚ñà',file_mp3:'GG.mp3',file_wav:'GG.wav',visible:false,locked:true,unlockCode:'REDACTED'},
  ],
  secrets:{codesFound:[],totalCodes:10,masterCode:'OMNISCIENT'}
};

// ‚ïê‚ïê‚ïê SOUND EFFECTS SYSTEM ‚ïê‚ïê‚ïê
const SFX = {
  path: './redacted_assets/sfx/',
  volume: 0.7,  // Global SFX volume (0.0 - 1.0)
  enabled: true,  // Master SFX toggle
  cache: {},  // Preloaded sounds

  // Sound library with categories
  library: {
    // UI Sounds
    'ui_click': 'ui/old-computer-click.mp3',

    // Glitch Sounds
    'glitch_light': 'glitch/dragon-studio-glitch-effect-1-397982.mp3',
    'glitch_heavy': 'glitch/denielcz-glitch-437832.mp3',
    'glitch_corrupt': 'glitch/abadiaovl-57130.mp3',
    'glitch_error': 'glitch/errors.mp3',
    'glitch_loop': 'glitch/technical_error_ss_1_hq_loop.mp3',

    // Scanner Sounds
    'scanner_ping': 'scanner/sunovia-sonar-ping-290188.mp3',
    'scanner_lock': 'scanner/file.mp3',

    // Ambient
    'ambient_boot': 'ambient/old-desktop-pc-booting.mp3',
    'ambient_hum': 'ambient/old_compute.mp3',
    'ambient_hdd': 'ambient/vintage-hard-drive-read-and-idle.mp3',

    // Easter Eggs
    'nedry': 'easter_eggs/dennis_nedry_ahahah.mp3',
    'retro_movie': 'easter_eggs/sdanezis-old-retro-1950x27s-style-history-movie-sfx-271577.mp3'
  },

  // Play a sound effect
  play: function(soundName, volumeOverride = null) {
    if (!this.enabled) return;

    // Check if sound exists in library
    if (!this.library[soundName]) {
      console.warn(`SFX: Sound "${soundName}" not found in library`);
      return;
    }

    // Get or create audio element
    let sound;
    if (this.cache[soundName]) {
      // Use cached sound
      sound = this.cache[soundName].cloneNode();
    } else {
      // Create new sound and cache it
      sound = new Audio(this.path + this.library[soundName]);
      this.cache[soundName] = sound;
    }

    // Set volume
    const vol = volumeOverride !== null ? volumeOverride : this.volume;
    sound.volume = Math.max(0, Math.min(1, vol));

    // Play with error handling
    sound.play().catch(err => {
      console.warn(`SFX: Failed to play "${soundName}":`, err.message);
    });

    return sound;
  },

  // Preload specific sounds
  preload: function(soundNames) {
    soundNames.forEach(name => {
      if (this.library[name] && !this.cache[name]) {
        const sound = new Audio(this.path + this.library[name]);
        sound.preload = 'auto';
        this.cache[name] = sound;
      }
    });
  },

  // Set master volume
  setVolume: function(vol) {
    this.volume = Math.max(0, Math.min(1, vol));
  },

  // Toggle SFX on/off
  toggle: function() {
    this.enabled = !this.enabled;
    return this.enabled;
  },

  // Stop all currently playing SFX
  stopAll: function() {
    Object.values(this.cache).forEach(sound => {
      sound.pause();
      sound.currentTime = 0;
    });
  }
};

// Convenience function (shorter syntax)
function playSFX(soundName, volume = null) {
  return SFX.play(soundName, volume);
}

// Preload commonly used sounds on page load
window.addEventListener('DOMContentLoaded', () => {
  SFX.preload(['ui_click', 'glitch_light', 'glitch_heavy', 'glitch_error', 'scanner_ping']);
});

// ‚ïê‚ïê‚ïê WINDOW REGISTRY (Taskbar System) ‚ïê‚ïê‚ïê
const WindowRegistry = {
  windows: {
    // player-popup & gallery-popup removed from registry ‚Äî use dedicated sidebar buttons
    'scanner-popup': { name: 'SCANNER', icon: 'üì°', command: 'scan',    discovered: false },
    'decode-popup':  { name: 'DECODE',  icon: 'üîì', command: 'decode',  discovered: false },
    'files-popup':   { name: 'FILES',   icon: 'üìÇ', command: 'files',   discovered: false },
    'calc-popup':    { name: 'CALC',    icon: 'üî¢', command: 'calc',    discovered: false },
    'notepad-popup': { name: 'NOTEPAD', icon: 'üìù', command: 'notepad', discovered: false },
    'snake-popup':   { name: 'SNAKE',   icon: 'üêç', command: 'snake',   discovered: false },
    'tron-popup':    { name: 'TRON',    icon: '‚ö°', command: 'tron',    discovered: false },
    'matrix-popup':  { name: 'MATRIX',  icon: 'üü¢', command: 'matrix',  discovered: false },
    'pincode-popup': { name: 'PINCODE', icon: 'üîê', command: 'pincode', discovered: false },
    'radar-popup':   { name: 'RADAR',   icon: 'üì°', command: 'radar',   discovered: false },
    'echoes-popup':  { name: 'ECHOES',  icon: 'üìã', command: 'echoes',  discovered: false },
    'donut-popup':   { name: 'DONUT',   icon: 'üç©', command: 'donut',   discovered: false },
    'synth-popup':   { name: 'SYNTH',   icon: 'üéπ', command: 'synth',   discovered: false },
    'drums-popup':   { name: 'DRUMS',   icon: 'ü•Å', command: 'drums',   discovered: false },
    'pool-popup':    { name: 'POOL',    icon: 'üé±', command: 'pool',    discovered: false },
  },

  discover(windowId) {
    const win = this.windows[windowId];
    if (!win || win.discovered) return;
    win.discovered = true;
    this.renderTaskbar();
  },

  renderTaskbar() {
    const taskbar = document.getElementById('taskbar');
    if (!taskbar) return;
    taskbar.innerHTML = '';
    Object.keys(this.windows).forEach(id => {
      const win = this.windows[id];
      if (!win.discovered) return;
      const el = document.getElementById(id);
      const isOpen = el && el.classList.contains('show');
      const item = document.createElement('div');
      item.className = 'taskbar-item' + (isOpen ? ' active' : '');
      item.style.animation = 'taskbar-add .4s ease forwards';
      item.innerHTML = `<span class="indicator"></span><span class="tb-icon">${win.icon}</span> ${win.name}`;
      item.onclick = () => {
        toggleWindow(id);
        this.updateIndicators();
      };
      taskbar.appendChild(item);
    });
  },

  updateIndicators() {
    const items = document.querySelectorAll('.taskbar-item');
    const ids = Object.keys(this.windows).filter(id => this.windows[id].discovered);
    items.forEach((item, i) => {
      if (i >= ids.length) return;
      const el = document.getElementById(ids[i]);
      const isOpen = el && el.classList.contains('show');
      item.classList.toggle('active', isOpen);
    });
  }
};

// ‚ïê‚ïê‚ïê HINT ENGINE ‚ïê‚ïê‚ïê
const HintEngine = {
  history: [],
  lastActivity: Date.now(),
  idleTimer: null,
  idleThreshold: 30000, // 30 seconds

  init() {
    // Track user activity
    document.addEventListener('keydown', () => { this.lastActivity = Date.now(); });
    document.addEventListener('click', () => { this.lastActivity = Date.now(); });
    // Check for idle every 10 seconds
    this.idleTimer = setInterval(() => this.checkIdle(), 10000);
  },

  checkIdle() {
    if (!state || !state.bootComplete) return;
    const idle = Date.now() - this.lastActivity;
    if (idle < this.idleThreshold) return;

    // Pick a contextual hint based on current state
    const hint = this.getContextualHint();
    if (hint && !this.history.includes(hint)) {
      this.history.push(hint);
      this.show(hint);
      this.lastActivity = Date.now(); // Reset so we don't spam
    }
  },

  getContextualHint() {
    const m=state.progression.milestone;const hints=[];
    if(m===0){
      hints.push('try "files" to see what\'s on this terminal...');
      hints.push('there are files here. try "read manifest.log"...');
      hints.push('type "help" if you\'re lost...');
    }
    if(m===1&&!state.discoveredCommands.scanner){
      hints.push('the system log mentions a signal at 97.7...');
      hints.push('try "scan" to open the spectrum analyzer...');
      hints.push('something is broadcasting on 97.7 MHz...');
    }
    if(m===1&&state.discoveredCommands.scanner&&state.progression.signalsLocked===0){
      hints.push('use the frequency knob to dial in 97.7...');
      hints.push('the PING button will reveal nearby signals...');
      hints.push('when proximity hits 90%+, try the LOCK button...');
    }
    if(m===2){
      hints.push('108.0 MHz is mentioned in the system log...');
      hints.push('the access.log file mentions some codes...');
      hints.push('have you tried the PINCODE system?');
      hints.push('four digits. think about frequencies.');
      hints.push('try "decode" to open the decryption module...');
      hints.push('locked signals can be decrypted with DECODE.EXE...');
    }
    if(m===3){
      hints.push('there might be a signal beyond the normal band...');
      hints.push('115.3 MHz... does that even exist?');
      hints.push('read the transmission log carefully...');
      hints.push('the word is eight letters. it sees everything.');
    }
    if(m>=4){
      hints.push('some gallery images are still locked. secrets unlock them.');
      hints.push('have you tried all the PIN codes?');
      hints.push('up up down down left right left right B A');
      hints.push('some commands aren\'t in the help menu...');
    }
    const unseen=hints.filter(h=>!this.history.includes(h));
    return unseen.length>0?unseen[Math.floor(Math.random()*unseen.length)]:null;
  },

  show(text) {
    printLine(text, 'ghost');
  }
};

function updateSidebarStatus() {
  const secretsEl = document.getElementById('sidebar-secrets');
  if (secretsEl) secretsEl.textContent = `SECRETS: ${CONFIG.secrets.codesFound.length}/${CONFIG.secrets.totalCodes}`;
}

let state={
  currentTrack:-1,isPlaying:false,commandHistory:[],historyIndex:-1,
  discovered:new Set(),bootComplete:false,
  headerRevealed:false,welcomeDismissed:false,sidebarOpen:false,
  playerOpened:false,
  radarUnlocked:false,
  discoveredCommands:{scanner:false,decode:false,pincode:false,gallery:false},
  progression:{
    milestone:0,
    milestones:[],
    filesRead:[],
    signalsLocked:0,
    tracksUnlocked:0,
    pinsEntered:[],
    breadcrumbsSeen:[]
  },
};

// Restore persisted progress from localStorage
try{
  const ss=JSON.parse(localStorage.getItem(CONFIG.storage.secrets)||'[]')
  ss.forEach(s=>{if(!CONFIG.secrets.codesFound.includes(s))CONFIG.secrets.codesFound.push(s)})
  const sd=JSON.parse(localStorage.getItem(CONFIG.storage.discovered)||'[]')
  sd.forEach(d=>state.discovered.add(d))
  const dc=JSON.parse(localStorage.getItem(CONFIG.storage.discoveredCmds)||'{}')
  Object.assign(state.discoveredCommands,dc)
  if(ss.length>0)state.headerRevealed=true
  const sp=JSON.parse(localStorage.getItem(CONFIG.storage.progression)||'null')
  if(sp)Object.assign(state.progression,sp)
}catch(e){}

function persistProgression(){
  localStorage.setItem(CONFIG.storage.progression,JSON.stringify(state.progression))
}

// Auto-grant milestones for existing players who already have progress
function recalculateMilestones(){
  const p=state.progression
  const secrets=CONFIG.secrets.codesFound
  if(secrets.some(s=>['LS','CAT_MANIFEST','CAT_SYSLOG','CAT_FREQ'].includes(s))){
    if(!p.milestones.includes('EXPLORATION'))p.milestones.push('EXPLORATION')
  }
  if(secrets.some(s=>s.startsWith('UNLOCK_'))){
    if(!p.milestones.includes('SIGNAL_DISCOVERY'))p.milestones.push('SIGNAL_DISCOVERY')
  }
  const unlocked=secrets.filter(s=>s.startsWith('UNLOCK_')).length
  if(unlocked>=2||p.pinsEntered.length>=1){
    if(!p.milestones.includes('DEEP_SCAN'))p.milestones.push('DEEP_SCAN')
  }
  if(unlocked>=3){
    if(!p.milestones.includes('FULL_INTERCEPT'))p.milestones.push('FULL_INTERCEPT')
  }
  p.milestone=p.milestones.length
  p.tracksUnlocked=state.discovered.size
  persistProgression()
}
if(CONFIG.secrets.codesFound.length>0)recalculateMilestones()

const audio=document.getElementById('audio-player');
const output=document.getElementById('output');
const cmdInput=document.getElementById('cmd-input');



function sleep(ms){return new Promise(r=>setTimeout(r,ms))}

function discoverCommandGroup(group){
  if(state.discoveredCommands[group])return
  state.discoveredCommands[group]=true
  localStorage.setItem(CONFIG.storage.discoveredCmds,JSON.stringify(state.discoveredCommands))
  setTimeout(()=>{printLine('');printLine('[NEW COMMANDS UNLOCKED ‚Äî type \'help\' to see]','warning');printLine('')},600)
}




function openSidebar(){
  if(state.sidebarOpen)return;state.sidebarOpen=true;
  document.getElementById('main-grid').classList.add('sidebar-open');
}

// ‚ïê‚ïê‚ïê WELCOME ‚ïê‚ïê‚ïê
function initWelcomeScreen(){
  const art = [
    '',
    '',
    '  ‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì',
    '  ‚ñì      ‚ö† UNAUTHORIZED BROADCAST DETECTED ‚ö†        ‚ñì',
    '  ‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì',
    '',
    '',
    '  ‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ïó ‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ïó‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ïó  ‚ñà‚ñà‚ñà‚ñà‚ñà‚ïó   ‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ïó‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ïó‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ïó‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ïó    ',
    '  ‚ñà‚ñà‚ïî‚ïê‚ïê‚ñà‚ñà‚ïó‚ñà‚ñà‚ïî‚ïê‚ïê‚ïê‚ïê‚ïù‚ñà‚ñà‚ïî‚ïê‚ñà‚ñà‚ïó ‚ñà‚ñà‚ïî‚ïê‚ïê‚ñà‚ñà‚ïó ‚ñà‚ñà‚ïî‚ïê‚ïê‚ïê‚ïù‚ïö‚ïê‚ïê‚ñà‚ñà‚ïî‚ïê‚ïê‚ïù‚ñà‚ñà‚ïî‚ïê‚ïê‚ïê‚ïù‚ñà‚ñà‚ïî‚ïê‚ïê‚ñà‚ñà‚ïó    ',
    '  ‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ïî‚ïù‚ñà‚ñà‚ñà‚ñà‚ñà‚ïó  ‚ñà‚ñà‚ïë  ‚ñà‚ñà‚ïë ‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ïë ‚ñà‚ñà‚ïë          ‚ñà‚ñà‚ïë    ‚ñà‚ñà‚ñà‚ñà‚ñà‚ïó  ‚ñà‚ñà‚ïë  ‚ñà‚ñà‚ïë    ',
    '  ‚ñà‚ñà‚ïî‚ïê‚ïê‚ñà‚ñà‚ïó‚ñà‚ñà‚ïî‚ïê‚ïê‚ïù  ‚ñà‚ñà‚ïë  ‚ñà‚ñà‚ïë ‚ñà‚ñà‚ïî‚ïê‚ïê‚ñà‚ñà‚ïë ‚ñà‚ñà‚ïë          ‚ñà‚ñà‚ïë    ‚ñà‚ñà‚ïî‚ïê‚ïê‚ïù  ‚ñà‚ñà‚ïë  ‚ñà‚ñà‚ïë    ',
    '  ‚ñà‚ñà‚ïë  ‚ñà‚ñà‚ïë‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ïó‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ïî‚ïù‚ñà‚ñà‚ïë  ‚ñà‚ñà‚ïë  ‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ïó     ‚ñà‚ñà‚ïë    ‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ïó‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ïë   ',
    '  ‚ïö‚ïê‚ïù  ‚ïö‚ïê‚ïù‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù ‚ïö‚ïê‚ïù  ‚ïö‚ïê‚ïù  ‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù     ‚ïö‚ïê‚ïù    ‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù    ',
    '',
    '',
    ' C L U B',
    '',
    '',
    ' PIRATE RADIO COLLECTIVE',
    '',
    ' ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê',
    'FREQ: 97.7 MHz  ‚îÇ  POWER: ‚ñà‚ñà‚ñà‚ñà  ‚îÇ  LIVE',
    'BROADCASTING FROM [REDACTED]',
    ' ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê',
    ''
  ];
  
  document.getElementById('welcome-art').textContent = art.join('\n');

  const dismiss=(e)=>{
    if(state.welcomeDismissed)return;
    if(e.type==='keydown'&&['Tab','Shift','Control','Alt','Meta'].includes(e.key))return;
    state.welcomeDismissed=true;
    document.getElementById('welcome-screen').classList.add('hidden');
    document.removeEventListener('keydown',dismiss);document.removeEventListener('click',dismiss);
    setTimeout(()=>startBoot(),800);
  };
  document.addEventListener('keydown',dismiss);document.addEventListener('click',dismiss);
}

// ‚ïê‚ïê‚ïê BOOT ‚ïê‚ïê‚ïê
const bootMsgs=[
  {text:'POST ... ',delay:300,append:true},{text:'OK',delay:200,cls:'dim'},
  {text:'MEM 640K',delay:100,cls:'dim'},{text:'...',delay:500},
  {text:'LOADING ‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà://‚ñà‚ñà‚ñà',delay:250},{text:'',delay:200},
  {text:'SUBSYS_AUDIO ........... ',delay:80,append:true},{text:'ERR',delay:200,cls:'error'},
  {text:'SUBSYS_AUDIO ........... RETRY',delay:250,cls:'warning'},
  {text:'SUBSYS_AUDIO ........... OK',delay:150,cls:'dim'},
  {text:'SUBSYS_CRYPTO .......... [PARTIAL]',delay:200,cls:'warning'},
  {text:'SUBSYS_‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà ........ ‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà',delay:100,cls:'error'},
  {text:'SUBSYS_NORM ............ ',delay:80,append:true},{text:'LOADED',delay:200,cls:'dim'},
  {text:'',delay:300},
  {text:'WARNING: INTEGRITY CHECK FAILED ON 2 FILES',delay:100,cls:'error'},
  {text:'UNAUTHORIZED MODIFICATIONS DETECTED',delay:100,cls:'error'},
  {text:'',delay:400},{text:'...',delay:300},
  {text:'',delay:600},
];

async function startBoot(){
  const bs=document.getElementById('boot-screen'),bt=document.getElementById('boot-text');

  bs.classList.add('active');let cur=null;
  playSFX('ambient_boot',0.5);
  for(const m of bootMsgs){
    if(m.append&&cur){cur.textContent+=m.text;await sleep(m.delay)}
    else{
      const l=document.createElement('div');l.className='boot-line';l.style.animationDelay='0s';
      l.style.color=m.cls==='error'?'var(--red)':m.cls==='warning'?'var(--amber)':m.cls==='dim'?'var(--green-dark)':'var(--green)';
      l.textContent=m.text;bt.appendChild(l);cur=m.append?l:null;await sleep(m.delay);
    }
  }
  await sleep(200);
  bs.classList.remove('active');bs.classList.add('hidden');await sleep(500);
  state.bootComplete=true;openSidebar();
  // Start ambient terminal hum loop
  const ambientHum=playSFX('ambient_hum',0.15);
  if(ambientHum){ambientHum.loop=true}
  // Start idle hint system
  HintEngine.init();
  initScreensaverIdle();

  printLine('');
  printLine('‚ïî‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïó','dim');
  printLine('‚ïë                                               ‚ïë','dim');
  printLine('‚ïë   SIGNAL INTERCEPT TERMINAL                   ‚ïë','');
  printLine('‚ïë   ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ                   ‚ïë','dim');
  printLine('‚ïë   ORIGIN:  UNKNOWN                            ‚ïë','dim');
  printLine('‚ïë   CARRIER: ‚ñà‚ñà‚ñà.‚ñà MHz                          ‚ïë','dim');
  printLine('‚ïë   CONTENT: AUDIO TRANSMISSIONS (5 FILES)      ‚ïë','');
  printLine('‚ïë   STATUS:  PARTIALLY ENCRYPTED                ‚ïë','warning');
  printLine('‚ïë                                               ‚ïë','dim');
  printLine('‚ïë   This signal was intercepted from an         ‚ïë','dim');
  printLine('‚ïë   unregistered frequency band. Contents       ‚ïë','dim');
  printLine('‚ïë   appear to be encoded audio files from       ‚ïë','dim');
  printLine('‚ïë   an unknown source.                          ‚ïë','dim');
  printLine('‚ïë                                               ‚ïë','dim');
  printLine('‚ïë   Some files remain locked.                   ‚ïë','warning');
  printLine('‚ïë                                               ‚ïë','dim');
  printLine('‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù','dim');
  printLine('');printLine('Type "help" for available commands.','dim');printLine('');


  const ghost=document.createElement('div');ghost.className='ghost-text';
  ghost.textContent='the signal was always there. you just had to listen.';
  ghost.onclick=()=>{addSecret('GHOST_CLICK');printLine('...','dim')};
  output.appendChild(ghost);printLine('');

  // Open player on boot with tracks loaded
  renderPlayerTracks();
  toggleWindow('player-popup');

  generateSessionId();startClock();cmdInput.focus();
}

// ‚ïê‚ïê‚ïê OUTPUT ‚ïê‚ïê‚ïê
function printLine(t,c='',raw=false){const l=document.createElement('div');l.className=`line ${c}`;if(raw)l.innerHTML=t;else l.textContent=t;output.appendChild(l);output.scrollTop=output.scrollHeight;return l}
function printSlow(t,c='',d=30){const l=printLine('',c);let i=0;const iv=setInterval(()=>{if(i<t.length){l.textContent+=t[i];i++;output.scrollTop=output.scrollHeight}else clearInterval(iv)},d);return l}

// ‚ïê‚ïê‚ïê HELP ‚ïê‚ïê‚ïê
function showHelp(){
  const m=state.progression.milestones;
  printLine('');
  // Milestone 0: bare minimum
  printLine('  help          ‚Äî show this message','dim');
  printLine('  clear         ‚Äî clear screen','dim');
  printLine('  files         ‚Äî list files in directory','dim');
  printLine('  read [file]   ‚Äî open a file','dim');
  printLine('  player        ‚Äî audio controls','dim');
  printLine('  gallery       ‚Äî view images','dim');
  // Milestone 1+: playback, search, games
  if(m.includes('EXPLORATION')){
    printLine('','');printLine('‚îÄ‚îÄ PLAYBACK ‚îÄ‚îÄ','dim');
    printLine('  play [n]      ‚Äî play a track by number','dim');printLine('  pause / stop  ‚Äî pause or stop playback','dim');
    printLine('  next / prev   ‚Äî skip tracks','dim');printLine('  list          ‚Äî view available tracks','dim');
    printLine('  search [term] ‚Äî search through files','dim');
    printLine('','');printLine('‚îÄ‚îÄ GAMES ‚îÄ‚îÄ','dim');printLine('  snake         ‚Äî classic snake game','dim');printLine('  tron          ‚Äî lightcycle arena','dim');printLine('  pool          ‚Äî 8-ball pool vs bot','dim');
  }
  // Scanner discovered: signals section
  if(state.discoveredCommands.scanner){
    printLine('','');printLine('‚îÄ‚îÄ SIGNALS ‚îÄ‚îÄ','dim');
    printLine('  scan          ‚Äî sweep for radio frequencies','dim');printLine('  tune [freq]   ‚Äî lock onto a frequency','dim');printLine('  ping          ‚Äî signal test','dim');printLine('  echoes        ‚Äî view signal log','dim');
    if(state.discoveredCommands.decode){printLine('  decode        ‚Äî open DECODE.EXE to decrypt locked signals','dim')}
  }
  // Milestone 2+: pincode
  if(m.includes('SIGNAL_DISCOVERY')){
    printLine('','');printLine('‚îÄ‚îÄ SECURITY ‚îÄ‚îÄ','dim');
    printLine('  pincode       ‚Äî PIN entry interface','dim');
  }
  // Milestone 3+: synth, drums
  if(m.includes('DEEP_SCAN')){
    printLine('','');printLine('‚îÄ‚îÄ AUDIO TOOLS ‚îÄ‚îÄ','dim');
    printLine('  synth         ‚Äî keyboard synthesizer','dim');printLine('  drums         ‚Äî drum machine','dim');
  }
  // Milestone 1+: system/data
  if(m.includes('EXPLORATION')){
    printLine('','');printLine('‚îÄ‚îÄ SYSTEM ‚îÄ‚îÄ','dim');
    printLine('  status        ‚Äî system info','dim');printLine('  secrets       ‚Äî your discoveries','dim');
    printLine('  sfx           ‚Äî sound effects controls','dim');
    printLine('  backup        ‚Äî export save state','dim');printLine('  restore       ‚Äî import save state','dim');
  }
  printLine('');
}

// ‚ïê‚ïê‚ïê COMMANDS ‚ïê‚ïê‚ïê
const COMMANDS={
  help:()=>showHelp(),
  list:()=>{printLine('');printLine('‚îÄ‚îÄ INDEXED FILES ‚îÄ‚îÄ','dim');setTimeout(()=>{CONFIG.tracks.forEach((t,i)=>{const n=String(i+1).padStart(2,'0');const ip=state.currentTrack===i&&state.isPlaying;if(!t.visible&&!state.discovered.has(t.id))return;const el=document.createElement('div');el.className='track-entry';if(t.locked&&!state.discovered.has(t.id)){el.classList.add('locked');el.textContent=`  [${n}] ${t.id} :: ‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà [ENCRYPTED]`;el.onclick=()=>{printLine('ACCESS DENIED ‚Äî this file is encrypted.','error');setTimeout(()=>printLine('Hint: use "scan" to find decryption keys.','ghost'),800)}}else if(state.discovered.has(t.id)){el.innerHTML=`  [${n}] ${t.id} :: ${t.title} ${ip?'<span style="color:var(--amber)">‚ñ∂</span>':''}`;el.onclick=()=>playTrackByIndex(i)}else{el.innerHTML=`  [${n}] ${t.id} :: ${t.title} ${ip?'<span style="color:var(--amber)">‚ñ∂</span>':''}`;el.onclick=()=>playTrackByIndex(i)}if(ip)el.classList.add('playing');output.appendChild(el)});if(!state.discovered.has('RC-005')){setTimeout(()=>{const h=printLine('Some files are hidden. Keep exploring.','ghost');setTimeout(()=>h.remove(),4000)},2000)}printLine('');output.scrollTop=output.scrollHeight},250)},
  gallery:()=>{
    document.getElementById('gallery-popup').classList.add('show');
    WindowRegistry.discover('gallery-popup');
    renderGallery();
    printLine('Opening GALLERY.EXE...','dim');
  },
  photos:()=>{COMMANDS.gallery()},
  player:()=>{
    document.getElementById('player-popup').classList.add('show');
    WindowRegistry.discover('player-popup');
    initPlayerPopup();
    printLine('Opening PLAYER.EXE...','dim');
    state.playerOpened=true;
  },
  play:(a)=>{const n=parseInt(a[0]);if(a[0]&&!isNaN(n))playTrackByIndex(n-1);else if(state.currentTrack>=0)togglePlay();else printLine('Usage: play [number]  (e.g. play 1)','error')},
  pause:()=>togglePlay(),stop:()=>stopTrack(),next:()=>nextTrack(),prev:()=>prevTrack(),
  vol:(a)=>{const v=parseInt(a[0]);if(!isNaN(v)&&v>=0&&v<=100){setVolume(v);const ps=document.getElementById('player-volume');if(ps)ps.value=v;const pd=document.getElementById('player-volume-display');if(pd)pd.textContent=v;printLine(`VOL: ${v}`,'dim')}},
  format:()=>toggleFormat(),clear:()=>{output.innerHTML=''},
  files:()=>{openFilesExe();printLine('Opening FILES.EXE...','dim');addSecret('LS');if(!state.progression.filesRead.includes('files')){state.progression.filesRead.push('files');checkProgression()}},
  ls:()=>COMMANDS.files(),
  read:(a)=>{const f=(a[0]||'').toLowerCase().replace(/^\./, '');if(!f){printLine('Usage: read [file]  (or type "files" to browse)','dim');return}const match=FILE_SYSTEM.find(fs=>{const n=fs.name.replace(/\.log$/,'');return fs.name===f||n===f});if(match){const m=state.progression.milestones;if(match.milestone&&!m.includes(match.milestone)){printLine(`File not found: ${f}  (try "files" to see what's here)`,'error');return}openFilesExe();setTimeout(()=>filesOpenFile(match.name),100)}else{printLine(`File not found: ${f}  (try "files" to browse)`,'error')}},
  cat:(a)=>COMMANDS.read(a),
scan:(a)=>{
    document.getElementById('scanner-popup').classList.add('show');
    WindowRegistry.discover('scanner-popup');
    if(!scannerState.canvas) initScanner();
    printLine('Opening SCANNER.EXE...','dim');
    discoverCommandGroup('scanner');
  },
  tune:(a)=>{const f=a[0];if(f==='97.7'){tuneToFrequency(97.7)}else if(f==='108.0'||f==='108'){tuneToFrequency(108.0)}else if(f){printLine(`${f} MHz ‚Äî noise floor only. Try 97.7 or 108.0.`,'dim')}else{printLine('Usage: tune [frequency]  (e.g. tune 97.7)','dim');printLine('Or use the SCANNER to find signals first.','ghost')}},
  decode:(a)=>{const c=a.join(' ').toLowerCase().trim();if(c===CONFIG.secrets.masterCode.toLowerCase()){COMMANDS.unlockAll();return}if(c){const sig=scannerState.lockedSignals.find(s=>s.code.toLowerCase()===c);if(sig){decodeOpenForSignal(sig.code);return}const m=CONFIG.tracks.find(t=>t.unlockCode&&t.unlockCode.toLowerCase()===c);if(m){printLine('Signal not locked yet. Use SCANNER.EXE to find and lock this frequency.','dim');return}}openDecode()},
  signal:()=>decodeOpenForSignal('SIGNAL'),beneath:()=>decodeOpenForSignal('BENEATH'),
  redacted:()=>{
    playSFX('glitch_heavy',0.4);
    printLine('');
    printLine('ACCESS DENIED','error');

    // Show Jurassic Park GIF overlay
    const jparkOverlay = document.getElementById('jpark-overlay');
    jparkOverlay.classList.add('show');

    // Play nedry 3 times sequentially, no overlap
    setTimeout(()=>{
      printLine('Uh uh uh!','error');
      printLine('You didn\'t say the magic word!','error');
      printLine('','');
      const s1=playSFX('nedry',0.7);
      if(s1)s1.onended=()=>{
        printLine('Uh uh uh!','error');
        const s2=playSFX('nedry',0.7);
        if(s2)s2.onended=()=>{
          printLine('Uh uh uh!','error');
          playSFX('nedry',0.7);
        };
      };
    },300);

    // Hide overlay after 10 seconds with fade out
    setTimeout(()=>{
      jparkOverlay.classList.add('fadeout');
      setTimeout(()=>{
        jparkOverlay.classList.remove('show', 'fadeout');
      },500);
    },10000);
  },
  unlockAll:()=>{playSFX('glitch_heavy',0.4);printLine('');printLine('‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà','error');setTimeout(()=>{printLine('  MASTER KEY ACCEPTED','error');printLine('  ALL FILES DECRYPTED','error');printLine('‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà','error');printLine('');CONFIG.tracks.forEach(t=>{if(t.locked&&!state.discovered.has(t.id))state.discovered.add(t.id)});addSecret('MASTER_KEY');revealHeader();updateSidebarStatus();state.progression.tracksUnlocked=state.discovered.size;checkProgression()},400)},
  homer:()=>{
    playSFX('glitch_heavy',0.4);
    printLine('');printLine('D\'OH!','warning');
    const overlay=document.getElementById('jesus-overlay');
    overlay.classList.add('show');
    setTimeout(()=>{
      overlay.classList.add('fadeout');
      setTimeout(()=>{overlay.classList.remove('show','fadeout')},500);
    },8000);
  },
  source:()=>{printLine('');printLine('// you found this','ghost');printLine('// the frequencies hold the keys','ghost');printLine('// 97.7 and 108.0','ghost');printLine('// OMNISCIENT is the word that opens ‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà','error');printLine('');addSecret('SOURCE')},
  whoami:()=>{printLine('');printSlow('QUERY: IDENTITY','dim',40);setTimeout(()=>{printLine('...','dim');setTimeout(()=>{printLine('UNAUTHORIZED','error')},600)},400)},
  secrets:()=>{if(CONFIG.secrets.codesFound.length===0)printLine('Nothing found yet.','dim');else{printLine(`[${CONFIG.secrets.codesFound.length}/${CONFIG.secrets.totalCodes}] discoveries:` ,'dim');CONFIG.secrets.codesFound.forEach(s=>printLine(`  ‚ñ† ${s}`,'ghost'))}printLine('')},
  ping:()=>{printLine('PING ‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà.‚ñà‚ñà‚ñà ...','dim');setTimeout(()=>printLine(`seq=1 ttl=‚ñà‚ñà time=${Math.floor(Math.random()*999)}ms`,'dim'),200);setTimeout(()=>printLine(`seq=2 ttl=‚ñà‚ñà time=${Math.floor(Math.random()*999)}ms`,'dim'),500);setTimeout(()=>{printLine('SIGNAL LOST','error')},900)},
  echo:(a)=>{const t=a.join(' ');if(t.toLowerCase().includes('redacted')){playSFX('glitch_heavy',0.4);printLine('‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà','error')}else printLine(t,'')},
  search:(a)=>{const q=(a.join(' ')||'').toLowerCase();if(!q){printLine('Usage: search [term]','dim');return}if(q.includes('signal'))printLine('system.log: signal detected at frequency 97.7','ghost');else if(q.includes('beneath')||q.includes('hidden'))printLine('system.log: something beneath the noise floor','ghost');else if(q.includes('key')||q.includes('decrypt'))printLine('frequencies.log: the frequencies hold the keys','ghost');else if(q.includes('redacted')||q.includes('club'))printLine('manifest.log: REDACTED CLUB','ghost');else printLine('No matches found.','dim')},
  grep:(a)=>COMMANDS.search(a),
  hint:()=>{setTimeout(()=>{const hints=['Try typing HELP to see commands.','Type FILES to see what is available.','You can READ files that are here.','Try scanning the spectrum with SCAN.','The signals are hiding in the noise.','Use tune [frequency] to lock onto signals.','Three signals hide in the noise.','115.3 is far from the others.','The files are INSIDE the computer.','Not all commands are in the help menu.','Some things are hidden in plain sight.','What lies BENEATH the static?','The frequencies hold secrets.','Try everything. Break everything.','The truth is encoded in the transmission.'];const h=hints[Math.floor(Math.random()*hints.length)];printLine(h,'ghost')},800)},
  donut:()=>{const popup=document.getElementById('donut-popup');const dcontent=document.getElementById('donut-content');popup.classList.add('show');WindowRegistry.discover('donut-popup');
let A=0,B=0;const iv=setInterval(()=>{const b=[];const z=[];for(let k=0;k<1760;k++){b[k]=k%80===79?'\n':' ';z[k]=0}for(let j=0;j<6.28;j+=0.07){for(let i=0;i<6.28;i+=0.02){const c=Math.sin(i),d=Math.cos(j),e=Math.sin(A),f=Math.sin(j),g=Math.cos(A),h=d+2,D=1/(c*h*e+f*g+5),l=Math.cos(i),m=Math.cos(B),n=Math.sin(B),t=c*h*g-f*e,x=Math.floor(40+30*D*(l*h*m-t*n)),y=Math.floor(12+15*D*(l*h*n+t*m)),o=x+80*y,N=Math.floor(8*((f*e-c*d*g)*m-c*d*e-f*g-l*d*n));if(y<22&&y>=0&&x>=0&&x<79&&D>z[o]){z[o]=D;b[o]='.,-~:;=!*#$@'[N>0?N:0]}}}A+=0.04;B+=0.02;dcontent.innerHTML='<pre style="color:var(--green);line-height:0.8;font-size:8px;letter-spacing:-0.5px;font-family:monospace">'+b.join('')+'</pre>';if(A>12){clearInterval(iv)}},50);printLine('Opening DONUT.EXE...','dim')},

  music:()=>{COMMANDS.player()},
  pincode:()=>{if(!state.progression.milestones.includes('SIGNAL_DISCOVERY')){playSFX('glitch_error',0.4);printLine('SECURE.EXE ‚Äî CLEARANCE INSUFFICIENT','error');setTimeout(()=>printLine('Signal analysis required first. Try "scan".','ghost'),600);return}document.getElementById('pincode-popup').classList.add('show');WindowRegistry.discover('pincode-popup');resetPin();printLine('Opening SECURE.EXE...','dim');discoverCommandGroup('pincode')},
  pin:()=>{COMMANDS.pincode()},
  snake:()=>{document.getElementById('snake-popup').classList.add('show');WindowRegistry.discover('snake-popup');initSnake();printLine('Opening SNAKE.EXE...','dim')},
  tron:()=>{document.getElementById('tron-popup').classList.add('show');WindowRegistry.discover('tron-popup');initTron();printLine('Greetings, Program.','dim')},
  sark:()=>{COMMANDS.tron()},
  mcp:()=>{COMMANDS.tron()},
  calc:()=>{document.getElementById('calc-popup').classList.add('show');WindowRegistry.discover('calc-popup');printLine('Opening CALC.EXE...','dim')},
  notepad:()=>{const np=document.getElementById('notepad-popup');const ta=document.getElementById('notepad-textarea');np.querySelector('.popup-titlebar span:first-child').textContent='üìù NOTEPAD.EXE';ta.contentEditable='true';ta.style.cursor='text';if(!ta.dataset.userContent)ta.innerHTML='Type your notes here...';np.classList.add('show');WindowRegistry.discover('notepad-popup');printLine('Opening NOTEPAD.EXE...','dim')},
  matrix:()=>{document.getElementById('matrix-popup').classList.add('show');WindowRegistry.discover('matrix-popup');startMatrix();printLine('Opening MATRIX.EXE...','dim')},
  synth:()=>{if(!state.progression.milestones.includes('DEEP_SCAN')){playSFX('glitch_error',0.4);printLine('SYNTH.EXE ‚Äî MODULE LOCKED','error');setTimeout(()=>printLine('Deeper signal analysis may activate this module.','ghost'),600);return}document.getElementById('synth-popup').classList.add('show');WindowRegistry.discover('synth-popup');initSynth();printLine('Opening SYNTH.EXE...','dim')},
  drums:()=>{if(!state.progression.milestones.includes('DEEP_SCAN')){playSFX('glitch_error',0.4);printLine('DRUMS.EXE ‚Äî MODULE LOCKED','error');setTimeout(()=>printLine('Deeper signal analysis may activate this module.','ghost'),600);return}document.getElementById('drums-popup').classList.add('show');WindowRegistry.discover('drums-popup');initDrums();printLine('Opening DRUMS.EXE...','dim')},
  pool:()=>{document.getElementById('pool-popup').classList.add('show');WindowRegistry.discover('pool-popup');Pool.init();printLine('Opening POOL.EXE... Rack \'em up.','dim')},
  billiards:()=>{COMMANDS.pool()},
  '8ball':()=>{COMMANDS.pool()},
  trippy:()=>{COMMANDS.viz()},
  status:()=>{const mNames=['BOOT','EXPLORATION','SIGNAL_DISCOVERY','DEEP_SCAN','FULL_INTERCEPT','TRANSMISSION_COMPLETE'];printLine('');printLine(`SYS:    ${state.isPlaying?'ACTIVE':'STANDBY'}`,'dim');printLine(`FMT:    ${CONFIG.format.toUpperCase()}`,'dim');printLine(`VOL:    ${Math.round(audio.volume*100)}`,'dim');printLine(`FILES:  ${CONFIG.tracks.filter(t=>t.visible||state.discovered.has(t.id)).length}/${CONFIG.tracks.length}`,'dim');printLine(`ENC:    ${CONFIG.tracks.filter(t=>t.locked&&!state.discovered.has(t.id)).length}`,state.discovered.size<CONFIG.tracks.length?'error':'dim');printLine(`SECRET: ${CONFIG.secrets.codesFound.length}/${CONFIG.secrets.totalCodes}`,'dim');printLine(`LEVEL:  ${state.progression.milestone}/5 ‚Äî ${mNames[state.progression.milestone]||'UNKNOWN'}`,'dim');printLine('')},
  cd:()=>printLine('restricted','error'),pwd:()=>printLine('/‚ñà‚ñà‚ñà/‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà/‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë','dim'),
  rm:()=>{printLine('PERMISSION DENIED','error')},
  sudo:()=>{printLine('Nice try.','error')},
  melt:()=>{meltTerminal();playSFX('glitch_corrupt',0.3)},
  matrixmelt:()=>{matrixMeltTerminal();playSFX('glitch_corrupt',0.3)},
  screensaver:()=>{startScreensaver();printLine('Activating screensaver...','dim')},
  toasters:()=>{COMMANDS.screensaver()},
  norm:()=>{printLine('','');printLine('...','dim');setTimeout(()=>{printLine('someone was here once.','ghost');setTimeout(()=>{printLine('no forwarding address.','ghost');setTimeout(()=>{printLine('only static remains.','ghost');addSecret('NORM_GONE')},1500)},1500)},800)},
  gandalf:()=>{COMMANDS.norm()},pixl:()=>{COMMANDS.norm()},
  exit:()=>printLine('There is no exit.','error'),quit:()=>printLine('You can\'t leave.','error'),
  man:()=>printLine('No manual. Try "help".','dim'),find:()=>printLine('Try "files" or "search".','dim'),
  date:()=>{printLine('TEMPORAL DATA CORRUPTED','error');printLine('LAST KNOWN: ‚ñà‚ñà/‚ñà‚ñà/‚ñà‚ñà‚ñà‚ñà','dim')},
  sfx:(a)=>{
    if(!a||!a.length){printLine('');printLine('‚îÄ‚îÄ SFX CONTROLS ‚îÄ‚îÄ','dim');printLine(`  Status: ${SFX.enabled?'ON':'OFF'}`,'dim');printLine(`  Volume: ${Math.round(SFX.volume*100)}%`,'dim');printLine('','');printLine('  sfx on        ‚Äî enable sound effects','dim');printLine('  sfx off       ‚Äî disable sound effects','dim');printLine('  sfx vol [0-100] ‚Äî set SFX volume','dim');printLine('  sfx test      ‚Äî play test sound','dim');printLine('');return}
    const sub=a[0].toLowerCase();
    if(sub==='on'){SFX.enabled=true;printLine('SFX enabled','dim');playSFX('ui_click')}
    else if(sub==='off'){SFX.enabled=false;printLine('SFX disabled','dim')}
    else if(sub==='vol'||sub==='volume'){const v=parseInt(a[1]);if(isNaN(v)||v<0||v>100){printLine('Usage: sfx vol [0-100]','error');return}SFX.setVolume(v/100);printLine(`SFX volume: ${v}%`,'dim');playSFX('ui_click')}
    else if(sub==='test'){printLine('Playing test sound...','dim');playSFX('ui_click')}
    else{printLine(`Unknown sfx command: ${sub}`,'error')}
  },
  backup:()=>{
    const saveData={version:1,player:'RCPlayer',timestamp:new Date().toISOString(),localStorage:{},session:{secrets:[...CONFIG.secrets.codesFound],discovered:[...state.discovered],headerRevealed:state.headerRevealed,discoveredCommands:{...state.discoveredCommands},progression:{...state.progression}}}
    for(let i=0;i<localStorage.length;i++){const k=localStorage.key(i);if(k.startsWith(CONFIG.storage.prefix))saveData.localStorage[k]=localStorage.getItem(k)}
    const blob=new Blob([JSON.stringify(saveData,null,2)],{type:'application/json'})
    const url=URL.createObjectURL(blob)
    const a=document.createElement('a');a.href=url;a.download=`rcplayer-backup-${new Date().toISOString().slice(0,10)}.json`;a.click();URL.revokeObjectURL(url)
    printLine('BACKUP SAVED','dim');printLine(`  Secrets: ${saveData.session.secrets.length}/${CONFIG.secrets.totalCodes}`,'ghost');printLine(`  Tracks: ${saveData.session.discovered.length} unlocked`,'ghost')
  },
  restore:()=>{
    const fi=document.getElementById('restore-file-input')
    fi.onchange=(e)=>{const file=e.target.files[0];if(!file)return;const reader=new FileReader();reader.onload=(ev)=>{try{
      const data=JSON.parse(ev.target.result)
      if(!data.version||data.player!=='RCPlayer'){printLine('INVALID BACKUP FILE','error');return}
      if(data.localStorage)Object.entries(data.localStorage).forEach(([k,v])=>localStorage.setItem(k,v))
      if(data.session){
        if(data.session.secrets)data.session.secrets.forEach(s=>{if(!CONFIG.secrets.codesFound.includes(s))CONFIG.secrets.codesFound.push(s)})
        if(data.session.discovered)data.session.discovered.forEach(d=>state.discovered.add(d))
        if(data.session.headerRevealed)revealHeader()
        if(data.session.discoveredCommands)Object.assign(state.discoveredCommands,data.session.discoveredCommands)
        if(data.session.progression)Object.assign(state.progression,data.session.progression)
      }
      localStorage.setItem(CONFIG.storage.secrets,JSON.stringify(CONFIG.secrets.codesFound))
      localStorage.setItem(CONFIG.storage.discovered,JSON.stringify([...state.discovered]))
      localStorage.setItem(CONFIG.storage.discoveredCmds,JSON.stringify(state.discoveredCommands))
      recalculateMilestones()
      updateSidebarStatus()
      if(document.getElementById('player-popup').classList.contains('show'))renderPlayerTracks()
      printLine('BACKUP RESTORED','warning');printLine(`  Secrets: ${CONFIG.secrets.codesFound.length}/${CONFIG.secrets.totalCodes}`,'ghost');printLine(`  Tracks: ${state.discovered.size} unlocked`,'ghost')
      playSFX('scanner_lock',0.5)
    }catch(err){printLine('RESTORE FAILED ‚Äî invalid file format','error')}};reader.readAsText(file);fi.value=''}
    fi.click();printLine('Select backup file...','dim')
  },
  resetdata:(a)=>{
    if(a&&a[0]==='confirm'){
      const keys=[];for(let i=0;i<localStorage.length;i++){const k=localStorage.key(i);if(k.startsWith(CONFIG.storage.prefix))keys.push(k)}
      keys.forEach(k=>localStorage.removeItem(k))
      CONFIG.secrets.codesFound.length=0;state.discovered.clear();state.headerRevealed=false;state.discoveredCommands={scanner:false,decode:false,pincode:false,gallery:false};state.progression={milestone:0,milestones:[],filesRead:[],signalsLocked:0,tracksUnlocked:0,pinsEntered:[],breadcrumbsSeen:[]}
      updateSidebarStatus()
      printLine('ALL DATA ERASED','error');playSFX('glitch_corrupt',0.5)
    }else{printLine('WARNING: This will erase all saved progress.','error');printLine('Type "resetdata confirm" to proceed.','warning')}
  },
};

// ‚ïê‚ïê‚ïê FUZZY MATCH ‚ïê‚ïê‚ïê
function fuzzyMatch(input){
  const cmds=Object.keys(COMMANDS);
  const matches=cmds.filter(c=>c.startsWith(input)&&c!==input);
  return matches.length?matches:null;
}

// ‚ïê‚ïê‚ïê PROCESS COMMAND ‚ïê‚ïê‚ïê
function processCommand(input){
  const parts=input.trim().split(/\s+/);const cmd=parts[0].toLowerCase();const args=parts.slice(1);
  printLine(`$> ${input}`,'dim');playSFX('ui_click',0.3);
  if(COMMANDS[cmd]){COMMANDS[cmd](args)}
  else if(cmd===''){}
  else{
    const matchTrack=CONFIG.tracks.find(t=>t.unlockCode&&t.unlockCode.toLowerCase()===cmd);
    if(matchTrack)unlockTrack(matchTrack.id);
    else{
      const fuzzy=fuzzyMatch(cmd);
      if(fuzzy&&fuzzy.length>0){printLine(`Unknown command. Did you mean: ${fuzzy.join(', ')}?`,'warning')}
      else{playSFX('glitch_error',0.4);
        printLine(`Unknown command: ${cmd}`,'error');
        setTimeout(()=>printLine('Try "help" to see available commands.','ghost'),1000);
      }
    }
  }
}

// ‚ïê‚ïê‚ïê HEADER ‚ïê‚ïê‚ïê
function revealHeader(){if(state.headerRevealed)return;state.headerRevealed=true;const t=document.querySelector('#header .title');t.setAttribute('data-text','R3DACT3D://SYS');t.textContent='R3DACT3D://SYS';document.getElementById('prompt').textContent='RDCTD>';document.getElementById('prompt').style.color='var(--green)';document.getElementById('bg-env').style.opacity='.3'}

// ‚ïê‚ïê‚ïê AUDIO ‚ïê‚ïê‚ïê
function playTrackByIndex(i){if(i<0||i>=CONFIG.tracks.length)return;const t=CONFIG.tracks[i];if(t.locked&&!state.discovered.has(t.id)){playSFX('glitch_error',0.5);printLine('ACCESS DENIED','error');return}state.currentTrack=i;const f=CONFIG.format==='mp3'?t.file_mp3:t.file_wav;audio.src=CONFIG.audioPath+f;audio.play().then(()=>{state.isPlaying=true;updatePlayerUI();printLine(`‚ñ∂ ${t.id} :: ${t.title}`,'dim')}).catch(()=>printLine(`ERR: ${f} ‚Äî file not found`,'error'))}
function togglePlay(){if(state.currentTrack<0)return;if(state.isPlaying){audio.pause();state.isPlaying=false}else{audio.play();state.isPlaying=true}updatePlayerUI()}
function stopTrack(){audio.pause();audio.currentTime=0;state.isPlaying=false;state.currentTrack=-1;updatePlayerUI();const bar=document.getElementById('player-progress-bar');if(bar)bar.style.width='0%';const te=document.getElementById('player-time');if(te)te.textContent='0:00';const de=document.getElementById('player-duration');if(de)de.textContent='0:00'}
function nextTrack(){let n=state.currentTrack+1;while(n<CONFIG.tracks.length){const t=CONFIG.tracks[n];if((t.visible||state.discovered.has(t.id))&&(!t.locked||state.discovered.has(t.id)))break;n++}if(n>=CONFIG.tracks.length)n=0;playTrackByIndex(n)}
function prevTrack(){let p=state.currentTrack-1;while(p>=0){const t=CONFIG.tracks[p];if((t.visible||state.discovered.has(t.id))&&(!t.locked||state.discovered.has(t.id)))break;p--}if(p<0)p=CONFIG.tracks.length-1;playTrackByIndex(p)}
function seekTrack(e){if(audio.duration){const r=(e.currentTarget||e.target).getBoundingClientRect();audio.currentTime=((e.clientX-r.left)/r.width)*audio.duration}}
function setVolume(v){audio.volume=v/100}
function toggleFormat(){CONFIG.format=CONFIG.format==='mp3'?'wav':'mp3';if(state.currentTrack>=0&&state.isPlaying){const ct=audio.currentTime;const t=CONFIG.tracks[state.currentTrack];audio.src=CONFIG.audioPath+(CONFIG.format==='mp3'?t.file_mp3:t.file_wav);audio.currentTime=ct;audio.play()}printLine(`Format: ${CONFIG.format.toUpperCase()}`,'dim')}

// ‚ïê‚ïê‚ïê SECRETS ‚ïê‚ïê‚ïê
function unlockTrack(id){const t=CONFIG.tracks.find(x=>x.id===id);if(!t||state.discovered.has(id)){printLine('already decrypted','dim');return}playSFX('glitch_corrupt',0.5);state.discovered.add(id);localStorage.setItem(CONFIG.storage.discovered,JSON.stringify([...state.discovered]));addSecret(`UNLOCK_${id}`);printLine('');printLine('DECRYPTION KEY ACCEPTED','warning');setTimeout(()=>{printLine(`  ${id} :: ${t.title}`,'');printLine('')},400);if(document.getElementById('player-popup').classList.contains('show')){renderPlayerTracks()}state.progression.tracksUnlocked=state.discovered.size;checkProgression()}
function addSecret(id){if(!CONFIG.secrets.codesFound.includes(id)){CONFIG.secrets.codesFound.push(id);localStorage.setItem(CONFIG.storage.secrets,JSON.stringify(CONFIG.secrets.codesFound));localStorage.setItem(CONFIG.storage.discovered,JSON.stringify([...state.discovered]));playSFX('retro_movie',0.4);unlockGalleryImage(id);const c=document.getElementById('conn-status');c.textContent=`‚ñ† ${CONFIG.secrets.codesFound.length}`;c.style.color='var(--amber)';setTimeout(()=>{c.style.color='';c.textContent='‚ñ†'},2000);updateSidebarStatus();if(CONFIG.secrets.codesFound.length===CONFIG.secrets.totalCodes){setTimeout(()=>{playSFX('glitch_heavy',0.4);printLine('');printLine('‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà','error');setTimeout(()=>{printLine('  TRANSMISSION COMPLETE','error');printLine('  ALL SIGNALS RECOVERED','error');printLine('‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà','error');revealHeader();updateSidebarStatus()},500)},800)}}}

// ‚ïê‚ïê‚ïê PROGRESSION ‚ïê‚ïê‚ïê
const MILESTONE_REWARDS={
  EXPLORATION:()=>{
    setTimeout(()=>{
      printLine('','');
      printLine('[ SYSTEM NOTICE ]','warning');
      printLine('Anomalous RF activity detected on local spectrum.','dim');
      printLine('SCANNER.EXE is available. Type "scan" to investigate.','ghost');
    },2000)
  },
  SIGNAL_DISCOVERY:()=>{
    setTimeout(()=>{
      printLine('','');
      printLine('[ INTERCEPTED FRAGMENT ]','warning');
      printLine('...more signals hide in the noise...','ghost');
      printLine('...and the old access codes still work...','ghost');
      printLine('Type "pincode" if you find one.','dim');
    },3000)
  },
  DEEP_SCAN:()=>{
    setTimeout(()=>{
      printLine('','');
      printLine('[ DATA CORRUPTION WARNING ]','error');
      printLine('Encrypted payload integrity degrading.','dim');
      printLine('Expedite decryption of remaining signals.','dim');
      printLine('','');
      printLine('New file detected: transmission.log','ghost');
    },2000)
  },
  FULL_INTERCEPT:()=>{
    setTimeout(()=>{
      printLine('','');
      printLine('‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà','warning');
      printLine('  ALL ENCRYPTED PAYLOADS DECRYPTED','warning');
      printLine('  Bonus gallery content unlocked.','warning');
      printLine('  But the transmission is not yet complete...','ghost');
      printLine('‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà','warning');
      document.getElementById('bg-env').style.opacity='.3'
    },1500)
  }
}

function advanceMilestone(id){
  if(state.progression.milestones.includes(id))return
  state.progression.milestones.push(id)
  state.progression.milestone=state.progression.milestones.length
  playSFX('scanner_lock',0.5)
  if(MILESTONE_REWARDS[id])MILESTONE_REWARDS[id]()
  persistProgression()
}

function checkProgression(){
  const p=state.progression
  if(!p.milestones.includes('EXPLORATION')&&p.filesRead.length>0){
    advanceMilestone('EXPLORATION')
  }
  if(!p.milestones.includes('SIGNAL_DISCOVERY')&&(p.signalsLocked>=1||p.tracksUnlocked>=1)){
    advanceMilestone('SIGNAL_DISCOVERY')
  }
  if(!p.milestones.includes('DEEP_SCAN')&&(p.signalsLocked>=2||p.pinsEntered.length>=1||p.tracksUnlocked>=2)){
    advanceMilestone('DEEP_SCAN')
  }
  if(!p.milestones.includes('FULL_INTERCEPT')&&p.tracksUnlocked>=3){
    advanceMilestone('FULL_INTERCEPT')
  }
  persistProgression()
}

// ‚ïê‚ïê‚ïê EFFECTS ‚ïê‚ïê‚ïê

function meltTerminal(){
  const lines = Array.from(output.querySelectorAll('.line'));
  if(lines.length === 0) return;

  const meltChars = ['‚ñë','‚ñí','‚ñì','‚ñà',' '];
  const lineData = lines.map(l => {
    const text = l.textContent;
    const chars = text.split('');
    return { el: l, chars: chars, melted: new Array(chars.length).fill(0) };
  });

  // Each character gets a random delay before it starts melting
  // Bottom lines melt first (lower delay), top lines melt last
  const totalLines = lineData.length;
  lineData.forEach((ld, lineIdx) => {
    const lineDelay = ((totalLines - lineIdx) / totalLines) * 600;
    ld.chars.forEach((ch, charIdx) => {
      if(ch === ' ') { ld.melted[charIdx] = meltChars.length; return; }
      ld.startTime = lineDelay + Math.random() * 400;
    });
  });

  let elapsed = 0;
  const tick = 50;
  const meltInterval = setInterval(()=>{
    elapsed += tick;
    let allDone = true;

    lineData.forEach(ld => {
      let changed = false;
      ld.chars.forEach((ch, i) => {
        if(ld.melted[i] >= meltChars.length) return;
        const charDelay = ld.startTime + i * 8 + Math.random() * 60;
        if(elapsed < charDelay) { allDone = false; return; }

        // Advance melt stage
        if(Math.random() < 0.35) {
          ld.melted[i]++;
          ld.chars[i] = meltChars[Math.min(ld.melted[i], meltChars.length - 1)];
          changed = true;
        }
        if(ld.melted[i] < meltChars.length) allDone = false;
      });
      if(changed) ld.el.textContent = ld.chars.join('');
    });

    if(allDone) {
      clearInterval(meltInterval);
      setTimeout(()=>{ output.innerHTML = ''; }, 300);
    }
  }, tick);
}

function matrixMeltTerminal(){
  const lines = Array.from(output.querySelectorAll('.line'));
  if(lines.length === 0) return;

  const matrixChars = '„Ç¢„Ç§„Ç¶„Ç®„Ç™„Ç´„Ç≠„ÇØ„Ç±„Ç≥„Çµ„Ç∑„Çπ„Çª„ÇΩ„Çø„ÉÅ„ÉÑ„ÉÜ„Éà„Éä„Éã„Éå„Éç„Éé„Éè„Éí„Éï„Éò„Éõ„Éû„Éü„É†„É°„É¢„É§„É¶„É®„É©„É™„É´„É¨„É≠„ÉØ„É≤„É≥0123456789ABCDEF';

  // Build a 2D grid from terminal text
  const grid = lines.map(l => {
    const text = l.textContent;
    return { el: l, chars: text.split(''), original: text.split('') };
  });

  const rows = grid.length;
  if(rows === 0) return;
  const maxCols = Math.max(...grid.map(g => g.chars.length));

  // Create rain drops ‚Äî one per column, staggered start
  const drops = [];
  for(let c = 0; c < maxCols; c++){
    drops.push({
      col: c,
      row: -Math.floor(Math.random() * rows * 1.5), // staggered start above grid
      speed: 1,
      length: 4 + Math.floor(Math.random() * 6) // trail length
    });
  }

  // Track which cells have been blanked
  const blanked = Array.from({length: rows}, () => new Array(maxCols).fill(false));
  let allBlanked = false;

  const tick = 60;
  const rainInterval = setInterval(()=>{
    // Advance each drop
    drops.forEach(d => {
      d.row += d.speed;

      // Blank cells behind the trail
      const blankRow = d.row - d.length;
      if(blankRow >= 0 && blankRow < rows && d.col < grid[blankRow].chars.length){
        grid[blankRow].chars[d.col] = ' ';
        blanked[blankRow][d.col] = true;
      }

      // Scramble cells in the trail with matrix characters
      for(let t = 0; t < d.length; t++){
        const r = d.row - t;
        if(r >= 0 && r < rows && d.col < grid[r].chars.length && !blanked[r][d.col]){
          grid[r].chars[d.col] = matrixChars[Math.floor(Math.random() * matrixChars.length)];
        }
      }
    });

    // Update DOM + apply green color to active trail chars
    grid.forEach((g, rowIdx) => {
      let html = '';
      g.chars.forEach((ch, colIdx) => {
        if(blanked[rowIdx][colIdx]){
          html += ' ';
        } else {
          // Check if this cell is in any drop's trail
          let inTrail = false;
          let isHead = false;
          for(const d of drops){
            if(d.col === colIdx && rowIdx <= d.row && rowIdx > d.row - d.length){
              inTrail = true;
              if(rowIdx === d.row) isHead = true;
              break;
            }
          }
          if(isHead){
            html += `<span style="color:#fff;text-shadow:0 0 8px #0f0">${ch}</span>`;
          } else if(inTrail){
            html += `<span style="color:#0f0">${ch}</span>`;
          } else {
            // Escape HTML
            html += ch.replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;');
          }
        }
      });
      g.el.innerHTML = html;
    });

    // Check if all cells blanked
    allBlanked = blanked.every(row => {
      return row.every((b, c) => {
        // Only check columns that had content
        const lineRow = grid[blanked.indexOf(row)];
        return c >= lineRow.original.length || lineRow.original[c] === ' ' || b;
      });
    });

    // Simpler check: all drops past the bottom
    const allPast = drops.every(d => d.row - d.length >= rows);

    if(allPast){
      clearInterval(rainInterval);
      setTimeout(()=>{ output.innerHTML = ''; }, 200);
    }
  }, tick);
}

// Screensaver ‚Äî corrupted flying toasters
let screensaverActive = false;
let screensaverAnim = null;
let screensaverIdleTimer = null;
const SCREENSAVER_IDLE = 120000; // 2 minutes

const TOASTER_ART = [
  '  ‚ïî‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïó  ',
  '  ‚ïë ‚ñà‚ñà‚ñà‚ñà ‚ïë  ',
  '  ‚ïë ‚ñà‚ñà‚ñà‚ñà ‚ïë  ',
  '  ‚ïö‚ïê‚ïê‚ï§‚ï§‚ïê‚ïê‚ïù  ',
  '    ‚îå‚îò‚îî‚îê    ',
  '    ‚îî‚îÄ‚îÄ‚îò    '
];

const TOAST_ART = [
  '  ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îê ',
  '  ‚îÇ‚ñë‚ñë‚ñë‚ñë‚îÇ ',
  '  ‚îÇ‚ñë‚ñë‚ñë‚ñë‚îÇ ',
  '  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îò '
];

function startScreensaver(){
  if(screensaverActive) return;
  screensaverActive = true;

  const overlay = document.getElementById('screensaver-overlay');
  const canvas = document.getElementById('screensaver-canvas');
  overlay.classList.add('active');
  canvas.width = window.innerWidth;
  canvas.height = window.innerHeight;
  const ctx = canvas.getContext('2d');

  // Spawn toasters and toast
  const objects = [];
  const spawnCount = Math.floor((canvas.width * canvas.height) / 80000) + 4;

  for(let i = 0; i < spawnCount; i++){
    const isToast = Math.random() < 0.35;
    objects.push({
      x: Math.random() * (canvas.width + 400) - 200,
      y: -Math.random() * canvas.height - 100,
      speed: 0.5 + Math.random() * 1.5,
      drift: -0.3 - Math.random() * 0.8,
      art: isToast ? TOAST_ART : TOASTER_ART,
      glitchTimer: 0,
      glitched: false,
      alpha: 0.6 + Math.random() * 0.4,
      hue: isToast ? 40 : 120 // toast=amber, toaster=green
    });
  }

  // Corruption particles
  const particles = [];

  function render(){
    ctx.fillStyle = '#000';
    ctx.fillRect(0, 0, canvas.width, canvas.height);

    // Occasional scanlines
    if(Math.random() < 0.3){
      ctx.fillStyle = 'rgba(0,255,65,0.015)';
      for(let y = 0; y < canvas.height; y += 3){
        ctx.fillRect(0, y, canvas.width, 1);
      }
    }

    objects.forEach(obj => {
      // Move
      obj.y += obj.speed;
      obj.x += obj.drift;

      // Wrap around
      if(obj.y > canvas.height + 100){
        obj.y = -120;
        obj.x = Math.random() * (canvas.width + 200) - 100;
      }
      if(obj.x < -200) obj.x = canvas.width + 50;

      // Random glitch
      obj.glitchTimer--;
      if(Math.random() < 0.005){
        obj.glitched = true;
        obj.glitchTimer = 5 + Math.floor(Math.random() * 15);
      }
      if(obj.glitchTimer <= 0) obj.glitched = false;

      // Draw
      const color = obj.hue === 120
        ? `rgba(0,255,65,${obj.alpha})`
        : `rgba(255,180,40,${obj.alpha})`;

      ctx.font = '12px monospace';
      ctx.fillStyle = color;

      if(obj.glitched){
        // Glitched: offset, wrong chars, color shift
        ctx.fillStyle = Math.random() < 0.5
          ? `rgba(255,0,64,${obj.alpha})`
          : `rgba(0,170,255,${obj.alpha})`;
        obj.art.forEach((line, i) => {
          const corrupted = line.split('').map(ch =>
            Math.random() < 0.4 ? String.fromCharCode(0x2580 + Math.floor(Math.random() * 32)) : ch
          ).join('');
          const offsetX = (Math.random() - 0.5) * 8;
          ctx.fillText(corrupted, obj.x + offsetX, obj.y + i * 14);
        });

        // Spawn corruption particle
        if(Math.random() < 0.3){
          particles.push({
            x: obj.x + Math.random() * 80,
            y: obj.y + Math.random() * 60,
            char: String.fromCharCode(0x2580 + Math.floor(Math.random() * 32)),
            life: 20 + Math.floor(Math.random() * 30),
            vy: -0.5 - Math.random()
          });
        }
      } else {
        // Normal draw with subtle shadow
        ctx.shadowBlur = 3;
        ctx.shadowColor = color;
        obj.art.forEach((line, i) => {
          ctx.fillText(line, obj.x, obj.y + i * 14);
        });
        ctx.shadowBlur = 0;
      }
    });

    // Draw and update particles
    particles.forEach((p, idx) => {
      p.life--;
      p.y += p.vy;
      p.x += (Math.random() - 0.5) * 2;
      const a = p.life / 50;
      ctx.fillStyle = `rgba(0,255,65,${a})`;
      ctx.font = '10px monospace';
      ctx.fillText(p.char, p.x, p.y);
    });

    // Remove dead particles
    for(let i = particles.length - 1; i >= 0; i--){
      if(particles[i].life <= 0) particles.splice(i, 1);
    }

    // Rare full-screen glitch band
    if(Math.random() < 0.01){
      const bandY = Math.random() * canvas.height;
      const bandH = 2 + Math.random() * 20;
      ctx.fillStyle = 'rgba(255,0,64,0.08)';
      ctx.fillRect(0, bandY, canvas.width, bandH);
      // Shift a strip
      const imgData = ctx.getImageData(0, bandY, canvas.width, Math.min(bandH, 10));
      ctx.putImageData(imgData, Math.floor((Math.random() - 0.5) * 30), bandY);
    }

    if(screensaverActive){
      screensaverAnim = requestAnimationFrame(render);
    }
  }

  screensaverAnim = requestAnimationFrame(render);

  // Dismiss on any input
  const dismiss = () => {
    stopScreensaver();
    document.removeEventListener('keydown', dismiss);
    document.removeEventListener('click', dismiss);
    document.removeEventListener('mousemove', dismissMouse);
  };
  let mouseMoveTolerance = 0;
  const dismissMouse = () => {
    mouseMoveTolerance++;
    if(mouseMoveTolerance > 3) dismiss(); // ignore tiny jitter
  };
  setTimeout(()=>{
    document.addEventListener('keydown', dismiss);
    document.addEventListener('click', dismiss);
    document.addEventListener('mousemove', dismissMouse);
  }, 500); // brief delay so triggering keypress doesn't immediately dismiss
}

function stopScreensaver(){
  screensaverActive = false;
  if(screensaverAnim) cancelAnimationFrame(screensaverAnim);
  document.getElementById('screensaver-overlay').classList.remove('active');
  HintEngine.lastActivity = Date.now();
}

function initScreensaverIdle(){
  // Check every 15 seconds if idle long enough for screensaver
  screensaverIdleTimer = setInterval(()=>{
    if(!state || !state.bootComplete || screensaverActive) return;
    const idle = Date.now() - HintEngine.lastActivity;
    if(idle >= SCREENSAVER_IDLE){
      startScreensaver();
    }
  }, 15000);
}



// ‚ïê‚ïê‚ïê AUDIO EVENTS ‚ïê‚ïê‚ïê
audio.addEventListener('ended',()=>nextTrack());

// ‚ïê‚ïê‚ïê UTILITIES ‚ïê‚ïê‚ïê
function fmtTime(s){return Math.floor(s/60)+':'+String(Math.floor(s%60)).padStart(2,'0')}
function generateSessionId(){document.getElementById('session-id').textContent='SES-'+Math.random().toString(36).substring(2,6).toUpperCase()}
function startClock(){setInterval(()=>{const n=new Date();document.getElementById('clock').textContent=String(n.getHours()).padStart(2,'0')+':'+String(n.getMinutes()).padStart(2,'0')+':'+String(n.getSeconds()).padStart(2,'0')},1000)}

// ‚ïê‚ïê‚ïê INPUT ‚ïê‚ïê‚ïê
cmdInput.addEventListener('keydown',(e)=>{
  if(e.key==='Enter'){const v=cmdInput.value;if(v.trim()){state.commandHistory.push(v);state.historyIndex=state.commandHistory.length}processCommand(v);cmdInput.value=''}
  else if(e.key==='ArrowUp'){e.preventDefault();if(state.historyIndex>0){state.historyIndex--;cmdInput.value=state.commandHistory[state.historyIndex]}}
  else if(e.key==='ArrowDown'){e.preventDefault();if(state.historyIndex<state.commandHistory.length-1){state.historyIndex++;cmdInput.value=state.commandHistory[state.historyIndex]}else{state.historyIndex=state.commandHistory.length;cmdInput.value=''}}
  else if(e.key==='Tab'){e.preventDefault();const p=cmdInput.value.toLowerCase();const cmds=Object.keys(COMMANDS);const m=cmds.filter(c=>c.startsWith(p));if(m.length===1)cmdInput.value=m[0];else if(m.length>1&&p.length>0){printLine(`$> ${p}`,'dim');printLine(m.join('  '),'dim')}}
});

// Global focus
document.addEventListener('keydown',(e)=>{if(!state.bootComplete||!state.welcomeDismissed)return;if(e.target===cmdInput)return;if(['Tab','Shift','Control','Alt','Meta','ArrowUp','ArrowDown','ArrowLeft','ArrowRight'].includes(e.key))return;if(e.target.tagName==='TEXTAREA'||e.target.tagName==='INPUT'||e.target.contentEditable==='true')return;cmdInput.focus()});
document.addEventListener('click',(e)=>{if(state.welcomeDismissed&&!e.target.closest('button')&&!e.target.closest('input[type="range"]')&&!e.target.closest('.track-entry')&&!e.target.closest('.ghost-text')&&!e.target.closest('#notepad-textarea')&&!e.target.closest('textarea')&&!e.target.closest('input')&&e.target.contentEditable!=='true')cmdInput.focus()});

// Konami
const KONAMI=['ArrowUp','ArrowUp','ArrowDown','ArrowDown','ArrowLeft','ArrowRight','ArrowLeft','ArrowRight','b','a'];let ks=[];
document.addEventListener('keydown',(e)=>{if(!state.welcomeDismissed)return;ks.push(e.key);if(ks.length>KONAMI.length)ks.shift();if(ks.join(',')===KONAMI.join(',')){playSFX('retro_movie',0.6);printLine('');printLine('‚ñì‚ñì‚ñì CHEAT CODE ‚ñì‚ñì‚ñì','error');setTimeout(()=>{printLine('Cheating won\'t help you here.','ghost');printLine('...or will it?','ghost')},500);addSecret('KONAMI');ks=[]}});
document.addEventListener('dblclick',(e)=>{if(e.target.classList.contains('redact-block')){e.target.classList.add('cracked');addSecret('REDACT_CRACK')}});

audio.volume=CONFIG.defaultVolume;

// ‚ïê‚ïê‚ïê INIT ‚ïê‚ïê‚ïê
window.addEventListener('load',()=>{initWelcomeScreen()});


// ‚ïê‚ïê‚ïê FREQUENCY SCANNER SYSTEM ‚ïê‚ïê‚ïê
let scannerState = {
  // Core
  currentFreq: 97.7,
  radarCanvas: null,
  radarCtx: null,
  noiseCanvas: null,
  noiseCtx: null,

  // Scanner parameters (control cursor position)
  frequency: 97.7,
  amplitude: 50,

  // Signal proximity tracking
  closestSignalProximity: 0,

  // Ping system
  isPinging: false,
  pingWaves: [],
  activeBlips: [],  // Temporary blips with fade timers
  foundSignals: [],

  // Signal locking
  lockableSignal: null,     // Signal ready to be locked
  lockedSignals: [],        // All locked signals (persistent)

  // Radar sweep
  sweepAngle: 0,

  // Knob dragging
  draggingKnob: null,
  lastMouseAngle: 0
};

const SIGNAL_FREQUENCIES = [
  {
    freq: 97.7,
    amplitude: 70,  // Required amplitude
    tolerance: {freq: 1.5, amp: 12},  // Tighter tolerance for harder gameplay
    name: 'SIGNAL',
    code: 'SIGNAL',
    description: 'Strong encrypted carrier'
  },
  {
    freq: 108.0,
    amplitude: 85,
    tolerance: {freq: 1.5, amp: 12},
    name: 'BENEATH',
    code: 'BENEATH',
    description: 'Sub-audible transmission'
  },
  {
    freq: 115.3,
    amplitude: 45,
    tolerance: {freq: 2.0, amp: 15},  // Slightly more forgiving for harder-to-find signal
    name: 'VOID',
    code: 'VOID',
    description: 'Anomalous data stream'
  }
];

function initScanner() {
  scannerState.radarCanvas = document.getElementById('radar-canvas');
  if(!scannerState.radarCanvas) return
  scannerState.radarCtx = scannerState.radarCanvas.getContext('2d');

  scannerState.noiseCanvas = document.getElementById('noise-canvas');
  if(!scannerState.noiseCanvas) return
  scannerState.noiseCtx = scannerState.noiseCanvas.getContext('2d');

  // Add click handler to radar canvas
  scannerState.radarCanvas.addEventListener('click', handleRadarClick);

  drawRadar();
  drawNoiseVisualization();

  // Animate radar and noise continuously ‚Äî store ID so we can clear on close
  if(scannerState.animInterval) clearInterval(scannerState.animInterval);
  scannerState.animInterval = setInterval(() => {
    drawRadar();
    animatePingWaves();
    drawNoiseVisualization();
  }, 50);
}

function stopScanner() {
  if(scannerState.animInterval) {
    clearInterval(scannerState.animInterval);
    scannerState.animInterval = null;
  }
}

function tuneToFrequency(freq) {
  const signal = SIGNAL_FREQUENCIES.find(s => s.freq === freq);
  if(!signal) return;

  playSFX('glitch_heavy',0.4);
  updateScannerStatus('Locking onto ' + freq.toFixed(1) + ' MHz...', CONFIG.colors.amber);

  setTimeout(() => {
    updateScannerStatus('‚ñà‚ñì‚ñí‚ñë SIGNAL ACQUIRED ‚ñë‚ñí‚ñì‚ñà', CONFIG.colors.green);
    playSFX('scanner_lock',0.6);
    printLine('');
    printLine('FREQUENCY LOCKED: ' + freq.toFixed(1) + ' MHz', 'warning');
    setTimeout(() => {
      printLine('Decryption key extracted:', 'dim');
      printLine('  ‚Üí ' + signal.code.toLowerCase(), '');
      printLine('');
      printLine('Use "decode ' + signal.code.toLowerCase() + '" to unlock encrypted file.', 'dim');
      addSecret('TUNE_' + signal.code);
      

      // Special message for VOID signal
      if(signal.code === 'VOID') {
        setTimeout(() => {
          printLine('');
          printLine('WARNING: ANOMALOUS SIGNAL DETECTED', 'error');
          printLine('This frequency should not exist...', 'ghost');
          printLine('');
          addSecret('VOID_FREQUENCY');
        }, 1000);
      }
    }, 400);
  }, 800);
}

function updateScannerStatus(message, color) {
  const status = document.getElementById('scanner-status');
  status.textContent = message;
  status.style.color = color;
}

// ‚ïê‚ïê‚ïê RADAR DISPLAY ‚ïê‚ïê‚ïê
function drawRadar() {
  if(!scannerState.radarCtx) return;

  const ctx = scannerState.radarCtx;
  const canvas = scannerState.radarCanvas;
  const centerX = canvas.width / 2;
  const centerY = canvas.height / 2;
  const radius = Math.min(centerX, centerY) - 10;

  // Fade previous frame (trail effect)
  ctx.fillStyle = 'rgba(0,0,0,0.15)';
  ctx.fillRect(0, 0, canvas.width, canvas.height);

  // Grid circles
  ctx.strokeStyle = 'rgba(0,255,65,0.15)';
  ctx.lineWidth = 1;
  for(let i = 1; i <= 4; i++) {
    ctx.beginPath();
    ctx.arc(centerX, centerY, (radius / 4) * i, 0, Math.PI * 2);
    ctx.stroke();
  }

  // Grid lines
  ctx.strokeStyle = 'rgba(0,255,65,0.1)';
  for(let i = 0; i < 8; i++) {
    const angle = (Math.PI * 2 / 8) * i;
    ctx.beginPath();
    ctx.moveTo(centerX, centerY);
    ctx.lineTo(
      centerX + Math.cos(angle) * radius,
      centerY + Math.sin(angle) * radius
    );
    ctx.stroke();
  }

  // Draw ping waves
  scannerState.pingWaves.forEach((wave, idx) => {
    const alpha = 1 - (wave.radius / radius);
    ctx.strokeStyle = `rgba(0,255,65,${alpha * 0.8})`;
    ctx.lineWidth = 2;
    ctx.shadowColor = CONFIG.colors.green;
    ctx.shadowBlur = 10;
    ctx.beginPath();
    ctx.arc(centerX, centerY, wave.radius, 0, Math.PI * 2);
    ctx.stroke();
    ctx.shadowBlur = 0;

    // Draw echo returns
    wave.echoes.forEach(echo => {
      const echoAlpha = alpha * 0.6;
      ctx.fillStyle = `rgba(0,255,65,${echoAlpha})`;
      const angle = (echo.freq - 80) / 40 * Math.PI * 2 - Math.PI / 2;
      const x = centerX + Math.cos(angle) * wave.radius;
      const y = centerY + Math.sin(angle) * wave.radius;
      ctx.beginPath();
      ctx.arc(x, y, 4, 0, Math.PI * 2);
      ctx.fill();
      ctx.shadowColor = CONFIG.colors.green;
      ctx.shadowBlur = 15;
      ctx.fill();
      ctx.shadowBlur = 0;
    });
  });

  // Draw temporary blips (fade over time based on proximity)
  const now = Date.now();
  scannerState.activeBlips = scannerState.activeBlips.filter(blip => now < blip.fadeOutTime);

  scannerState.activeBlips.forEach(blip => {
    // Map signal position to radar coordinates
    const angle = ((blip.freq - 80) / 40) * Math.PI * 2 - Math.PI / 2;
    const blipRadius = (blip.amplitude / 100) * radius;
    const x = centerX + Math.cos(angle) * blipRadius;
    const y = centerY + Math.sin(angle) * blipRadius;

    // Calculate fade (0 to 1)
    const remainingTime = blip.fadeOutTime - now;
    const fadeAlpha = Math.min(1, remainingTime / 500); // Fade in last 500ms

    // Pulsing effect
    const pulseSize = 4 + Math.sin(Date.now() / 200) * 2;

    ctx.fillStyle = `rgba(255,${blip.isClose ? 255 : 100},65,${fadeAlpha * 0.8})`;
    ctx.shadowColor = blip.isClose ? '#ffff41' : CONFIG.colors.green;
    ctx.shadowBlur = 20;
    ctx.beginPath();
    ctx.arc(x, y, pulseSize, 0, Math.PI * 2);
    ctx.fill();
    ctx.shadowBlur = 0;

    // Draw ring around close blips
    if(blip.isClose) {
      ctx.strokeStyle = `rgba(255,255,65,${fadeAlpha * 0.5})`;
      ctx.lineWidth = 2;
      ctx.beginPath();
      ctx.arc(x, y, pulseSize + 5, 0, Math.PI * 2);
      ctx.stroke();
    }
  });

  // Draw all locked signal markers (persistent)
  scannerState.lockedSignals.forEach(sig => {
    const angle = ((sig.freq - 80) / 40) * Math.PI * 2 - Math.PI / 2;
    const blipRadius = (sig.amplitude / 100) * radius;
    const x = centerX + Math.cos(angle) * blipRadius;
    const y = centerY + Math.sin(angle) * blipRadius;

    // Pulsing yellow marker
    const pulseSize = 5 + Math.sin(Date.now() / 250) * 1.5;

    // Draw filled circle
    ctx.fillStyle = 'rgba(255,255,100,0.9)';
    ctx.shadowColor = '#ffff00';
    ctx.shadowBlur = 20;
    ctx.beginPath();
    ctx.arc(x, y, pulseSize, 0, Math.PI * 2);
    ctx.fill();
    ctx.shadowBlur = 0;

    // Draw ring
    ctx.strokeStyle = 'rgba(255,255,100,0.7)';
    ctx.lineWidth = 2;
    ctx.beginPath();
    ctx.arc(x, y, pulseSize + 6, 0, Math.PI * 2);
    ctx.stroke();

    // Draw crosshair over locked signal
    ctx.strokeStyle = 'rgba(255,255,100,0.6)';
    ctx.lineWidth = 1;
    const markSize = 10;
    ctx.beginPath();
    ctx.moveTo(x - markSize, y);
    ctx.lineTo(x + markSize, y);
    ctx.moveTo(x, y - markSize);
    ctx.lineTo(x, y + markSize);
    ctx.stroke();
  });

  // Draw cursor (player's current freq/amp position)
  const cursorAngle = ((scannerState.frequency - 80) / 40) * Math.PI * 2 - Math.PI / 2;
  const cursorRadius = (scannerState.amplitude / 100) * radius;
  const cursorX = centerX + Math.cos(cursorAngle) * cursorRadius;
  const cursorY = centerY + Math.sin(cursorAngle) * cursorRadius;

  // Crosshair cursor
  ctx.strokeStyle = 'rgba(255,100,100,0.8)';
  ctx.lineWidth = 2;
  const crossSize = 8;

  // Horizontal line
  ctx.beginPath();
  ctx.moveTo(cursorX - crossSize, cursorY);
  ctx.lineTo(cursorX + crossSize, cursorY);
  ctx.stroke();

  // Vertical line
  ctx.beginPath();
  ctx.moveTo(cursorX, cursorY - crossSize);
  ctx.lineTo(cursorX, cursorY + crossSize);
  ctx.stroke();

  // Cursor center dot
  ctx.fillStyle = 'rgba(255,100,100,0.9)';
  ctx.beginPath();
  ctx.arc(cursorX, cursorY, 3, 0, Math.PI * 2);
  ctx.fill();

  // Sweep line (rotating radar arm)
  scannerState.sweepAngle += 0.02;
  const gradient = ctx.createLinearGradient(
    centerX, centerY,
    centerX + Math.cos(scannerState.sweepAngle) * radius,
    centerY + Math.sin(scannerState.sweepAngle) * radius
  );
  gradient.addColorStop(0, 'rgba(0,255,65,0.5)');
  gradient.addColorStop(0.5, 'rgba(0,255,65,0.2)');
  gradient.addColorStop(1, 'rgba(0,255,65,0)');

  ctx.strokeStyle = gradient;
  ctx.lineWidth = 3;
  ctx.beginPath();
  ctx.moveTo(centerX, centerY);
  ctx.lineTo(
    centerX + Math.cos(scannerState.sweepAngle) * radius,
    centerY + Math.sin(scannerState.sweepAngle) * radius
  );
  ctx.stroke();

  // Center dot with glow
  ctx.fillStyle = CONFIG.colors.green;
  ctx.shadowColor = CONFIG.colors.green;
  ctx.shadowBlur = 15;
  ctx.beginPath();
  ctx.arc(centerX, centerY, 4, 0, Math.PI * 2);
  ctx.fill();
  ctx.shadowBlur = 0;

  // Frequency markers
  ctx.fillStyle = 'rgba(0,255,65,0.5)';
  ctx.font = '10px monospace';
  ctx.textAlign = 'center';
  const freqs = [80, 90, 100, 110, 120];
  freqs.forEach((freq, i) => {
    const angle = (Math.PI * 2 / (freqs.length - 1)) * i - Math.PI / 2;
    const x = centerX + Math.cos(angle) * (radius + 15);
    const y = centerY + Math.sin(angle) * (radius + 15);
    ctx.fillText(freq, x, y);
  });
}

function animatePingWaves() {
  // Update ping waves
  scannerState.pingWaves = scannerState.pingWaves.filter(wave => {
    wave.radius += 3;
    const maxRadius = Math.min(scannerState.radarCanvas.width, scannerState.radarCanvas.height) / 2 - 10;
    return wave.radius < maxRadius;
  });
}

// ‚ïê‚ïê‚ïê ANIMATED SPECTROGRAM VISUALIZATION ‚ïê‚ïê‚ïê
function drawNoiseVisualization() {
  if(!scannerState.noiseCtx) return;

  const ctx = scannerState.noiseCtx;
  const canvas = scannerState.noiseCanvas;

  // Clear canvas
  ctx.fillStyle = '#000';
  ctx.fillRect(0, 0, canvas.width, canvas.height);

  // Add static/noise across entire display (like analog radio)
  const imageData = ctx.createImageData(canvas.width, canvas.height);
  for(let i = 0; i < imageData.data.length; i += 4) {
    if(Math.random() < 0.08) { // Random static pixels
      const brightness = Math.random() * 150;
      imageData.data[i] = brightness * 0.2;     // R
      imageData.data[i + 1] = brightness;       // G (greenish)
      imageData.data[i + 2] = brightness * 0.3; // B
      imageData.data[i + 3] = Math.random() * 100 + 50; // Variable alpha
    }
  }
  ctx.putImageData(imageData, 0, 0);

  // Draw baseline with slight wobble
  ctx.strokeStyle = 'rgba(0,255,65,0.25)';
  ctx.lineWidth = 1;
  ctx.beginPath();
  for(let x = 0; x < canvas.width; x++) {
    const wobble = Math.sin(x * 0.1 + Date.now() / 50) * 0.5;
    ctx.lineTo(x, canvas.height - 1 + wobble);
  }
  ctx.stroke();

  // Animated noise floor (radio static)
  const noiseOffset = Date.now() / 80;
  for(let x = 0; x < canvas.width; x += 3) {
    const noiseHeight = Math.sin(x * 0.08 + noiseOffset) * 4 + Math.random() * 6 + 3;
    const flickerAlpha = 0.1 + Math.random() * 0.08;
    ctx.fillStyle = `rgba(0,255,65,${flickerAlpha})`;
    ctx.fillRect(x, canvas.height - noiseHeight, 2, noiseHeight);
  }

  // Add interference bands (horizontal)
  if(Math.random() < 0.3) {
    const bandY = Math.random() * canvas.height;
    ctx.fillStyle = 'rgba(0,255,65,0.05)';
    ctx.fillRect(0, bandY, canvas.width, 2);
  }

  // Calculate and draw all signals based on cursor proximity
  let closestProximity = 0;
  let closestSignal = null;

  SIGNAL_FREQUENCIES.forEach(sig => {
    const freqDistance = Math.abs(scannerState.frequency - sig.freq);
    const ampDistance = Math.abs(scannerState.amplitude - sig.amplitude);

    // Normalized distance
    const normalizedFreqDist = freqDistance / 40;
    const normalizedAmpDist = ampDistance / 100;
    const distance = Math.sqrt(normalizedFreqDist ** 2 + normalizedAmpDist ** 2);

    // Proximity (0-1, closer = higher)
    const proximity = Math.max(0, 1 - (distance * 8));

    if(proximity > closestProximity) {
      closestProximity = proximity;
      closestSignal = sig;
    }

    // Calculate signal position on spectrum
    const signalX = ((sig.freq - 80) / 40) * canvas.width;

    // Signal visibility based on proximity (closer = more visible)
    const visibility = proximity;

    // Only draw if close enough OR if it's locked
    const isLocked = scannerState.lockedSignals.some(s => s.freq === sig.freq && s.amplitude === sig.amplitude);
    const shouldShow = visibility > 0.2 || isLocked;

    if(shouldShow) { // Increased threshold - signals only appear when reasonably close
      // Signal height based on proximity
      const baseHeight = canvas.height * 0.15; // Reduced base height
      const signalHeight = baseHeight + (proximity * canvas.height * 0.65);

      // Animated pulsing
      const pulse = Math.sin(Date.now() / 300 + sig.freq) * 0.1 + 0.9;
      const actualHeight = signalHeight * pulse;

      // Signal width - narrower, more dependent on proximity
      const signalWidth = 6 + (proximity * 12);

      // Color based on proximity and lock state
      let signalColor, glowColor;
      if(scannerState.lockedSignal === sig) {
        // Locked signal - bright yellow (always visible)
        signalColor = `rgba(255,255,100,1)`;
        glowColor = '#ffff00';
      } else if(proximity > 0.7) {
        // Very close - green to yellow
        signalColor = `rgba(${100 + proximity * 155},255,65,${visibility * 0.9})`;
        glowColor = CONFIG.colors.green;
      } else if(proximity > 0.45) {
        // Medium - orange
        signalColor = `rgba(255,${100 + proximity * 155},65,${visibility * 0.7})`;
        glowColor = CONFIG.colors.amber;
      } else {
        // Far - very dim green (barely visible)
        signalColor = `rgba(0,255,65,${visibility * 0.3})`;
        glowColor = CONFIG.colors.green;
      }

      // Draw signal peak with gradient and analog fuzz
      const gradient = ctx.createLinearGradient(signalX, canvas.height, signalX, canvas.height - actualHeight);
      gradient.addColorStop(0, signalColor.replace(/[\d.]+\)$/, '0.3)'));
      gradient.addColorStop(0.7, signalColor);
      gradient.addColorStop(1, signalColor);

      ctx.fillStyle = gradient;

      // Draw main peak with slight horizontal jitter (analog instability)
      const jitterX = (Math.random() - 0.5) * 1.5;
      ctx.fillRect(signalX - signalWidth/2 + jitterX, canvas.height - actualHeight, signalWidth, actualHeight);

      // Add fuzzy edges (multiple thin lines at edges)
      ctx.globalAlpha = 0.3;
      for(let i = 0; i < 3; i++) {
        const fuzzOffset = (Math.random() - 0.5) * 2;
        const fuzzWidth = signalWidth + Math.random() * 3;
        ctx.fillRect(signalX - fuzzWidth/2 + fuzzOffset, canvas.height - actualHeight, fuzzWidth, actualHeight);
      }
      ctx.globalAlpha = 1.0;

      // Glow effect only for strong signals or locked
      if(proximity > 0.5 || isLocked) {
        ctx.shadowColor = glowColor;
        ctx.shadowBlur = isLocked ? 25 : (15 * proximity);
        ctx.fillRect(signalX - signalWidth/2, canvas.height - actualHeight, signalWidth, actualHeight);
        ctx.shadowBlur = 0;
      }

      // Draw harmonics only for very close or locked signals
      if(proximity > 0.65 || isLocked) {
        const harmonicX = signalX + (signalWidth * 2.5);
        const harmonicHeight = actualHeight * 0.35;
        const harmonicAlpha = isLocked ? 0.5 : (visibility * 0.35);
        ctx.fillStyle = signalColor.replace(/[\d.]+\)$/, `${harmonicAlpha})`);
        ctx.fillRect(harmonicX - 4, canvas.height - harmonicHeight, 8, harmonicHeight);
      }
    }
  });

  scannerState.closestSignalProximity = closestProximity;

  // Update clarity text - show LOCKED only if closest signal is locked
  const clarityPercent = Math.round(closestProximity * 100);
  const clarityColor = closestProximity > 0.7 ? CONFIG.colors.green : closestProximity > 0.4 ? CONFIG.colors.amber : '#ff6666';

  // Check if closest signal is a locked one
  const isClosestLocked = closestSignal && scannerState.lockedSignals.some(s =>
    s.freq === closestSignal.freq && s.amplitude === closestSignal.amplitude
  );

  if(isClosestLocked && closestProximity > 0.3) {
    document.getElementById('signal-clarity-text').textContent = 'LOCKED';
    document.getElementById('signal-clarity-text').style.color = '#ffff00';
  } else {
    document.getElementById('signal-clarity-text').textContent = clarityPercent + '%';
    document.getElementById('signal-clarity-text').style.color = clarityColor;
  }
}

// ‚ïê‚ïê‚ïê KNOB CONTROLS ‚ïê‚ïê‚ïê
function handleKnobClick(event, knobType) {
  scannerState.draggingKnob = knobType;

  const container = event.currentTarget;
  const rect = container.getBoundingClientRect();
  const centerX = rect.left + rect.width / 2;
  const centerY = rect.top + rect.height / 2;
  const dx = event.clientX - centerX;
  const dy = event.clientY - centerY;
  scannerState.lastMouseAngle = Math.atan2(dy, dx);

  event.preventDefault();
}

// Add global mouse handlers for knob dragging
document.addEventListener('mousemove', (e) => {
  if(!scannerState.draggingKnob) return;

  const knobType = scannerState.draggingKnob;
  const container = document.getElementById(knobType + '-knob-container');
  if(!container) return;

  const rect = container.getBoundingClientRect();
  const centerX = rect.left + rect.width / 2;
  const centerY = rect.top + rect.height / 2;
  const dx = e.clientX - centerX;
  const dy = e.clientY - centerY;
  let angle = Math.atan2(dy, dx) * (180 / Math.PI);
  angle = (angle + 90 + 360) % 360;

  if(knobType === 'frequency') {
    // Map angle to frequency range 80-120 MHz
    scannerState.frequency = 80 + (angle / 360) * 40;
    document.getElementById('frequency-value').textContent = scannerState.frequency.toFixed(1) + ' MHz';
    document.getElementById('frequency-input').value = scannerState.frequency.toFixed(1);
    document.getElementById('frequency-indicator').style.transform = `translateX(-50%) rotate(${angle}deg)`;
  } else if(knobType === 'amplitude') {
    // Map angle to amplitude 0-100
    scannerState.amplitude = Math.round((angle / 360) * 100);
    document.getElementById('amplitude-value').textContent = scannerState.amplitude;
    document.getElementById('amplitude-input').value = scannerState.amplitude;
    document.getElementById('amplitude-indicator').style.transform = `translateX(-50%) rotate(${angle}deg)`;
  }
});

document.addEventListener('mouseup', () => {
  scannerState.draggingKnob = null;
});

// Manual input handlers
function setFrequencyFromInput() {
  const input = document.getElementById('frequency-input');
  let value = parseFloat(input.value);

  // Clamp value to valid range
  if(value < 80) value = 80;
  if(value > 120) value = 120;
  if(isNaN(value)) value = 97.7;

  // Update state
  scannerState.frequency = value;

  // Update displays
  input.value = value.toFixed(1);
  document.getElementById('frequency-value').textContent = value.toFixed(1) + ' MHz';

  // Update knob position
  const angle = ((value - 80) / 40) * 360;
  document.getElementById('frequency-indicator').style.transform = `translateX(-50%) rotate(${angle}deg)`;
}

function setAmplitudeFromInput() {
  const input = document.getElementById('amplitude-input');
  let value = parseInt(input.value);

  // Clamp value to valid range
  if(value < 0) value = 0;
  if(value > 100) value = 100;
  if(isNaN(value)) value = 50;

  // Update state
  scannerState.amplitude = value;

  // Update displays
  input.value = value;
  document.getElementById('amplitude-value').textContent = value;

  // Update knob position
  const angle = (value / 100) * 360;
  document.getElementById('amplitude-indicator').style.transform = `translateX(-50%) rotate(${angle}deg)`;
}

function handleRadarClick(event) {
  const canvas = scannerState.radarCanvas;
  const rect = canvas.getBoundingClientRect();

  // Get click position relative to canvas
  const clickX = event.clientX - rect.left;
  const clickY = event.clientY - rect.top;

  // Scale to actual canvas size (in case canvas is scaled by CSS)
  const scaleX = canvas.width / rect.width;
  const scaleY = canvas.height / rect.height;
  const x = clickX * scaleX;
  const y = clickY * scaleY;

  // Calculate center and radius
  const centerX = canvas.width / 2;
  const centerY = canvas.height / 2;
  const radius = Math.min(centerX, centerY) - 40;

  // Calculate distance and angle from center
  const dx = x - centerX;
  const dy = y - centerY;
  const distance = Math.sqrt(dx * dx + dy * dy);

  // Get angle using atan2 (matches how radar draws with cos/sin)
  const angle = Math.atan2(dy, dx);

  // Clamp distance to radar bounds
  const clampedDistance = Math.min(distance, radius);

  // Invert the radar drawing formula to get frequency
  // Radar draws: cursorAngle = ((freq - 80) / 40) * 2*PI - PI/2
  // So: freq = 80 + ((cursorAngle + PI/2) / (2*PI)) * 40
  let frequency = 80 + ((angle + Math.PI / 2) / (Math.PI * 2)) * 40;

  // Wrap frequency to 80-120 range (handle negative angles)
  while(frequency < 80) frequency += 40;
  while(frequency > 120) frequency -= 40;

  // Convert distance to amplitude (0-100)
  const amplitude = (clampedDistance / radius) * 100;

  // Update scanner state
  scannerState.frequency = Math.max(80, Math.min(120, frequency));
  scannerState.amplitude = Math.max(0, Math.min(100, amplitude));

  // Update frequency display and input
  document.getElementById('frequency-value').textContent = scannerState.frequency.toFixed(1) + ' MHz';
  document.getElementById('frequency-input').value = scannerState.frequency.toFixed(1);

  // Update amplitude display and input
  document.getElementById('amplitude-value').textContent = Math.round(scannerState.amplitude);
  document.getElementById('amplitude-input').value = Math.round(scannerState.amplitude);

  // Update knob positions
  const freqAngle = ((scannerState.frequency - 80) / 40) * 360;
  const ampAngle = (scannerState.amplitude / 100) * 360;
  document.getElementById('frequency-indicator').style.transform = `translateX(-50%) rotate(${freqAngle}deg)`;
  document.getElementById('amplitude-indicator').style.transform = `translateX(-50%) rotate(${ampAngle}deg)`;
}

function toggleWindow(windowId) {
  // Check if radar is locked
  if(windowId === 'radar-popup' && !state.radarUnlocked) {
    printLine('RADAR LOCKED - Complete scanner calibration first', 'error');
    playSFX('glitch_error',0.4);
    return;
  }

  const el = document.getElementById(windowId);
  if(el.classList.contains('show')) {
    el.classList.remove('show');
    playSFX('ui_click',0.3);
    if(windowId === 'player-popup') stopTrack();
  } else {
    el.classList.add('show');
    playSFX('ui_click',0.4);
    WindowRegistry.discover(windowId);
    if(windowId === 'player-popup') initPlayerPopup();
  }
  WindowRegistry.updateIndicators();
}

function sendPing() {
  if(scannerState.isPinging) return;

  scannerState.isPinging = true;
  playSFX('scanner_ping',0.6);
  updateScannerStatus('PING SENT - Scanning...', 'var(--green)');

  // Create new ping wave
  const wave = {
    radius: 0,
    echoes: []
  };

  // Current cursor position
  const cursorFreq = scannerState.frequency;
  const cursorAmp = scannerState.amplitude;

  // Check each signal and calculate distance from cursor
  SIGNAL_FREQUENCIES.forEach(sig => {
    const freqDistance = Math.abs(cursorFreq - sig.freq);
    const ampDistance = Math.abs(cursorAmp - sig.amplitude);

    // Calculate Euclidean distance in parameter space
    // Normalize: freq spans 40 MHz, amp spans 100 units
    const normalizedFreqDist = freqDistance / 40;
    const normalizedAmpDist = ampDistance / 100;
    const distance = Math.sqrt(normalizedFreqDist ** 2 + normalizedAmpDist ** 2);

    // Calculate proximity (0-1, closer = higher) - Tighter than original
    const proximity = Math.max(0, 1 - (distance * 8)); // Sweet spot: harder but not impossible

    // Calculate how close we are to this signal (0-100%)
    const freqProximity = Math.max(0, 1 - (freqDistance / sig.tolerance.freq));
    const ampProximity = Math.max(0, 1 - (ampDistance / sig.tolerance.amp));
    const overallProximity = (freqProximity + ampProximity) / 2;
    const echoPower = Math.round(overallProximity * 100);

    // Blip duration based on proximity (closer = longer display)
    // Base: 1 second, up to 3.5 seconds if very close
    const blipDuration = 1000 + (proximity * 2500);

    // Is cursor close enough to see this blip clearly?
    const isClose = proximity > 0.45; // Must be reasonably close to get yellow highlight

    // Only show blips if cursor is reasonably close (proximity > threshold)
    if(proximity > 0.25) { // Must be within detection range to see blip
      wave.echoes.push({
        freq: sig.freq,
        amplitude: sig.amplitude,
        power: echoPower,
        signal: sig,
        distance: distance,
        proximity: proximity,
        duration: blipDuration,
        isClose: isClose,
        freqProximity: freqProximity,
        ampProximity: ampProximity
      });
    }
  });

  scannerState.pingWaves.push(wave);

  // Show echo results after ping completes
  setTimeout(() => {
    scannerState.isPinging = false;

    if(wave.echoes.length > 0) {
      const now = Date.now();

      // Add blips to radar with timed fade
      scannerState.activeBlips = wave.echoes.map(echo => ({
        freq: echo.freq,
        amplitude: echo.amplitude,
        fadeOutTime: now + echo.duration,
        isClose: echo.isClose,
        signal: echo.signal,
        power: echo.power
      }));

      // Find closest blip
      const closestEcho = wave.echoes.reduce((closest, echo) =>
        !closest || echo.distance < closest.distance ? echo : closest
      , null);

      updateScannerStatus(`${wave.echoes.length} signal(s) detected`, CONFIG.colors.green);

      // Display cursor position info
      const echoContainer = document.getElementById('echoes-container');
      const echoList = document.getElementById('echoes-list');
      echoContainer.style.display = 'block';
      document.getElementById('no-echoes-msg').style.display = 'none';

      // Show cursor position
      echoList.innerHTML = `
        <div style="padding:6px;background:rgba(255,100,100,0.1);border-left:3px solid #ff6464;margin-bottom:8px;">
          <div style="font-size:11px;color:#ff6464;">CURSOR POSITION</div>
          <div style="font-size:10px;color:var(--green);margin-top:2px;">
            FREQ: ${scannerState.frequency.toFixed(1)} MHz | AMP: ${Math.round(scannerState.amplitude)}
          </div>
        </div>
      `;

      // Show all locked signals (persistent)
      if(scannerState.lockedSignals.length > 0) {
        echoList.innerHTML += scannerState.lockedSignals.map(sig => {
          return `<div style="padding:8px;border-left:4px solid #ffff00;margin-bottom:6px;background:rgba(255,255,65,0.08);">
            <div style="display:flex;justify-content:space-between;align-items:center;">
              <div style="font-size:13px;color:#ffff00;font-weight:bold;">${sig.freq} MHz @ ${sig.amplitude}</div>
              <div style="font-size:16px;color:#ffff00;font-weight:bold;text-shadow: 0 0 5px #ffff00;">üîí</div>
            </div>
            <div style="font-size:10px;color:rgba(255,255,100,0.7);margin-top:3px;">‚óè LOCKED - Awaiting decryption</div>
          </div>`;
        }).join('');
      }

      // Show all detected signals sorted by proximity
      echoList.innerHTML += wave.echoes
        .sort((a, b) => b.proximity - a.proximity)
        .map(echo => {
          const proximityPercent = Math.round(echo.proximity * 100);
          const isLocked = echo.power >= 90;
          const powerColor = isLocked ? CONFIG.colors.green : (echo.isClose ? CONFIG.colors.amber : '#ff6666');

          // Signal name visibility
          const signalName = isLocked ? echo.signal.name : 'UNKNOWN SIGNAL';

          // Visual indicators
          const blipDots = '‚óè'.repeat(Math.ceil(echo.proximity * 5));
          const displayTime = (echo.duration / 1000).toFixed(1);

          let status = '';
          if(isLocked) {
            status = 'üéØ READY TO LOCK - Press üîí button';
          } else if(echo.isClose) {
            status = 'üìç CLOSE - Fine-tune cursor';
          } else {
            status = 'üì° DETECTED - Move cursor closer';
          }

          return `<div style="padding:8px;border-left:4px solid ${powerColor};margin-bottom:6px;background:rgba(0,255,65,0.05);">
            <div style="display:flex;justify-content:space-between;align-items:center;">
              <div style="font-size:13px;color:var(--green);font-weight:bold;">${signalName}</div>
              <div style="font-size:16px;color:${powerColor};font-weight:bold;text-shadow: 0 0 5px ${powerColor};">${echo.power}%</div>
            </div>
            <div style="font-size:10px;color:var(--green-dark);margin-top:3px;">${blipDots} Visible: ${displayTime}s</div>
            <div style="font-size:10px;color:var(--amber);margin-top:3px;">${status}</div>
          </div>`;
        }).join('');

      scannerState.foundSignals = wave.echoes.map(e => e.signal);

      // Enable lock button if any signal is ready (>90% power)
      const lockButton = document.getElementById('lock-signal-btn');
      const lockableSignal = wave.echoes.find(e => e.power >= 90);
      if(lockableSignal) {
        lockButton.disabled = false;
        lockButton.style.background = 'rgba(0,255,65,0.3)';
        lockButton.style.borderColor = 'var(--green)';
        lockButton.style.color = 'var(--green)';
        lockButton.style.cursor = 'pointer';
        scannerState.lockableSignal = lockableSignal;
      } else {
        lockButton.disabled = true;
        lockButton.style.background = 'rgba(0,255,65,0.1)';
        lockButton.style.borderColor = 'var(--green-dark)';
        lockButton.style.color = 'var(--green-dark)';
        lockButton.style.cursor = 'not-allowed';
        scannerState.lockableSignal = null;
      }
    } else {
      updateScannerStatus('No signals detected', 'var(--green-dark)');
      scannerState.activeBlips = [];

      // If there are locked signals, still show them
      if(scannerState.lockedSignals.length > 0) {
        const echoContainer = document.getElementById('echoes-container');
        const echoList = document.getElementById('echoes-list');
        echoContainer.style.display = 'block';
        document.getElementById('no-echoes-msg').style.display = 'none';

        echoList.innerHTML = `
          <div style="padding:6px;background:rgba(255,100,100,0.1);border-left:3px solid #ff6464;margin-bottom:8px;">
            <div style="font-size:11px;color:#ff6464;">CURSOR POSITION</div>
            <div style="font-size:10px;color:var(--green);margin-top:2px;">
              FREQ: ${scannerState.frequency.toFixed(1)} MHz | AMP: ${Math.round(scannerState.amplitude)}
            </div>
          </div>
        `;

        echoList.innerHTML += scannerState.lockedSignals.map(sig => {
          return `<div style="padding:8px;border-left:4px solid #ffff00;margin-bottom:6px;background:rgba(255,255,65,0.08);">
            <div style="display:flex;justify-content:space-between;align-items:center;">
              <div style="font-size:13px;color:#ffff00;font-weight:bold;">${sig.freq} MHz @ ${sig.amplitude}</div>
              <div style="font-size:16px;color:#ffff00;font-weight:bold;text-shadow: 0 0 5px #ffff00;">üîí</div>
            </div>
            <div style="font-size:10px;color:rgba(255,255,100,0.7);margin-top:3px;">‚óè LOCKED - Awaiting decryption</div>
          </div>`;
        }).join('');
      } else {
        document.getElementById('echoes-container').style.display = 'none';
        document.getElementById('no-echoes-msg').style.display = 'block';
      }

      // Disable lock button
      const lockButton = document.getElementById('lock-signal-btn');
      lockButton.disabled = true;
      lockButton.style.background = 'rgba(0,255,65,0.1)';
      lockButton.style.borderColor = 'var(--green-dark)';
      lockButton.style.color = 'var(--green-dark)';
      lockButton.style.cursor = 'not-allowed';
      scannerState.lockableSignal = null;
    }
  }, 2000);
}

// ‚ïê‚ïê‚ïê SIGNAL LOCKING ‚ïê‚ïê‚ïê
function attemptLockSignal() {
  if(!scannerState.lockableSignal) return;

  const signal = scannerState.lockableSignal.signal;

  playSFX('glitch_heavy',0.4);
  updateScannerStatus('üîí LOCKING SIGNAL...', CONFIG.colors.amber);

  setTimeout(() => {
    updateScannerStatus('‚ñà‚ñì‚ñí‚ñë SIGNAL LOCKED ‚ñë‚ñí‚ñì‚ñà', CONFIG.colors.green);
    playSFX('scanner_lock',0.6);

    // Add to locked signals array (if not already locked)
    if(!scannerState.lockedSignals.find(s => s.freq === signal.freq && s.amplitude === signal.amplitude)) {
      scannerState.lockedSignals.push(signal);
    }

    // Unlock radar after first signal lock
    if(scannerState.lockedSignals.length === 1 && !state.radarUnlocked) {
      state.radarUnlocked = true;
      const radarBtn = document.getElementById('radar-toggle-btn');
      radarBtn.style.background = 'rgba(0,255,65,0.1)';
      radarBtn.style.borderColor = 'var(--green-dark)';
      radarBtn.style.color = 'var(--green)';
      radarBtn.style.cursor = 'pointer';
      radarBtn.textContent = 'üì° RADAR';
      setTimeout(() => {
        printLine('');
        printLine('RADAR SYSTEM UNLOCKED', 'warning');
        printLine('Visual targeting now available.', 'dim');
        printLine('');
      }, 1500);
    }

    // Update echoes display to show newly locked signal
    updateEchoesDisplay();

    // Show lock message (no auto-decode - saved for decoder minigame)
    discoverCommandGroup('decode');
    setTimeout(() => {
      printLine('');
      printLine('SIGNAL LOCKED: ' + signal.freq + ' MHz', 'warning');
      printLine('Encrypted data stream captured.', 'dim');
      printLine('Open DECODE.EXE to decrypt. Type "decode".', 'dim');
      printLine(`Total signals locked: ${scannerState.lockedSignals.length}/${SIGNAL_FREQUENCIES.length}`, 'dim');
      printLine('');

      // Update progression
      state.progression.signalsLocked=scannerState.lockedSignals.length;
      checkProgression();
    }, 500);
  }, 1000);
}

function updateEchoesDisplay() {
  const echoContainer = document.getElementById('echoes-container');
  const echoList = document.getElementById('echoes-list');

  if(scannerState.lockedSignals.length > 0) {
    echoContainer.style.display = 'block';
    document.getElementById('no-echoes-msg').style.display = 'none';

    echoList.innerHTML = `
      <div style="padding:6px;background:rgba(255,100,100,0.1);border-left:3px solid #ff6464;margin-bottom:8px;">
        <div style="font-size:11px;color:#ff6464;">CURSOR POSITION</div>
        <div style="font-size:10px;color:var(--green);margin-top:2px;">
          FREQ: ${scannerState.frequency.toFixed(1)} MHz | AMP: ${Math.round(scannerState.amplitude)}
        </div>
      </div>
    `;

    echoList.innerHTML += scannerState.lockedSignals.map(sig => {
      return `<div style="padding:8px;border-left:4px solid #ffff00;margin-bottom:6px;background:rgba(255,255,65,0.08);">
        <div style="display:flex;justify-content:space-between;align-items:center;">
          <div style="font-size:13px;color:#ffff00;font-weight:bold;">${sig.freq} MHz @ ${sig.amplitude}</div>
          <div style="font-size:16px;color:#ffff00;font-weight:bold;text-shadow: 0 0 5px #ffff00;">üîí</div>
        </div>
        <div style="font-size:10px;color:rgba(255,255,100,0.7);margin-top:3px;">‚óè LOCKED - Awaiting decryption</div>
      </div>`;
    }).join('');
  } else {
    echoContainer.style.display = 'none';
    document.getElementById('no-echoes-msg').style.display = 'block';
  }
}


// ‚ïê‚ïê‚ïê WINDOW INTERACTION ‚ïê‚ïê‚ïê
const WindowInteraction = {
  checkCollision(rect1, rect2) {
    return !(rect1.right < rect2.left || 
             rect1.left > rect2.right || 
             rect1.bottom < rect2.top || 
             rect1.top > rect2.bottom);
  },
  
  checkNearby(rect1, rect2, threshold = 100) {
    // More generous overlap detection
    const overlap = !(rect1.right < rect2.left - threshold || 
                     rect1.left > rect2.right + threshold || 
                     rect1.bottom < rect2.top - threshold || 
                     rect1.top > rect2.bottom + threshold);
    return overlap;
  },
  
  onDrop(draggedId, targetId, callback) {
    const draggedEl = document.getElementById(draggedId);
    const targetEl = document.getElementById(targetId);
    
    if (!draggedEl || !targetEl) return;
    
    // Store callback for when windows are close
    if (!this.dropHandlers) this.dropHandlers = {};
    if (!this.dropHandlers[draggedId]) this.dropHandlers[draggedId] = {};
    this.dropHandlers[draggedId][targetId] = callback;
  },
  
  checkDrops() {
    if (!this.dropHandlers) return;
    
    Object.keys(this.dropHandlers).forEach(draggedId => {
      const draggedEl = document.getElementById(draggedId);
      if (!draggedEl || !draggedEl.classList.contains('show')) return;
      
      const draggedRect = draggedEl.getBoundingClientRect();
      
      Object.keys(this.dropHandlers[draggedId]).forEach(targetId => {
        const targetEl = document.getElementById(targetId);
        if (!targetEl) return;
        
        const targetRect = targetEl.getBoundingClientRect();
        
        if (this.checkCollision(draggedRect, targetRect)) {
          const callback = this.dropHandlers[draggedId][targetId];
          if (callback) callback();
        }
      });
    });
  }
};

// Check for window interactions on mouse up
document.addEventListener('mouseup', () => {
  WindowInteraction.checkDrops();
});



// Check for nearby windows during drag and provide visual feedback
let dragCheckInterval = null;

document.addEventListener('mousedown', (e) => {
  // Check if we're starting to drag a window
  const titlebar = e.target.closest('.popup-titlebar');
  if (!titlebar) return;
  
  // Start checking for nearby windows
  dragCheckInterval = setInterval(() => {
    if (!WindowInteraction.dropHandlers) return;
    
    Object.keys(WindowInteraction.dropHandlers).forEach(draggedId => {
      const draggedEl = document.getElementById(draggedId);
      if (!draggedEl || !draggedEl.classList.contains('show')) return;
      
      const draggedRect = draggedEl.getBoundingClientRect();
      let isNearAny = false;
      
      Object.keys(WindowInteraction.dropHandlers[draggedId]).forEach(targetId => {
        const targetEl = document.getElementById(targetId);
        if (!targetEl) return;
        
        const targetRect = targetEl.getBoundingClientRect();
        
        if (WindowInteraction.checkNearby(draggedRect, targetRect, 100)) {
          isNearAny = true;
          targetEl.classList.add('window-can-interact');
        } else {
          targetEl.classList.remove('window-can-interact');
        }
      });
      
      if (isNearAny) {
        draggedEl.classList.add('window-can-interact');
      } else {
        draggedEl.classList.remove('window-can-interact');
      }
    });
  }, 50);
});

document.addEventListener('mouseup', () => {
  // Stop checking and remove visual feedback
  if (dragCheckInterval) {
    clearInterval(dragCheckInterval);
    dragCheckInterval = null;
  }
  
  // Remove all feedback classes
  document.querySelectorAll('.window-can-interact').forEach(el => {
    el.classList.remove('window-can-interact');
  });
});






// ‚ïê‚ïê‚ïê DECODE.EXE (Waveform Pattern Matcher) ‚ïê‚ïê‚ïê

const DECODE_PATTERNS={
  SIGNAL:  [1,2,3,4,4,3,2,1,2,3,4,3],
  BENEATH: [4,1,3,0,4,2,0,3,1,4,2,3],
  VOID:    [0,4,1,3,0,4,2,1,4,0,3,2]
}

const decodeState={
  activeSignal:null,
  inputLevels:[],
  targetPattern:[],
  corruptionTimer:null,
  corruptionPct:0,
  solved:false,
  BAR_COUNT:12,
  MAX_LEVEL:4,
  CORRUPTION_DURATION:45000
}

function openDecode(){
  if(!state.progression.milestones.includes('SIGNAL_DISCOVERY')){
    playSFX('glitch_error',0.4)
    printLine('DECODE.EXE ‚Äî CLEARANCE INSUFFICIENT','error')
    setTimeout(()=>printLine('Signal analysis required first. Try "scan".','ghost'),600)
    return
  }
  document.getElementById('decode-popup').classList.add('show')
  WindowRegistry.discover('decode-popup')
  printLine('Opening DECODE.EXE...','dim')
  decodeShowList()
}

function closeDecode(){
  document.getElementById('decode-popup').classList.remove('show')
  decodeCleanup()
}

function decodeCleanup(){
  if(decodeState.corruptionTimer){clearInterval(decodeState.corruptionTimer);decodeState.corruptionTimer=null}
  decodeState.activeSignal=null
  decodeState.solved=false
  decodeState.corruptionPct=0
}

function decodeShowList(){
  decodeCleanup()
  document.getElementById('decode-list').style.display='block'
  document.getElementById('decode-game').classList.remove('active')
  decodeRenderSignals()
}

function decodeRenderSignals(){
  const container=document.getElementById('decode-signals')
  const emptyMsg=document.getElementById('decode-empty')
  const available=scannerState.lockedSignals.filter(sig=>{
    return CONFIG.tracks.find(t=>t.unlockCode===sig.code)
  })
  if(available.length===0){
    container.innerHTML=''
    emptyMsg.style.display='block'
    return
  }
  emptyMsg.style.display='none'
  container.innerHTML=available.map(sig=>{
    const track=CONFIG.tracks.find(t=>t.unlockCode===sig.code)
    const decoded=state.discovered.has(track.id)
    const statusClass=decoded?'completed':''
    const statusText=decoded
      ?'<span style="color:var(--cyan);">DECRYPTED ‚úì</span>'
      :'<span style="color:var(--amber);">ENCRYPTED</span>'
    return `<div class="decode-signal-item ${statusClass}" onclick="${decoded?'':`decodeStartGame('${sig.code}')`}">
      <div><div class="sig-name">${sig.name}</div><div class="sig-freq">${sig.freq} MHz @ AMP ${sig.amplitude}</div></div>
      <div class="sig-status">${statusText}</div>
    </div>`
  }).join('')
}

function decodeStartGame(code){
  const signal=SIGNAL_FREQUENCIES.find(s=>s.code===code)
  if(!signal)return
  const track=CONFIG.tracks.find(t=>t.unlockCode===code)
  if(!track||state.discovered.has(track.id))return
  playSFX('ui_click',0.4)
  decodeState.activeSignal=signal
  decodeState.targetPattern=(DECODE_PATTERNS[code]||DECODE_PATTERNS.SIGNAL).slice()
  decodeState.inputLevels=new Array(decodeState.BAR_COUNT).fill(0)
  decodeState.solved=false
  decodeState.corruptionPct=0
  document.getElementById('decode-list').style.display='none'
  document.getElementById('decode-game').classList.add('active')
  document.getElementById('decode-signal-label').textContent=`${signal.name} ${signal.freq} MHz`
  document.getElementById('decode-match').textContent='0%'
  document.getElementById('decode-match').style.color='var(--green)'
  document.getElementById('decode-status').textContent='Align the waveform to decrypt the signal.'
  document.getElementById('decode-status').style.color='var(--green-dim)'
  decodeRenderBars()
  decodeStartCorruption()
}

function decodeRenderBars(){
  const container=document.getElementById('decode-waveform')
  const barH=120
  let html=''
  for(let i=0;i<decodeState.BAR_COUNT;i++){
    const targetH=(decodeState.targetPattern[i]/decodeState.MAX_LEVEL)*barH
    const inputH=(decodeState.inputLevels[i]/decodeState.MAX_LEVEL)*barH
    const matched=decodeState.inputLevels[i]===decodeState.targetPattern[i]
    html+=`<div class="decode-bar-col" onclick="decodeClickBar(${i})">
      <div class="decode-bar-target" style="height:${targetH}px"></div>
      <div class="decode-bar-input ${matched?'matched':''}" style="height:${Math.max(2,inputH)}px" id="decode-bar-${i}"></div>
    </div>`
  }
  container.innerHTML=html
}

function decodeClickBar(index){
  if(decodeState.solved)return
  playSFX('ui_click',0.2)
  decodeState.inputLevels[index]=(decodeState.inputLevels[index]+1)%(decodeState.MAX_LEVEL+1)
  const barH=120
  const inputH=(decodeState.inputLevels[index]/decodeState.MAX_LEVEL)*barH
  const matched=decodeState.inputLevels[index]===decodeState.targetPattern[index]
  const barEl=document.getElementById(`decode-bar-${index}`)
  if(barEl){
    barEl.style.height=Math.max(2,inputH)+'px'
    barEl.className='decode-bar-input'+(matched?' matched':'')
  }
  const matchCount=decodeState.inputLevels.filter((v,i)=>v===decodeState.targetPattern[i]).length
  const matchPct=Math.round((matchCount/decodeState.BAR_COUNT)*100)
  document.getElementById('decode-match').textContent=matchPct+'%'
  if(matchPct<50){
    document.getElementById('decode-status').textContent='Signal pattern divergent. Keep adjusting.'
    document.getElementById('decode-status').style.color='var(--green-dim)'
  }else if(matchPct<80){
    document.getElementById('decode-status').textContent='Pattern converging... getting closer.'
    document.getElementById('decode-status').style.color='var(--amber)'
  }else if(matchPct<100){
    document.getElementById('decode-status').textContent='Near match! Fine-tune remaining bars.'
    document.getElementById('decode-status').style.color='var(--green)'
  }
  if(matchPct===100)decodeSuccess()
}

function decodeStartCorruption(){
  const fill=document.getElementById('decode-corruption-fill')
  fill.style.width='0%'
  decodeState.corruptionPct=0
  decodeState.corruptionTimer=setInterval(()=>{
    if(decodeState.solved){clearInterval(decodeState.corruptionTimer);return}
    decodeState.corruptionPct+=2
    fill.style.width=Math.min(100,decodeState.corruptionPct)+'%'
    if(decodeState.corruptionPct>=100){
      decodeCorrupt()
      decodeState.corruptionPct=0
      fill.style.width='0%'
    }
  },900)
}

function decodeCorrupt(){
  playSFX('glitch_error',0.3)
  document.getElementById('decode-status').textContent='‚ö† DATA CORRUPTION ‚Äî pattern shifted!'
  document.getElementById('decode-status').style.color='var(--red)'
  const nonMatched=[]
  for(let i=0;i<decodeState.BAR_COUNT;i++){
    if(decodeState.inputLevels[i]!==decodeState.targetPattern[i])nonMatched.push(i)
  }
  const toScramble=nonMatched.sort(()=>Math.random()-0.5).slice(0,2)
  toScramble.forEach(idx=>{
    let newVal
    do{newVal=Math.floor(Math.random()*(decodeState.MAX_LEVEL+1))}while(newVal===decodeState.targetPattern[idx])
    decodeState.targetPattern[idx]=newVal
  })
  decodeRenderBars()
  const matchCount=decodeState.inputLevels.filter((v,i)=>v===decodeState.targetPattern[i]).length
  const matchPct=Math.round((matchCount/decodeState.BAR_COUNT)*100)
  document.getElementById('decode-match').textContent=matchPct+'%'
  setTimeout(()=>{
    if(!decodeState.solved){
      document.getElementById('decode-status').textContent='Pattern shifted. Re-align corrupted bars.'
      document.getElementById('decode-status').style.color='var(--green-dim)'
    }
  },2000)
}

function decodeSuccess(){
  decodeState.solved=true
  if(decodeState.corruptionTimer){clearInterval(decodeState.corruptionTimer);decodeState.corruptionTimer=null}
  playSFX('scanner_lock',0.6)
  const popup=document.getElementById('decode-popup')
  popup.classList.add('decode-success-flash')
  setTimeout(()=>popup.classList.remove('decode-success-flash'),1000)
  document.getElementById('decode-match').textContent='100%'
  document.getElementById('decode-match').style.color='var(--cyan)'
  document.getElementById('decode-status').textContent='‚ñà‚ñì‚ñí‚ñë DECRYPTION COMPLETE ‚ñë‚ñí‚ñì‚ñà'
  document.getElementById('decode-status').style.color='var(--cyan)'
  document.getElementById('decode-corruption-fill').style.width='0%'
  const track=CONFIG.tracks.find(t=>t.unlockCode===decodeState.activeSignal.code)
  if(track){
    setTimeout(()=>{
      unlockTrack(track.id)
      setTimeout(()=>decodeRenderSignals(),500)
    },800)
  }
  setTimeout(()=>{
    if(document.getElementById('decode-popup').classList.contains('show'))decodeShowList()
  },3500)
}

function decodeOverride(){
  const input=document.getElementById('decode-override-input')
  const val=input.value.trim().toUpperCase()
  input.value=''
  if(val===CONFIG.secrets.masterCode){
    playSFX('glitch_heavy',0.4)
    COMMANDS.unlockAll()
    closeDecode()
  }else{
    playSFX('glitch_error',0.3)
    input.style.borderColor='var(--red)'
    setTimeout(()=>{input.style.borderColor='var(--green-dark)'},1000)
  }
}

function decodeOpenForSignal(code){
  openDecode()
  setTimeout(()=>decodeStartGame(code),100)
}

// ‚ïê‚ïê‚ïê GALLERY ‚ïê‚ïê‚ïê
const galleryImages = [
  {
    id: 'img_01',
    title: 'BAND PHOTO #1',
    description: 'REDACTED CLUB - Early Days',
    unlockCode: null, // Always unlocked
    url: './redacted_assets/gallery/Band_photo.png'
  },
  {
    id: 'img_02',
    title: 'RECORDING SESSION',
    description: 'Studio work on the EP',
    unlockCode: 'LEET',
    url: './redacted_assets/gallery/IMG_1052.JPG'
  },
  {
    id: 'img_03',
    title: 'FREQUENCY MAP',
    description: 'Signal locations discovered',
    unlockCode: 'FREQ_97.7',
    url: './redacted_assets/gallery/IMG_1183.JPG'
  },
  {
    id: 'img_04',
    title: 'LIVE PERFORMANCE',
    description: 'First show - 2024',
    unlockCode: '1984',
    url: './redacted_assets/gallery/IMG_1237.JPG'
  },
  {
    id: 'img_05',
    title: 'ALBUM ART',
    description: 'EP cover design',
    unlockCode: '420',
    url: './redacted_assets/gallery/livephoto.png'
  },
  {
    id: 'img_06',
    title: 'BEHIND THE SCENES',
    description: 'Making the music',
    unlockCode: 'KONAMI',
    url: './redacted_assets/gallery/spacewave.png'
  }
];

function initGallery() {
  renderGallery();
}

function isImageUnlocked(img) {
  if (!img.unlockCode) return true; // Always unlocked
  return CONFIG.secrets.codesFound.includes(img.unlockCode);
}

function renderGallery() {
  const grid = document.getElementById('gallery-grid');
  if (!grid) return;
  
  grid.innerHTML = '';
  
  const unlockedCount = galleryImages.filter(img => isImageUnlocked(img)).length;
  
  // Show status
  const status = document.createElement('div');
  status.style.cssText = 'grid-column:1/-1;padding:10px;text-align:center;color:var(--green);border-bottom:1px solid var(--green-dark);margin-bottom:10px;';
  status.innerHTML = `IMAGES UNLOCKED: ${unlockedCount}/${galleryImages.length}`;
  grid.appendChild(status);
  
  galleryImages.forEach((img) => {
    const item = document.createElement('div');
    item.className = 'gallery-item';
    
    const unlocked = isImageUnlocked(img);
    
    if (unlocked) {
      // Show real image
      const imgEl = document.createElement('img');
      imgEl.src = img.url;
      imgEl.alt = img.title;
      item.appendChild(imgEl);
      
      // Add title overlay
      const title = document.createElement('div');
      title.style.cssText = 'position:absolute;bottom:0;left:0;right:0;background:rgba(0,0,0,0.8);color:var(--green);padding:8px;font-size:12px;text-align:center;';
      title.textContent = img.title;
      item.appendChild(title);
      
      item.onclick = () => openLightbox(img);
    } else {
      // Show locked/corrupted image
      item.style.background = 'repeating-linear-gradient(45deg, #000 0px, #000 10px, #001a00 10px, #001a00 20px)';
      const locked = document.createElement('div');
      locked.style.cssText = 'display:flex;flex-direction:column;align-items:center;justify-content:center;height:100%;color:var(--green-dark);';
      locked.innerHTML = `
        <div style="font-size:40px;">üîí</div>
        <div style="font-size:12px;margin-top:10px;">LOCKED</div>
        <div style="font-size:10px;margin-top:5px;">Find secrets to unlock</div>
      `;
      item.appendChild(locked);
      item.style.cursor = 'not-allowed';
    }
    
    grid.appendChild(item);
  });
}

function openLightbox(img) {
  const lightbox = document.getElementById('gallery-lightbox');
  const imgEl = document.getElementById('gallery-lightbox-img');
  const info = document.getElementById('gallery-lightbox-info');
  
  imgEl.src = img.url;
  if (info) {
    info.innerHTML = `
      <div style="font-size:20px;margin-bottom:10px;">${img.title}</div>
      <div style="font-size:14px;color:var(--green-dark);">${img.description}</div>
    `;
  }
  lightbox.classList.add('show');
}

function unlockGalleryImage(code) {
  const img = galleryImages.find(i => i.unlockCode === code);
  if (img) {
    discoverCommandGroup('gallery');
    setTimeout(() => {

      printLine('','');
      printLine(`üì∑ Gallery image unlocked: ${img.title}`, 'success');
      printLine('','');
    }, 500);
  }
}

// ‚ïê‚ïê‚ïê PLAYER ‚ïê‚ïê‚ïê
function initPlayerPopup() {
  renderPlayerTracks();
  setupPlayerControls();
}

function renderPlayerTracks() {
  const list = document.getElementById('player-track-list');
  if (!list) return;
  
  list.innerHTML = '';
  CONFIG.tracks.forEach((track, index) => {
    // Only show visible tracks OR tracks that have been discovered
    if (!track.visible && !state.discovered.has(track.id)) return;
    
    const isLocked = track.locked && !state.discovered.has(track.id);
    const isPlaying = state.currentTrack === index;
    
    const entry = document.createElement('div');
    entry.style.cssText = `padding:8px;margin:4px 0;background:rgba(0,255,65,${isLocked?'0.02':'0.05'});border:1px solid ${isLocked?'var(--red)':'var(--green-dark)'};cursor:${isLocked?'not-allowed':'pointer'};display:flex;justify-content:space-between;align-items:center;`;
    entry.className = 'player-track-entry';
    
    const displayTitle = isLocked ? '‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà [ENCRYPTED]' : track.title;
    const statusIcon = isPlaying ? '‚ñ∂' : (isLocked ? 'üîí' : '');
    
    entry.innerHTML = `
      <div style="flex:1;">
        <div style="color:${isLocked?'var(--red)':'var(--green)'};font-size:14px;">${displayTitle}</div>
        <div style="color:var(--green-dark);font-size:10px;">${track.id}</div>
        ${!isLocked ? `<button onclick="event.stopPropagation();downloadTrack('${CONFIG.audioPath}${CONFIG.format === 'mp3' ? track.file_mp3 : track.file_wav}', '${track.title}')" style="margin-top:6px;background:rgba(0,255,65,0.1);border:1px solid var(--green-dark);color:var(--green);padding:4px 8px;cursor:pointer;font-family:'VT323',monospace;font-size:11px;">‚¨á DOWNLOAD</button>` : ''}
      </div>
      <div style="color:${isLocked?'var(--red)':(isPlaying?'var(--amber)':'var(--green-dark)')};font-size:12px;">${statusIcon}</div>
    `;

    if (isLocked) {
      entry.addEventListener('click', () => {
        playSFX('glitch_error',0.4);
        printLine('ACCESS DENIED ‚Äî file is encrypted','error');
        setTimeout(() => printLine('Hint: use "scan" command to find decryption keys','ghost'), 800);
      });
    } else {
      entry.addEventListener('click', () => playTrackByIndex(index));
      entry.addEventListener('mouseenter', () => entry.style.background = 'rgba(0,255,65,0.15)');
      entry.addEventListener('mouseleave', () => entry.style.background = 'rgba(0,255,65,0.05)');
    }
    
    list.appendChild(entry);
  });
}

function downloadTrack(trackFile, trackTitle) {
  const link = document.createElement('a');
  link.href = trackFile;
  link.download = `${trackTitle}.wav`;
  document.body.appendChild(link);
  link.click();
  document.body.removeChild(link);

  printLine(`Downloading: ${trackTitle}`, 'dim');
}

function _onAudioPlay(){state.isPlaying=true;updatePlayerUI()}
function _onAudioPause(){state.isPlaying=false;updatePlayerUI()}
function _onAudioEnded(){const visibleTracks=CONFIG.tracks.filter(t=>t.visible);if(state.currentTrack<visibleTracks.length-1)playTrackByIndex(state.currentTrack+1)}
var _playerControlsInit=false
function setupPlayerControls() {
  const playBtn = document.getElementById('player-play');
  const prevBtn = document.getElementById('player-prev');
  const nextBtn = document.getElementById('player-next');
  const volumeSlider = document.getElementById('player-volume');
  const volumeDisplay = document.getElementById('player-volume-display');

  if (playBtn) {
    playBtn.onclick = () => {
      if (state.currentTrack === -1) {
        playTrackByIndex(0);
      } else if (state.isPlaying) {
        audio.pause();
      } else {
        audio.play();
      }
    };
  }

  if (prevBtn) {
    prevBtn.onclick = () => {
      if (state.currentTrack > 0) {
        playTrackByIndex(state.currentTrack - 1);
      }
    };
  }

  if (nextBtn) {
    nextBtn.onclick = () => {
      const visibleTracks = CONFIG.tracks.filter(t => t.visible);
      if (state.currentTrack < visibleTracks.length - 1) {
        playTrackByIndex(state.currentTrack + 1);
      }
    };
  }

  if (volumeSlider) {
    volumeSlider.oninput = (e) => {
      const vol = e.target.value;
      audio.volume = vol / 100;
      if (volumeDisplay) volumeDisplay.textContent = vol + '%';
    };
    audio.volume = CONFIG.defaultVolume;
  }

  if(!_playerControlsInit){
    _playerControlsInit=true
    audio.addEventListener('play', _onAudioPlay);
    audio.addEventListener('pause', _onAudioPause);
    audio.addEventListener('timeupdate', updatePlayerTime);
    audio.addEventListener('ended', _onAudioEnded);
  }
}

function updatePlayerUI() {
  const playBtn = document.getElementById('player-play');
  const nowPlaying = document.getElementById('player-now-playing');

  if (playBtn) {
    playBtn.innerHTML = state.isPlaying ? '‚è∏ PAUSE' : '‚ñ∂ PLAY';
  }

  const fab = document.getElementById('music-fab');
  if (fab) fab.classList.toggle('playing', state.isPlaying);

  if (nowPlaying && state.currentTrack >= 0) {
    const track = CONFIG.tracks[state.currentTrack];
    nowPlaying.textContent = `‚ñ∂ ${track.title}`;
    nowPlaying.style.color = 'var(--green)';
  } else if (nowPlaying && !state.isPlaying) {
    nowPlaying.textContent = 'No track playing';
    nowPlaying.style.color = 'var(--green-dark)';
  }

  renderPlayerTracks();
}

function _formatTime(s) {
  const m = Math.floor(s / 60);
  const sec = s % 60;
  return `${m}:${sec.toString().padStart(2, '0')}`;
}

function updatePlayerTime() {
  const timeEl = document.getElementById('player-time');
  const durEl = document.getElementById('player-duration');
  const bar = document.getElementById('player-progress-bar');
  if (audio.duration) {
    const cur = Math.floor(audio.currentTime);
    const tot = Math.floor(audio.duration);
    if (timeEl) timeEl.textContent = _formatTime(cur);
    if (durEl) durEl.textContent = _formatTime(tot);
    if (bar) bar.style.width = ((audio.currentTime / audio.duration) * 100) + '%';
  }
}

// ‚ïê‚ïê‚ïê PIN CODE ‚ïê‚ïê‚ïê
let pinValue = '';
const pinSecrets = {
  '1337': {
    name: 'LEET_CODE',
    action: () => {
      printLine('','');
      printLine('‚ñì‚ñì‚ñì 1337 H4X0R ‚ñì‚ñì‚ñì','warning');
      printLine('You are elite.','cyan');
      printLine('','');
      
      addSecret('LEET');
    }
  },
  '9775': {
    name: 'FREQUENCY_KEY',
    action: () => {
      printLine('','');
      printLine('‚ñì‚ñì‚ñì FREQUENCY UNLOCKED ‚ñì‚ñì‚ñì','warning');
      printLine('97.7 MHz - The signal remembers.','cyan');
      printLine('','');
      
      addSecret('FREQ_97.7');
    }
  },
  '1984': {
    name: 'BIG_BROTHER',
    action: () => {
      printLine('','');
      printLine('‚ñì‚ñì‚ñì BIG BROTHER IS WATCHING ‚ñì‚ñì‚ñì','error');
      printLine('War is Peace. Freedom is Slavery. Ignorance is Strength.','ghost');
      printLine('','');
      
      addSecret('1984');
    }
  },
  '0420': {
    name: 'NICE',
    action: () => {
      printLine('','');
      printLine('Nice.','success');
      printLine('','');
      
      addSecret('420');
    }
  },
  '0000': {
    name: 'DEFAULT_CODE',
    action: () => {
      printLine('','');
      printLine('Really? The default code?','dim');
      printLine('Try harder.','ghost');
      printLine('','');
      
    }
  }
};

function pinPress(num) {
  if (pinValue.length < CONFIG.pinLength) {
    pinValue += num;
    playSFX('ui_click',0.3);
    updatePinDisplay();
  }
}

function pinClear() {
  pinValue = '';
  updatePinDisplay();
  document.getElementById('pin-display').classList.remove('error', 'success');
  document.getElementById('pin-hint').textContent = 'Enter 4-digit code';
}

function resetPin() {
  pinValue = '';
  document.getElementById('pin-display').textContent = '----';
  document.getElementById('pin-display').classList.remove('error', 'success');
  document.getElementById('pin-hint').textContent = 'Enter 4-digit code';
}

function updatePinDisplay() {
  const display = document.getElementById('pin-display');
  display.classList.remove('error', 'success');
  let displayText = '';
  for (let i = 0; i < 4; i++) {
    displayText += i < pinValue.length ? '‚óè' : '-';
  }
  display.textContent = displayText;
}

function pinSubmit() {
  if (pinValue.length !== CONFIG.pinLength) return;
  
  const display = document.getElementById('pin-display');
  const hint = document.getElementById('pin-hint');
  
  if (pinSecrets[pinValue]) {
    // Correct code!
    playSFX('retro_movie',0.5);
    display.classList.add('success');
    display.textContent = pinValue;
    hint.textContent = 'ACCESS GRANTED';
    
    setTimeout(() => {
      pinSecrets[pinValue].action();
      if(!state.progression.pinsEntered.includes(pinValue)){state.progression.pinsEntered.push(pinValue);checkProgression()}
      document.getElementById('pincode-popup').classList.remove('show');
      resetPin();
    }, 800);
  } else {
    // Wrong code
    playSFX('glitch_error',0.5);
    display.classList.add('error');
    display.textContent = 'XXXX';
    hint.textContent = 'ACCESS DENIED';
    
    setTimeout(() => {
      pinClear();
    }, 1000);
  }
}

// ‚ïê‚ïê‚ïê SYNTH.EXE ‚ïê‚ïê‚ïê
let synthState = null

const SYNTH_NOTES = {}
;(function(){
  const names = ['C','C#','D','D#','E','F','F#','G','G#','A','A#','B']
  for(let oct=1;oct<=7;oct++){
    for(let i=0;i<12;i++){
      const name = names[i]+oct
      SYNTH_NOTES[name] = 440 * Math.pow(2, ((oct-4)*12 + i - 9)/12)
    }
  }
})()

// Which white-key index maps to which chromatic offset within an octave
const SYNTH_WHITE_MAP = [0,2,4,5,7,9,11] // C D E F G A B
// Black keys sit after these white-key positions (within one octave of 7 whites)
const SYNTH_BLACK_POS = [0,1,3,4,5] // after C,D, F,G,A

// Computer keyboard ‚Üí key index (white = integer, black = x.5)
const SYNTH_KEY_MAP = {
  'a':0,'s':1,'d':2,'f':3,'g':4,'h':5,'j':6,
  'k':7,'l':8,';':9,"'":10,'z':11,'x':12,'c':13,
  'w':0.5,'e':1.5,'t':3.5,'y':4.5,'u':5.5,
  'i':7.5,'o':8.5,'p':10.5
}

function synthNoteFromIndex(idx){
  if(!synthState) return null
  const baseOct = 3 + synthState.octaveShift
  const isBlack = idx % 1 !== 0
  const whiteIdx = Math.floor(idx)
  const octOffset = Math.floor(whiteIdx / 7)
  const posInOct = whiteIdx % 7
  let chromatic = SYNTH_WHITE_MAP[posInOct]
  if(isBlack) chromatic += 1
  const oct = baseOct + octOffset
  const names = ['C','C#','D','D#','E','F','F#','G','G#','A','A#','B']
  return names[chromatic] + oct
}

function initSynth(){
  if(synthState) stopSynth()
  const AC = window.AudioContext || window.webkitAudioContext
  const ctx = new AC()
  const master = ctx.createGain()
  master.gain.value = 0.5
  const filter = ctx.createBiquadFilter()
  filter.type = 'lowpass'
  filter.frequency.value = 8000
  filter.Q.value = 1
  filter.connect(master)
  master.connect(ctx.destination)

  synthState = {
    ctx, master, filter,
    activeNotes: new Map(),
    waveform: 'sine',
    octaveShift: 0,
    attack: 0.01, decay: 0.2, sustain: 0.7, release: 0.3,
    seq: new Array(16).fill(null)
  }

  synthRenderKeyboard()
  synthRenderGrid()
  synthUpdateOctDisplay()
  document.addEventListener('keydown', synthKeyDown)
  document.addEventListener('keyup', synthKeyUp)
  if(typeof playSFX === 'function') playSFX('ui_click', 0.3)
}

function stopSynth(){
  if(!synthState) return
  synthState.activeNotes.forEach((_, k) => synthNoteOff(k))
  try{ synthState.ctx.close() }catch(e){}
  document.removeEventListener('keydown', synthKeyDown)
  document.removeEventListener('keyup', synthKeyUp)
  synthState = null
}

function synthRenderKeyboard(){
  const kb = document.getElementById('synth-keyboard')
  if(!kb) return
  kb.innerHTML = ''
  const totalWhite = 14
  const keyW = 100 / totalWhite

  // White keys
  for(let i=0;i<totalWhite;i++){
    const k = document.createElement('div')
    k.className = 'synth-key white'
    k.dataset.idx = i
    k.style.left = (i * keyW) + '%'
    k.style.width = keyW + '%'
    const names = ['C','D','E','F','G','A','B']
    k.textContent = names[i % 7]
    k.onmousedown = (e)=>{e.preventDefault();synthNoteOn(i)}
    k.onmouseup = ()=>synthNoteOff(i)
    k.onmouseleave = ()=>synthNoteOff(i)
    kb.appendChild(k)
  }

  // Black keys (2 octaves = 10 blacks)
  for(let oct=0;oct<2;oct++){
    SYNTH_BLACK_POS.forEach(pos => {
      const whiteIdx = oct*7 + pos
      const idx = whiteIdx + 0.5
      const k = document.createElement('div')
      k.className = 'synth-key black'
      k.dataset.idx = idx
      const bw = keyW * 0.6
      k.style.left = ((whiteIdx + 1) * keyW - bw/2) + '%'
      k.style.width = bw + '%'
      k.textContent = '#'
      k.onmousedown = (e)=>{e.preventDefault();synthNoteOn(idx)}
      k.onmouseup = ()=>synthNoteOff(idx)
      k.onmouseleave = ()=>synthNoteOff(idx)
      kb.appendChild(k)
    })
  }
}

function synthNoteOn(idx){
  if(!synthState) return
  if(synthState.activeNotes.has(idx)) synthNoteOff(idx)
  const name = synthNoteFromIndex(idx)
  const freq = SYNTH_NOTES[name]
  if(!freq) return

  if(synthState.ctx.state === 'suspended') synthState.ctx.resume()
  const now = synthState.ctx.currentTime
  const osc = synthState.ctx.createOscillator()
  osc.type = synthState.waveform
  osc.frequency.value = freq
  const gain = synthState.ctx.createGain()
  gain.gain.setValueAtTime(0, now)
  gain.gain.linearRampToValueAtTime(1, now + synthState.attack)
  gain.gain.linearRampToValueAtTime(synthState.sustain, now + synthState.attack + synthState.decay)
  osc.connect(gain)
  gain.connect(synthState.filter)
  osc.start(now)
  synthState.activeNotes.set(idx, {osc, gain, name})

  // Visual
  const el = document.querySelector('.synth-key[data-idx="'+idx+'"]')
  if(el) el.classList.add('active')

  // Record via shared transport
  if(transport.recording){
    const step = transport.playing ? transport.step : transport.recStep
    synthState.seq[step] = {idx, name}
    synthRenderGrid()
    if(!transport.playing) transport.recStep = (transport.recStep + 1) % 16
  }
}

function synthNoteOff(idx){
  if(!synthState || !synthState.activeNotes.has(idx)) return
  const note = synthState.activeNotes.get(idx)
  const now = synthState.ctx.currentTime
  note.gain.gain.cancelScheduledValues(now)
  note.gain.gain.setValueAtTime(note.gain.gain.value, now)
  note.gain.gain.linearRampToValueAtTime(0, now + synthState.release)
  note.osc.stop(now + synthState.release + 0.05)
  synthState.activeNotes.delete(idx)
  const el = document.querySelector('.synth-key[data-idx="'+idx+'"]')
  if(el) el.classList.remove('active')
}

function synthKeyDown(e){
  if(!synthState) return
  // Don't capture when typing in terminal or inputs
  const tag = document.activeElement.tagName
  if(tag === 'INPUT' || tag === 'TEXTAREA' || document.activeElement.isContentEditable) return
  // Only capture when synth popup is visible
  const popup = document.getElementById('synth-popup')
  if(!popup || !popup.classList.contains('show')) return

  const k = e.key.toLowerCase()
  if(SYNTH_KEY_MAP.hasOwnProperty(k)){
    e.preventDefault()
    const idx = SYNTH_KEY_MAP[k]
    if(!synthState.activeNotes.has(idx)) synthNoteOn(idx)
  }
}

function synthKeyUp(e){
  if(!synthState) return
  const k = e.key.toLowerCase()
  if(SYNTH_KEY_MAP.hasOwnProperty(k)){
    synthNoteOff(SYNTH_KEY_MAP[k])
  }
}

function setSynthWave(w){
  if(!synthState) return
  synthState.waveform = w
  document.querySelectorAll('.synth-wave-btn').forEach(b =>
    b.classList.toggle('active', b.dataset.wave === w))
}

function synthShiftOctave(dir){
  if(!synthState) return
  synthState.octaveShift = Math.max(-2, Math.min(3, synthState.octaveShift + dir))
  synthUpdateOctDisplay()
}

function synthUpdateOctDisplay(){
  const base = 3 + synthState.octaveShift
  const el = document.getElementById('synth-octave-display')
  if(el) el.textContent = 'OCT ' + base + '-' + (base+1)
}

function updateSynthADSR(){
  if(!synthState) return
  synthState.attack = parseInt(document.getElementById('synth-attack').value) / 1000
  synthState.decay = parseInt(document.getElementById('synth-decay').value) / 1000
  synthState.sustain = parseInt(document.getElementById('synth-sustain').value) / 100
  synthState.release = parseInt(document.getElementById('synth-release').value) / 1000
  document.getElementById('synth-atk-val').textContent = Math.round(synthState.attack*1000)+'ms'
  document.getElementById('synth-dec-val').textContent = Math.round(synthState.decay*1000)+'ms'
  document.getElementById('synth-sus-val').textContent = Math.round(synthState.sustain*100)+'%'
  document.getElementById('synth-rel-val').textContent = Math.round(synthState.release*1000)+'ms'
}

function updateSynthFilter(){
  if(!synthState) return
  synthState.filter.frequency.value = parseFloat(document.getElementById('synth-cutoff').value)
  synthState.filter.Q.value = parseFloat(document.getElementById('synth-reso').value)
  document.getElementById('synth-cut-val').textContent = Math.round(synthState.filter.frequency.value)+' Hz'
  document.getElementById('synth-res-val').textContent = synthState.filter.Q.value.toFixed(1)
}

function updateSynthVol(){
  if(!synthState) return
  const v = parseInt(document.getElementById('synth-volume').value) / 100
  synthState.master.gain.value = v
  document.getElementById('synth-vol-val').textContent = Math.round(v*100)+'%'
}

// ‚îÄ‚îÄ Synth Sequencer Grid (uses shared transport) ‚îÄ‚îÄ

function synthRenderGrid(){
  const grid = document.getElementById('synth-seq-grid')
  if(!grid || !synthState) return
  grid.innerHTML = ''
  for(let i=0;i<16;i++){
    const s = document.createElement('div')
    s.className = 'synth-step'
    s.dataset.step = i
    if(synthState.seq[i]){
      s.classList.add('has-note')
      s.textContent = synthState.seq[i].name
    } else {
      s.textContent = (i+1)
    }
    s.onclick = ()=>{
      if(synthState.seq[i]) synthState.seq[i] = null
      synthRenderGrid()
    }
    grid.appendChild(s)
  }
}

function synthUpdateStepHighlight(){
  document.querySelectorAll('.synth-step').forEach((el,i)=>{
    el.classList.toggle('playing', transport.playing && i === transport.step)
  })
}

function synthClearSeq(){
  if(!synthState) return
  synthState.seq = new Array(16).fill(null)
  synthRenderGrid()
}

// Synth BPM slider updates shared transport
function updateSynthBPM(){
  const bpm = parseInt(document.getElementById('synth-bpm').value)
  document.getElementById('synth-bpm-val').textContent = bpm
  transportSetBPM(bpm)
}

// ‚ïê‚ïê‚ïê SHARED TRANSPORT ‚ïê‚ïê‚ïê
// Single tick loop drives both synth + drums sequencers in sync

const transport = {
  bpm: 120, step: 0, playing: false, recording: false,
  recStep: 0, timer: null
}

function transportPlay(){
  if(transport.playing) return
  transport.playing = true
  transport.step = 0
  transportUpdateButtons()
  const stepMs = ()=> (60 / transport.bpm) * 1000 / 4

  function tick(){
    if(!transport.playing) return
    // Synth tick
    if(synthState){
      synthUpdateStepHighlight()
      const note = synthState.seq[transport.step]
      if(note){
        synthNoteOn(note.idx)
        setTimeout(()=> synthNoteOff(note.idx), stepMs() * 0.75)
      }
    }
    // Drums tick
    if(drumState){
      for(let p=0;p<8;p++){
        if(drumState.grid[p][transport.step]) drumHit(p)
      }
      drumUpdateStepHighlight()
    }
    transport.step = (transport.step + 1) % 16
    transport.timer = setTimeout(tick, stepMs())
  }
  tick()
}

function transportStop(){
  transport.playing = false
  if(transport.timer){ clearTimeout(transport.timer); transport.timer = null }
  transport.step = 0
  transportUpdateButtons()
  if(synthState) synthUpdateStepHighlight()
  if(drumState) drumUpdateStepHighlight()
}

function transportToggle(){
  if(transport.playing) transportStop()
  else transportPlay()
}

function transportToggleRec(){
  transport.recording = !transport.recording
  if(transport.recording) transport.recStep = 0
  transportUpdateButtons()
}

function transportSetBPM(bpm){
  transport.bpm = Math.max(60, Math.min(200, bpm))
  // Sync both BPM sliders
  const synthBpm = document.getElementById('synth-bpm')
  const drumsBpm = document.getElementById('drums-bpm')
  const synthVal = document.getElementById('synth-bpm-val')
  const drumsVal = document.getElementById('drums-bpm-val')
  if(synthBpm) synthBpm.value = transport.bpm
  if(drumsBpm) drumsBpm.value = transport.bpm
  if(synthVal) synthVal.textContent = transport.bpm
  if(drumsVal) drumsVal.textContent = transport.bpm
  if(transport.playing){ transportStop(); transportPlay() }
}

function transportUpdateButtons(){
  // Update synth buttons
  const synthPlay = document.getElementById('synth-play-btn')
  const synthRec = document.getElementById('synth-rec-btn')
  if(synthPlay){
    synthPlay.classList.toggle('stop-active', transport.playing)
    synthPlay.textContent = transport.playing ? '‚ñ† STOP' : '‚ñ∂ PLAY'
  }
  if(synthRec) synthRec.classList.toggle('active', transport.recording)
  // Update drums buttons
  const drumsPlay = document.getElementById('drums-play-btn')
  const drumsRec = document.getElementById('drums-rec-btn')
  if(drumsPlay){
    drumsPlay.classList.toggle('stop-active', transport.playing)
    drumsPlay.textContent = transport.playing ? '‚ñ† STOP' : '‚ñ∂ PLAY'
  }
  if(drumsRec) drumsRec.classList.toggle('active', transport.recording)
}

// ‚ïê‚ïê‚ïê DRUMS.EXE ‚ïê‚ïê‚ïê
let drumState = null

const DRUM_NAMES = ['KICK','SNARE','HIHAT','OPEN HH','CLAP','TOM','RIM','CYMBAL']
const DRUM_KEYS = ['1','2','3','4','5','6','7','8']

function initDrums(){
  if(drumState) stopDrums()
  const AC = window.AudioContext || window.webkitAudioContext
  const ctx = new AC()
  const master = ctx.createGain()
  master.gain.value = 0.5
  master.connect(ctx.destination)

  drumState = {
    ctx, master,
    grid: Array.from({length:8}, ()=> new Array(16).fill(false))
  }

  drumRenderPads()
  drumRenderGrid()
  document.addEventListener('keydown', drumKeyDown)
  if(typeof playSFX === 'function') playSFX('ui_click', 0.3)
}

function stopDrums(){
  if(!drumState) return
  try{ drumState.ctx.close() }catch(e){}
  document.removeEventListener('keydown', drumKeyDown)
  drumState = null
}

// ‚îÄ‚îÄ Drum Synthesis ‚îÄ‚îÄ

function drumMakeNoise(ctx, duration){
  const bufSize = ctx.sampleRate * duration
  const buf = ctx.createBuffer(1, bufSize, ctx.sampleRate)
  const data = buf.getChannelData(0)
  for(let i=0;i<bufSize;i++) data[i] = Math.random()*2-1
  const src = ctx.createBufferSource()
  src.buffer = buf
  return src
}

function drumKick(ctx, dest, time){
  const osc = ctx.createOscillator()
  const gain = ctx.createGain()
  osc.type = 'sine'
  osc.frequency.setValueAtTime(150, time)
  osc.frequency.exponentialRampToValueAtTime(40, time + 0.12)
  gain.gain.setValueAtTime(1, time)
  gain.gain.exponentialRampToValueAtTime(0.01, time + 0.4)
  osc.connect(gain)
  gain.connect(dest)
  osc.start(time)
  osc.stop(time + 0.4)
}

function drumSnare(ctx, dest, time){
  // Tone
  const osc = ctx.createOscillator()
  const oscGain = ctx.createGain()
  osc.type = 'triangle'
  osc.frequency.value = 200
  oscGain.gain.setValueAtTime(0.7, time)
  oscGain.gain.exponentialRampToValueAtTime(0.01, time + 0.15)
  osc.connect(oscGain)
  oscGain.connect(dest)
  osc.start(time)
  osc.stop(time + 0.15)
  // Noise
  const noise = drumMakeNoise(ctx, 0.2)
  const nGain = ctx.createGain()
  const filt = ctx.createBiquadFilter()
  filt.type = 'bandpass'
  filt.frequency.value = 3000
  nGain.gain.setValueAtTime(0.8, time)
  nGain.gain.exponentialRampToValueAtTime(0.01, time + 0.2)
  noise.connect(filt)
  filt.connect(nGain)
  nGain.connect(dest)
  noise.start(time)
  noise.stop(time + 0.2)
}

function drumHiHat(ctx, dest, time){
  const noise = drumMakeNoise(ctx, 0.08)
  const gain = ctx.createGain()
  const filt = ctx.createBiquadFilter()
  filt.type = 'highpass'
  filt.frequency.value = 8000
  gain.gain.setValueAtTime(0.5, time)
  gain.gain.exponentialRampToValueAtTime(0.01, time + 0.06)
  noise.connect(filt)
  filt.connect(gain)
  gain.connect(dest)
  noise.start(time)
  noise.stop(time + 0.08)
}

function drumOpenHat(ctx, dest, time){
  const noise = drumMakeNoise(ctx, 0.4)
  const gain = ctx.createGain()
  const filt = ctx.createBiquadFilter()
  filt.type = 'highpass'
  filt.frequency.value = 6000
  gain.gain.setValueAtTime(0.5, time)
  gain.gain.exponentialRampToValueAtTime(0.01, time + 0.35)
  noise.connect(filt)
  filt.connect(gain)
  gain.connect(dest)
  noise.start(time)
  noise.stop(time + 0.4)
}

function drumClap(ctx, dest, time){
  for(let i=0;i<3;i++){
    const t = time + i * 0.015
    const noise = drumMakeNoise(ctx, 0.15)
    const gain = ctx.createGain()
    const filt = ctx.createBiquadFilter()
    filt.type = 'bandpass'
    filt.frequency.value = 2500
    gain.gain.setValueAtTime(0.6, t)
    gain.gain.exponentialRampToValueAtTime(0.01, t + 0.12)
    noise.connect(filt)
    filt.connect(gain)
    gain.connect(dest)
    noise.start(t)
    noise.stop(t + 0.15)
  }
}

function drumTom(ctx, dest, time){
  const osc = ctx.createOscillator()
  const gain = ctx.createGain()
  osc.type = 'sine'
  osc.frequency.setValueAtTime(200, time)
  osc.frequency.exponentialRampToValueAtTime(80, time + 0.2)
  gain.gain.setValueAtTime(0.8, time)
  gain.gain.exponentialRampToValueAtTime(0.01, time + 0.3)
  osc.connect(gain)
  gain.connect(dest)
  osc.start(time)
  osc.stop(time + 0.3)
}

function drumRim(ctx, dest, time){
  const osc = ctx.createOscillator()
  const gain = ctx.createGain()
  osc.type = 'square'
  osc.frequency.value = 800
  gain.gain.setValueAtTime(0.4, time)
  gain.gain.exponentialRampToValueAtTime(0.01, time + 0.04)
  osc.connect(gain)
  gain.connect(dest)
  osc.start(time)
  osc.stop(time + 0.05)
  // Noise click
  const noise = drumMakeNoise(ctx, 0.03)
  const nGain = ctx.createGain()
  const filt = ctx.createBiquadFilter()
  filt.type = 'highpass'
  filt.frequency.value = 5000
  nGain.gain.setValueAtTime(0.3, time)
  nGain.gain.exponentialRampToValueAtTime(0.01, time + 0.025)
  noise.connect(filt)
  filt.connect(nGain)
  nGain.connect(dest)
  noise.start(time)
  noise.stop(time + 0.03)
}

function drumCymbal(ctx, dest, time){
  const noise = drumMakeNoise(ctx, 1.5)
  const gain = ctx.createGain()
  const filt = ctx.createBiquadFilter()
  filt.type = 'bandpass'
  filt.frequency.value = 5000
  filt.Q.value = 0.5
  gain.gain.setValueAtTime(0.4, time)
  gain.gain.exponentialRampToValueAtTime(0.01, time + 1.2)
  noise.connect(filt)
  filt.connect(gain)
  gain.connect(dest)
  noise.start(time)
  noise.stop(time + 1.5)
}

const DRUM_SYNTH = [drumKick, drumSnare, drumHiHat, drumOpenHat, drumClap, drumTom, drumRim, drumCymbal]

function drumHit(padIdx){
  if(!drumState) return
  if(drumState.ctx.state === 'suspended') drumState.ctx.resume()
  const now = drumState.ctx.currentTime
  DRUM_SYNTH[padIdx](drumState.ctx, drumState.master, now)
  // Visual flash
  const pad = document.querySelector('.drum-pad[data-pad="'+padIdx+'"]')
  if(pad){
    pad.classList.add('hit')
    setTimeout(()=> pad.classList.remove('hit'), 120)
  }
  // Record ‚Äî drums toggle grid cell at current step position
  if(transport.recording){
    const step = transport.playing ? transport.step : transport.recStep
    drumState.grid[padIdx][step] = true
    drumRenderGrid()
  }
}

function drumKeyDown(e){
  if(!drumState) return
  const tag = document.activeElement.tagName
  if(tag === 'INPUT' || tag === 'TEXTAREA' || document.activeElement.isContentEditable) return
  const popup = document.getElementById('drums-popup')
  if(!popup || !popup.classList.contains('show')) return
  const idx = DRUM_KEYS.indexOf(e.key)
  if(idx !== -1){ e.preventDefault(); drumHit(idx) }
}

// ‚îÄ‚îÄ Drums UI ‚îÄ‚îÄ

function drumRenderPads(){
  const container = document.getElementById('drums-pads')
  if(!container) return
  container.innerHTML = ''
  DRUM_NAMES.forEach((name, i)=>{
    const pad = document.createElement('div')
    pad.className = 'drum-pad'
    pad.dataset.pad = i
    pad.textContent = name
    pad.onmousedown = (e)=>{e.preventDefault(); drumHit(i)}
    container.appendChild(pad)
  })
}

function drumRenderGrid(){
  const container = document.getElementById('drums-grid')
  if(!container || !drumState) return
  container.innerHTML = ''
  for(let p=0;p<8;p++){
    const row = document.createElement('div')
    row.className = 'drum-grid-row'
    const label = document.createElement('div')
    label.className = 'drum-row-label'
    label.textContent = DRUM_NAMES[p].substring(0,4)
    row.appendChild(label)
    for(let s=0;s<16;s++){
      const cell = document.createElement('div')
      cell.className = 'drum-cell'
      if(drumState.grid[p][s]) cell.classList.add('on')
      cell.dataset.pad = p
      cell.dataset.step = s
      cell.onclick = ()=>{
        drumState.grid[p][s] = !drumState.grid[p][s]
        cell.classList.toggle('on')
      }
      row.appendChild(cell)
    }
    container.appendChild(row)
  }
}

function drumUpdateStepHighlight(){
  document.querySelectorAll('.drum-cell').forEach(el=>{
    const s = parseInt(el.dataset.step)
    el.classList.toggle('playing', transport.playing && s === transport.step)
  })
}

function drumClear(){
  if(!drumState) return
  drumState.grid = Array.from({length:8}, ()=> new Array(16).fill(false))
  drumRenderGrid()
}

function updateDrumsBPM(){
  const bpm = parseInt(document.getElementById('drums-bpm').value)
  document.getElementById('drums-bpm-val').textContent = bpm
  transportSetBPM(bpm)
}

function updateDrumsVol(){
  if(!drumState) return
  const v = parseInt(document.getElementById('drums-volume').value) / 100
  drumState.master.gain.value = v
  document.getElementById('drums-vol-val').textContent = Math.round(v*100)+'%'
}

// ‚ïê‚ïê‚ïê SNAKE.EXE ‚ïê‚ïê‚ïê
let snakeGame = null;
let snakeHighScore = parseInt(localStorage.getItem(CONFIG.storage.snakeHigh)) || 0;

function initSnake() {
  document.getElementById('snake-highscore').textContent = snakeHighScore;
  const canvas = document.getElementById('snake-canvas');
  const ctx = canvas.getContext('2d');
  
  snakeGame = {
    canvas: canvas,
    ctx: ctx,
    gridSize: 20,
    tileCount: 20,
    snake: [{x: 10, y: 10}],
    dx: 0,
    dy: 0,
    food: {x: 15, y: 15},
    score: 0,
    gameLoop: null,
    isRunning: false,
    speed: 100
  };
  
  drawSnake();
  
  // Remove old listeners
  document.removeEventListener('keydown', snakeKeyHandler);
  document.addEventListener('keydown', snakeKeyHandler);
}

function snakeKeyHandler(e) {
  if (!snakeGame) return;
  
  const key = e.key.toLowerCase();
  
  // Start game with space
  if (key === ' ' && !snakeGame.isRunning) {
    e.preventDefault();
    startSnake();
    return;
  }
  
  if (!snakeGame.isRunning) return;
  
  // Prevent default for arrow keys
  if(['ArrowUp','ArrowDown','ArrowLeft','ArrowRight'].includes(e.key)) {
    e.preventDefault();
  }
  
  // Change direction (can't reverse)
  if ((key === 'arrowup' || key === 'w') && snakeGame.dy === 0) {
    snakeGame.dx = 0; snakeGame.dy = -1;
  }
  else if ((key === 'arrowdown' || key === 's') && snakeGame.dy === 0) {
    snakeGame.dx = 0; snakeGame.dy = 1;
  }
  else if ((key === 'arrowleft' || key === 'a') && snakeGame.dx === 0) {
    snakeGame.dx = -1; snakeGame.dy = 0;
  }
  else if ((key === 'arrowright' || key === 'd') && snakeGame.dx === 0) {
    snakeGame.dx = 1; snakeGame.dy = 0;
  }
}

function startSnake() {
  if (!snakeGame) return;
  
  // Reset game
  snakeGame.snake = [{x: 10, y: 10}];
  snakeGame.dx = 1;
  snakeGame.dy = 0;
  snakeGame.score = 0;
  snakeGame.isRunning = true;
  document.getElementById('snake-score').textContent = '0';
  document.getElementById('snake-game-over').classList.remove('show');
  placeFood();
  
  if (snakeGame.gameLoop) clearInterval(snakeGame.gameLoop);
  snakeGame.gameLoop = setInterval(updateSnake, snakeGame.speed);
}

function stopSnake() {
  if (snakeGame && snakeGame.gameLoop) {
    clearInterval(snakeGame.gameLoop);
    snakeGame.isRunning = false;
  }
  // Remove event listener when closing snake
  document.removeEventListener('keydown', snakeKeyHandler);
}

function updateSnake() {
  if (!snakeGame || !snakeGame.isRunning) return;
  
  // Move snake
  const head = {x: snakeGame.snake[0].x + snakeGame.dx, y: snakeGame.snake[0].y + snakeGame.dy};
  
  // Check wall collision
  if (head.x < 0 || head.x >= snakeGame.tileCount || head.y < 0 || head.y >= snakeGame.tileCount) {
    gameOver();
    return;
  }
  
  // Check self collision
  for (let segment of snakeGame.snake) {
    if (head.x === segment.x && head.y === segment.y) {
      gameOver();
      return;
    }
  }
  
  snakeGame.snake.unshift(head);
  
  // Check food collision
  if (head.x === snakeGame.food.x && head.y === snakeGame.food.y) {
    snakeGame.score++;
    playSFX('ui_click',0.4);
    document.getElementById('snake-score').textContent = snakeGame.score;
    placeFood();
    
    // Speed up slightly
    if (snakeGame.score % 5 === 0 && snakeGame.speed > 50) {
      snakeGame.speed -= 5;
      clearInterval(snakeGame.gameLoop);
      snakeGame.gameLoop = setInterval(updateSnake, snakeGame.speed);
    }
  } else {
    snakeGame.snake.pop();
  }
  
  drawSnake();
}

function placeFood() {
  if (!snakeGame) return;
  let validPosition = false;
  
  while (!validPosition) {
    snakeGame.food.x = Math.floor(Math.random() * snakeGame.tileCount);
    snakeGame.food.y = Math.floor(Math.random() * snakeGame.tileCount);
    
    validPosition = true;
    for (let segment of snakeGame.snake) {
      if (segment.x === snakeGame.food.x && segment.y === snakeGame.food.y) {
        validPosition = false;
        break;
      }
    }
  }
}

function drawSnake() {
  if (!snakeGame) return;
  
  const ctx = snakeGame.ctx;
  const size = snakeGame.gridSize;
  
  // Clear canvas
  ctx.fillStyle = '#000';
  ctx.fillRect(0, 0, snakeGame.canvas.width, snakeGame.canvas.height);
  
  // Draw grid
  ctx.strokeStyle = 'rgba(0,255,65,0.1)';
  ctx.lineWidth = 1;
  for (let i = 0; i <= snakeGame.tileCount; i++) {
    ctx.beginPath();
    ctx.moveTo(i * size, 0);
    ctx.lineTo(i * size, snakeGame.canvas.height);
    ctx.stroke();
    ctx.beginPath();
    ctx.moveTo(0, i * size);
    ctx.lineTo(snakeGame.canvas.width, i * size);
    ctx.stroke();
  }
  
  // Draw snake
  snakeGame.snake.forEach((segment, index) => {
    ctx.fillStyle = index === 0 ? CONFIG.colors.green : 'rgba(0,255,65,0.7)';
    ctx.fillRect(segment.x * size + 1, segment.y * size + 1, size - 2, size - 2);
  });
  
  // Draw food
  ctx.fillStyle = '#ff0000';
  ctx.fillRect(snakeGame.food.x * size + 2, snakeGame.food.y * size + 2, size - 4, size - 4);
}

function gameOver() {
  if (!snakeGame) return;
  playSFX('glitch_error',0.5);
  snakeGame.isRunning = false;
  clearInterval(snakeGame.gameLoop);
  
  document.getElementById('snake-final-score').textContent = snakeGame.score;
  document.getElementById('snake-game-over').classList.add('show');
  
  // Update high score
  if (snakeGame.score > snakeHighScore) {
    snakeHighScore = snakeGame.score;
    localStorage.setItem(CONFIG.storage.snakeHigh, snakeHighScore);
    document.getElementById('snake-highscore').textContent = snakeHighScore;
  }
}

// ‚ïê‚ïê‚ïê TRON.EXE ‚ïê‚ïê‚ïê
let tronGame = null;
let tronWins = parseInt(localStorage.getItem(CONFIG.storage.tronWins)) || 0;

function initTron() {
  document.getElementById('tron-wins').textContent = tronWins;
  const canvas = document.getElementById('tron-canvas');
  const ctx = canvas.getContext('2d');

  tronGame = {
    canvas: canvas,
    ctx: ctx,
    cellSize: 10,
    gridW: 40,
    gridH: 40,
    player: {x:5, y:35, dx:0, dy:-1, trail:[]},
    ai: {x:35, y:5, dx:0, dy:1, trail:[]},
    grid: null,
    gameLoop: null,
    isRunning: false,
    speed: 80
  };

  tronGame.grid = Array.from({length:40}, ()=>Array(40).fill(0));
  drawTron();

  document.removeEventListener('keydown', tronKeyHandler);
  document.addEventListener('keydown', tronKeyHandler);
}

function tronKeyHandler(e) {
  if (!tronGame) return;

  const key = e.key.toLowerCase();

  if (key === ' ' && !tronGame.isRunning) {
    e.preventDefault();
    startTron();
    return;
  }

  if (!tronGame.isRunning) return;

  if(['ArrowUp','ArrowDown','ArrowLeft','ArrowRight'].includes(e.key)) {
    e.preventDefault();
  }

  const p = tronGame.player;
  if ((key === 'arrowup' || key === 'w') && p.dy === 0) { p.dx=0; p.dy=-1; }
  else if ((key === 'arrowdown' || key === 's') && p.dy === 0) { p.dx=0; p.dy=1; }
  else if ((key === 'arrowleft' || key === 'a') && p.dx === 0) { p.dx=-1; p.dy=0; }
  else if ((key === 'arrowright' || key === 'd') && p.dx === 0) { p.dx=1; p.dy=0; }
}

function startTron() {
  if (!tronGame) return;

  tronGame.grid = Array.from({length:40}, ()=>Array(40).fill(0));
  tronGame.player = {x:5, y:35, dx:0, dy:-1, trail:[]};
  tronGame.ai = {x:35, y:5, dx:0, dy:1, trail:[]};
  tronGame.isRunning = true;

  // Mark starting positions
  tronGame.grid[35][5] = 1; // player = 1
  tronGame.grid[5][35] = 2; // ai = 2
  tronGame.player.trail.push({x:5,y:35});
  tronGame.ai.trail.push({x:35,y:5});

  document.getElementById('tron-game-over').classList.remove('show');
  document.getElementById('tron-round-result').textContent = '';

  if (tronGame.gameLoop) clearInterval(tronGame.gameLoop);
  tronGame.gameLoop = setInterval(updateTron, tronGame.speed);
}

function stopTron() {
  if (tronGame && tronGame.gameLoop) {
    clearInterval(tronGame.gameLoop);
    tronGame.isRunning = false;
  }
  document.removeEventListener('keydown', tronKeyHandler);
}

function tronAI() {
  const ai = tronGame.ai;
  const p = tronGame.player;
  const g = tronGame.grid;
  const w = tronGame.gridW;
  const h = tronGame.gridH;

  // Possible directions: forward, turn left, turn right
  const dirs = [];
  // Current direction
  dirs.push({dx:ai.dx, dy:ai.dy});
  // Turn left (rotate -90)
  dirs.push({dx:ai.dy, dy:-ai.dx});
  // Turn right (rotate +90)
  dirs.push({dx:-ai.dy, dy:ai.dx});

  function isSafe(x, y) {
    return x >= 0 && x < w && y >= 0 && y < h && g[y][x] === 0;
  }

  function lookAhead(dx, dy, steps) {
    let safe = 0;
    let x = ai.x, y = ai.y;
    for (let i = 0; i < steps; i++) {
      x += dx; y += dy;
      if (!isSafe(x, y)) break;
      safe++;
    }
    return safe;
  }

  // Score each direction
  let best = null;
  let bestScore = -1;

  for (const d of dirs) {
    const nx = ai.x + d.dx;
    const ny = ai.y + d.dy;
    if (!isSafe(nx, ny)) continue;

    // Look ahead score (how many open cells)
    let score = lookAhead(d.dx, d.dy, 10) * 10;

    // Bonus for moving toward player (aggression)
    const distBefore = Math.abs(ai.x - p.x) + Math.abs(ai.y - p.y);
    const distAfter = Math.abs(nx - p.x) + Math.abs(ny - p.y);
    if (distAfter < distBefore) score += 3;

    // Add randomness
    score += Math.random() * 5;

    if (score > bestScore) {
      bestScore = score;
      best = d;
    }
  }

  if (best) {
    ai.dx = best.dx;
    ai.dy = best.dy;
  }
}

function updateTron() {
  if (!tronGame || !tronGame.isRunning) return;

  const p = tronGame.player;
  const ai = tronGame.ai;
  const g = tronGame.grid;
  const w = tronGame.gridW;
  const h = tronGame.gridH;

  // AI decides direction
  tronAI();

  // Move both bikes
  const pnx = p.x + p.dx;
  const pny = p.y + p.dy;
  const anx = ai.x + ai.dx;
  const any_ = ai.y + ai.dy;

  // Check collisions
  const pDead = pnx < 0 || pnx >= w || pny < 0 || pny >= h || g[pny][pnx] !== 0;
  const aiDead = anx < 0 || anx >= w || any_ < 0 || any_ >= h || g[any_][anx] !== 0;

  // Head-on collision (both try same cell)
  const headOn = pnx === anx && pny === any_;

  if (headOn || (pDead && aiDead)) {
    tronGameOver(false, 'DRAW');
    return;
  }
  if (pDead) {
    tronGameOver(false);
    return;
  }
  if (aiDead) {
    tronGameOver(true);
    return;
  }

  // Move player
  p.x = pnx; p.y = pny;
  p.trail.push({x:p.x, y:p.y});
  g[p.y][p.x] = 1;

  // Move AI
  ai.x = anx; ai.y = any_;
  ai.trail.push({x:ai.x, y:ai.y});
  g[ai.y][ai.x] = 2;

  drawTron();
}

function drawTron() {
  if (!tronGame) return;

  const ctx = tronGame.ctx;
  const cs = tronGame.cellSize;
  const w = tronGame.canvas.width;
  const h = tronGame.canvas.height;

  // Clear
  ctx.fillStyle = '#0a0a2e';
  ctx.fillRect(0, 0, w, h);

  // Draw grid lines
  ctx.strokeStyle = 'rgba(0,255,255,0.08)';
  ctx.lineWidth = 1;
  for (let i = 0; i <= tronGame.gridW; i++) {
    ctx.beginPath();
    ctx.moveTo(i * cs, 0);
    ctx.lineTo(i * cs, h);
    ctx.stroke();
    ctx.beginPath();
    ctx.moveTo(0, i * cs);
    ctx.lineTo(w, i * cs);
    ctx.stroke();
  }

  // Draw player trail
  ctx.shadowBlur = 4;
  ctx.shadowColor = '#00ffff';
  tronGame.player.trail.forEach(t => {
    ctx.fillStyle = 'rgba(0,255,255,0.6)';
    ctx.fillRect(t.x * cs + 1, t.y * cs + 1, cs - 2, cs - 2);
  });

  // Draw AI trail
  ctx.shadowColor = '#ff6600';
  tronGame.ai.trail.forEach(t => {
    ctx.fillStyle = 'rgba(255,102,0,0.6)';
    ctx.fillRect(t.x * cs + 1, t.y * cs + 1, cs - 2, cs - 2);
  });

  // Draw bike heads (brighter)
  if (tronGame.player.trail.length > 0) {
    ctx.shadowColor = '#00ffff';
    ctx.shadowBlur = 8;
    ctx.fillStyle = '#00ffff';
    ctx.fillRect(tronGame.player.x * cs, tronGame.player.y * cs, cs, cs);
  }
  if (tronGame.ai.trail.length > 0) {
    ctx.shadowColor = '#ff6600';
    ctx.shadowBlur = 8;
    ctx.fillStyle = '#ff6600';
    ctx.fillRect(tronGame.ai.x * cs, tronGame.ai.y * cs, cs, cs);
  }

  ctx.shadowBlur = 0;
}

function tronGameOver(playerWon, draw) {
  if (!tronGame) return;
  playSFX('glitch_error', 0.5);
  tronGame.isRunning = false;
  clearInterval(tronGame.gameLoop);

  let msg;
  if (draw) {
    msg = 'MUTUAL DERESOLUTION';
  } else if (playerWon) {
    msg = 'End of line.';
    tronWins++;
    localStorage.setItem(CONFIG.storage.tronWins, tronWins);
    document.getElementById('tron-wins').textContent = tronWins;
  } else {
    msg = 'DEREZZED';
  }

  document.getElementById('tron-game-over-text').textContent = msg;
  document.getElementById('tron-final-wins').textContent = tronWins;
  document.getElementById('tron-game-over').classList.add('show');
}

// ‚ïê‚ïê‚ïê CALC.EXE ‚ïê‚ïê‚ïê
let calcValue = '0';
function calcPress(val) {
  if (calcValue === '0') calcValue = val;
  else calcValue += val;
  document.getElementById('calc-display').textContent = calcValue;
}
function calcEqual() {
  try {
    if (!/^[0-9+\-*/().\s]+$/.test(calcValue)) throw new Error('Invalid');
    calcValue = String(eval(calcValue));
    document.getElementById('calc-display').textContent = calcValue;
  } catch(e) {
    document.getElementById('calc-display').textContent = 'Error';
    calcValue = '0';
  }
}
function calcClear() {
  calcValue = '0';
  document.getElementById('calc-display').textContent = '0';
}

// ‚ïê‚ïê‚ïê MATRIX.EXE ‚ïê‚ïê‚ïê
let matrixInterval = null;
function startMatrix() {
  const canvas = document.getElementById('matrix-canvas');
  const ctx = canvas.getContext('2d');
  canvas.width = 300;
  canvas.height = 300;
  
  const chars = 'ABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789@#$%^&*()';
  const fontSize = 14;
  const columns = canvas.width / fontSize;
  const drops = [];
  for (let i = 0; i < columns; i++) drops[i] = 1;
  
  matrixInterval = setInterval(() => {
    ctx.fillStyle = 'rgba(0, 0, 0, 0.05)';
    ctx.fillRect(0, 0, canvas.width, canvas.height);
    ctx.fillStyle = '#0f0';
    ctx.font = fontSize + 'px monospace';
    
    for (let i = 0; i < drops.length; i++) {
      const text = chars[Math.floor(Math.random() * chars.length)];
      ctx.fillText(text, i * fontSize, drops[i] * fontSize);
      if (drops[i] * fontSize > canvas.height && Math.random() > 0.975) {
        drops[i] = 0;
      }
      drops[i]++;
    }
  }, 50);
}
function stopMatrix() {
  if (matrixInterval) {
    clearInterval(matrixInterval);
    matrixInterval = null;
  }
}

// ‚ïê‚ïê‚ïê POOL.EXE (8-BALL) ‚ïê‚ïê‚ïê
const Pool = {
  canvas:null, ctx:null, W:1280, H:680,
  RAIL:40, POCKET_R:22, BALL_R:11,
  balls:[], aiming:false, aimEnd:{x:0,y:0},
  power:0, maxPower:18,
  turn:1, // 1=player, 2=bot
  p1Type:null, p2Type:null,
  p1Pocketed:[], p2Pocketed:[],
  animating:false, gameOver:false, placingCue:false,
  botTimer:null,

  COLORS:[
    null,'#e8d44d','#1e5aa8','#cc2222','#6b2fa0','#e87020','#1a8a3a','#8b2020',
    '#111','#e8d44d','#1e5aa8','#cc2222','#6b2fa0','#e87020','#1a8a3a','#8b2020'
  ],
  pockets:[],

  init(){
    this.canvas=document.getElementById('pool-canvas')
    this.ctx=this.canvas.getContext('2d')
    this.canvas.width=this.W; this.canvas.height=this.H
    const R=this.RAIL
    this.pockets=[
      {x:R-2,y:R-2},{x:this.W/2,y:R-6},{x:this.W-R+2,y:R-2},
      {x:R-2,y:this.H-R+2},{x:this.W/2,y:this.H-R+6},{x:this.W-R+2,y:this.H-R+2}
    ]
    this.canvas.addEventListener('mousedown',e=>this.onDown(e))
    document.addEventListener('mousemove',e=>{if(this.aiming)this.onMove(e)})
    document.addEventListener('mouseup',e=>{if(this.aiming)this.onUp(e)})
    this.resetGame()
  },

  resetGame(){
    this.balls=[]
    this.p1Type=null;this.p2Type=null
    this.p1Pocketed=[];this.p2Pocketed=[]
    this.turn=1;this.gameOver=false;this.animating=false;this.placingCue=false
    if(this.botTimer)clearTimeout(this.botTimer)
    document.getElementById('pool-game-over').classList.remove('show')
    // Cue ball
    this.balls.push({x:this.W*0.27,y:this.H/2,vx:0,vy:0,num:0,pocketed:false})
    // Rack in triangle
    const sx=this.W*0.72, sy=this.H/2, d=this.BALL_R*2.15
    const order=[1,9,2,10,8,11,3,14,6,15,13,4,12,7,5]
    let idx=0
    for(let row=0;row<5;row++){
      for(let col=0;col<=row;col++){
        const x=sx+row*d*Math.cos(Math.PI/6)
        const y=sy+(col-row/2)*d
        this.balls.push({x,y,vx:0,vy:0,num:order[idx++],pocketed:false})
      }
    }
    this.setMsg('Click and drag from the cue ball to shoot')
    this.updateHUD()
    this.draw()
  },

  mouse(e){
    const r=this.canvas.getBoundingClientRect()
    return{x:(e.clientX-r.left)*(this.W/r.width),y:(e.clientY-r.top)*(this.H/r.height)}
  },

  onDown(e){
    if(this.gameOver){this.resetGame();return}
    if(this.animating||this.turn===2)return
    const p=this.mouse(e), cue=this.balls[0]
    if(this.placingCue){
      cue.x=Math.max(this.RAIL+this.BALL_R,Math.min(this.W*0.35,p.x))
      cue.y=Math.max(this.RAIL+this.BALL_R,Math.min(this.H-this.RAIL-this.BALL_R,p.y))
      cue.pocketed=false;this.placingCue=false
      this.setMsg('Your shot')
      this.draw();return
    }
    // Only aim if clicking near cue ball
    const dx=p.x-cue.x,dy=p.y-cue.y
    if(Math.sqrt(dx*dx+dy*dy)>80)return
    this.aiming=true;this.aimEnd=p
    this.draw()
  },

  onMove(e){
    if(!this.aiming)return
    this.aimEnd=this.mouse(e)
    const cue=this.balls[0],dx=cue.x-this.aimEnd.x,dy=cue.y-this.aimEnd.y
    this.power=Math.min(Math.sqrt(dx*dx+dy*dy)/22,this.maxPower)
    this.draw()
  },

  onUp(e){
    if(!this.aiming)return
    this.aiming=false
    const cue=this.balls[0]
    const dx=cue.x-this.aimEnd.x,dy=cue.y-this.aimEnd.y
    const dist=Math.sqrt(dx*dx+dy*dy)
    if(dist<10){this.draw();return}
    const pwr=Math.min(dist/22,this.maxPower)
    const ang=Math.atan2(dy,dx)
    cue.vx=Math.cos(ang)*pwr;cue.vy=Math.sin(ang)*pwr
    this.animating=true
    this.simulate()
  },

  shoot(vx,vy){
    const cue=this.balls[0]
    cue.vx=vx;cue.vy=vy
    this.animating=true
    this.simulate()
  },

  simulate(){
    const friction=0.993, R=this.RAIL, BR=this.BALL_R
    const pocketedThisShot=[]
    const step=()=>{
      let moving=false
      for(const b of this.balls){
        if(b.pocketed)continue
        b.x+=b.vx;b.y+=b.vy
        b.vx*=friction;b.vy*=friction
        if(Math.abs(b.vx)<0.01&&Math.abs(b.vy)<0.01){b.vx=0;b.vy=0}
        else moving=true
        // Rails
        if(b.x-BR<R){b.x=R+BR;b.vx=Math.abs(b.vx)*0.88}
        if(b.x+BR>this.W-R){b.x=this.W-R-BR;b.vx=-Math.abs(b.vx)*0.88}
        if(b.y-BR<R){b.y=R+BR;b.vy=Math.abs(b.vy)*0.88}
        if(b.y+BR>this.H-R){b.y=this.H-R-BR;b.vy=-Math.abs(b.vy)*0.88}
        // Pockets
        for(const p of this.pockets){
          const px=b.x-p.x,py=b.y-p.y
          if(Math.sqrt(px*px+py*py)<this.POCKET_R){
            b.pocketed=true;b.vx=0;b.vy=0
            if(!pocketedThisShot.includes(b.num))pocketedThisShot.push(b.num)
            break
          }
        }
      }
      // Ball-ball collisions
      for(let i=0;i<this.balls.length;i++){
        if(this.balls[i].pocketed)continue
        for(let j=i+1;j<this.balls.length;j++){
          if(this.balls[j].pocketed)continue
          const a=this.balls[i],b=this.balls[j]
          const dx=b.x-a.x,dy=b.y-a.y
          const dist=Math.sqrt(dx*dx+dy*dy)
          if(dist<BR*2&&dist>0){
            const nx=dx/dist,ny=dy/dist
            const dvx=a.vx-b.vx,dvy=a.vy-b.vy
            const dvn=dvx*nx+dvy*ny
            if(dvn>0){
              a.vx-=dvn*nx;a.vy-=dvn*ny
              b.vx+=dvn*nx;b.vy+=dvn*ny
              const overlap=BR*2-dist
              a.x-=overlap/2*nx;a.y-=overlap/2*ny
              b.x+=overlap/2*nx;b.y+=overlap/2*ny
              moving=true
            }
          }
        }
      }
      this.draw()
      if(moving)requestAnimationFrame(step)
      else{this.animating=false;this.resolveTurn(pocketedThisShot)}
    }
    requestAnimationFrame(step)
  },

  resolveTurn(pocketed){
    let foul=false, pocketedOwn=false
    // Cue ball scratch
    if(pocketed.includes(0)){
      foul=true
      this.setMsg(this.turn===1?'SCRATCH! Bot places cue ball.':'BOT SCRATCHED! Click to place cue ball.')
    }
    // Assign types on first non-cue, non-8 pocket
    if(!this.p1Type){
      const valid=pocketed.filter(n=>n!==0&&n!==8)
      if(valid.length>0){
        const first=valid[0], isSolid=first>=1&&first<=7
        if(this.turn===1){
          this.p1Type=isSolid?'solid':'stripe'
          this.p2Type=isSolid?'stripe':'solid'
        }else{
          this.p2Type=isSolid?'solid':'stripe'
          this.p1Type=isSolid?'stripe':'solid'
        }
      }
    }
    // Sort pocketed
    for(const num of pocketed){
      if(num===0||num===8)continue
      const isSolid=num>=1&&num<=7
      const ownerType=isSolid?'solid':'stripe'
      if(this.p1Type===ownerType)this.p1Pocketed.push(num)
      else this.p2Pocketed.push(num)
      if((this.turn===1&&this.p1Type===ownerType)||(this.turn===2&&this.p2Type===ownerType))pocketedOwn=true
    }
    // 8-ball check
    if(pocketed.includes(8)){
      const myPocketed=this.turn===1?this.p1Pocketed:this.p2Pocketed
      const myType=this.turn===1?this.p1Type:this.p2Type
      const needed=myType?7:999
      if(myPocketed.length>=needed&&!foul){
        this.endGame(this.turn===1)
      }else{
        this.endGame(this.turn!==1)
      }
      return
    }
    // Handle scratch
    if(foul){
      this.turn=this.turn===1?2:1
      if(this.turn===1){
        this.placingCue=true
      }else{
        // Bot places cue ball automatically
        this.balls[0].pocketed=false
        this.balls[0].x=this.W*0.27;this.balls[0].y=this.H/2
        this.placingCue=false
      }
    }else if(!pocketedOwn){
      this.turn=this.turn===1?2:1
    }
    this.updateHUD()
    this.draw()
    // Check if all of one type pocketed (for 8-ball shot)
    // Bot's turn
    if(this.turn===2&&!this.gameOver&&!this.placingCue){
      this.setMsg('Bot is thinking...')
      this.botTimer=setTimeout(()=>this.botShoot(),1200)
    }else if(this.turn===1&&!foul&&!this.gameOver){
      this.setMsg('Your shot')
    }
  },

  endGame(playerWins){
    this.gameOver=true
    const txt=document.getElementById('pool-game-over-text')
    const sub=document.getElementById('pool-game-over-sub')
    if(playerWins){
      txt.textContent='YOU WIN!'
      sub.textContent='All balls pocketed. Nice run.'
    }else{
      txt.textContent='BOT WINS'
      sub.textContent='Better luck next time.'
    }
    document.getElementById('pool-game-over').classList.add('show')
    this.updateHUD()
    try{playSFX('glitch_error',0.5)}catch(e){}
  },

  setMsg(t){const el=document.getElementById('pool-msg');if(el)el.textContent=t},

  updateHUD(){
    const turnEl=document.getElementById('pool-turn')
    if(turnEl){
      if(this.gameOver)turnEl.textContent='GAME OVER'
      else if(this.placingCue)turnEl.textContent='PLACE CUE BALL'
      else turnEl.textContent=this.turn===1?'YOUR SHOT':'BOT THINKING...'
    }
    const t1=document.getElementById('pool-p1-type')
    const t2=document.getElementById('pool-p2-type')
    if(t1)t1.textContent=this.p1Type?this.p1Type.toUpperCase():'--'
    if(t2)t2.textContent=this.p2Type?this.p2Type.toUpperCase():'--'
    const p1=document.getElementById('pool-p1-pocketed')
    const p2=document.getElementById('pool-p2-pocketed')
    if(p1)p1.innerHTML=this.p1Pocketed.map(n=>`<span class="pool-ball-icon" style="background:${this.COLORS[n]}"></span>`).join('')
    if(p2)p2.innerHTML=this.p2Pocketed.map(n=>`<span class="pool-ball-icon" style="background:${this.COLORS[n]}"></span>`).join('')
  },

  // ‚îÄ‚îÄ BOT AI (deliberately imperfect) ‚îÄ‚îÄ
  botShoot(){
    if(this.gameOver)return
    const cue=this.balls[0]
    const myType=this.p2Type
    // Get target balls
    let targets=this.balls.filter(b=>!b.pocketed&&b.num!==0&&b.num!==8)
    if(myType){
      const mine=targets.filter(b=>myType==='solid'?(b.num>=1&&b.num<=7):(b.num>=9&&b.num<=15))
      if(mine.length>0)targets=mine
      else{
        // All pocketed, go for 8
        const eight=this.balls.find(b=>b.num===8&&!b.pocketed)
        if(eight)targets=[eight]
      }
    }
    if(targets.length===0){
      // Desperation: just hit something
      targets=this.balls.filter(b=>!b.pocketed&&b.num!==0)
    }

    let bestScore=-Infinity, bestVx=3, bestVy=0
    for(const ball of targets){
      for(const pocket of this.pockets){
        // Angle: ball to pocket
        const bpx=pocket.x-ball.x, bpy=pocket.y-ball.y
        const bpd=Math.sqrt(bpx*bpx+bpy*bpy)
        // Where cue needs to hit ball (opposite side from pocket)
        const hitX=ball.x-bpx/bpd*(this.BALL_R*2)
        const hitY=ball.y-bpy/bpd*(this.BALL_R*2)
        // Cue to hit point
        const chx=hitX-cue.x, chy=hitY-cue.y
        const chd=Math.sqrt(chx*chx+chy*chy)
        if(chd<1)continue
        // Check if path is relatively clear (simple check)
        let blocked=false
        for(const ob of this.balls){
          if(ob.pocketed||ob.num===0||ob.num===ball.num)continue
          // Distance from obstacle to line cue‚ÜíhitPoint
          const t=Math.max(0,Math.min(1,((ob.x-cue.x)*chx+(ob.y-cue.y)*chy)/(chd*chd)))
          const cx=cue.x+t*chx,cy=cue.y+t*chy
          const od=Math.sqrt((ob.x-cx)*(ob.x-cx)+(ob.y-cy)*(ob.y-cy))
          if(od<this.BALL_R*2.5){blocked=true;break}
        }
        // Score this shot
        let score=0
        score+=500/bpd // closer ball-to-pocket = better
        score+=300/chd // closer cue-to-ball = better
        if(blocked)score*=0.15 // heavily penalize blocked shots
        // Angle quality: how straight is cue‚Üíball‚Üípocket?
        const ang1=Math.atan2(chy,chx)
        const ang2=Math.atan2(bpy,bpx)
        let angDiff=Math.abs(ang1-ang2)
        if(angDiff>Math.PI)angDiff=2*Math.PI-angDiff
        score*=Math.max(0.1,1-angDiff/Math.PI) // straighter = better

        if(score>bestScore){
          bestScore=score
          // Calculate velocity
          const pwr=Math.min(6+chd/80,this.maxPower*0.8)
          bestVx=(chx/chd)*pwr
          bestVy=(chy/chd)*pwr
        }
      }
    }

    // 20% chance to pick a worse shot (randomize aim more)
    if(Math.random()<0.2){
      const wobble=(Math.random()-0.5)*0.5
      const cos=Math.cos(wobble),sin=Math.sin(wobble)
      const nvx=bestVx*cos-bestVy*sin
      const nvy=bestVx*sin+bestVy*cos
      bestVx=nvx;bestVy=nvy
    }

    // Add aim wobble (¬±3-8 degrees)
    const wobbleDeg=(3+Math.random()*5)*(Math.random()<0.5?1:-1)
    const wobbleRad=wobbleDeg*Math.PI/180
    const wcos=Math.cos(wobbleRad),wsin=Math.sin(wobbleRad)
    const fvx=bestVx*wcos-bestVy*wsin
    const fvy=bestVx*wsin+bestVy*wcos

    // Power variance ¬±15%
    const pwrMult=0.85+Math.random()*0.3

    this.setMsg('Bot shoots!')
    this.shoot(fvx*pwrMult,fvy*pwrMult)
  },

  // ‚îÄ‚îÄ DRAW ‚îÄ‚îÄ
  draw(){
    const ctx=this.ctx, W=this.W, H=this.H, R=this.RAIL
    if(!ctx)return

    // Table
    ctx.fillStyle='#1a6b2a';ctx.fillRect(0,0,W,H)
    // Felt texture (subtle)
    ctx.fillStyle='rgba(0,0,0,0.05)'
    for(let i=0;i<W;i+=4)for(let j=0;j<H;j+=4){if(Math.random()>0.7)ctx.fillRect(i,j,2,2)}
    // Rails
    ctx.fillStyle='#4a2f15';ctx.fillRect(0,0,W,R);ctx.fillRect(0,H-R,W,R)
    ctx.fillRect(0,0,R,H);ctx.fillRect(W-R,0,R,H)
    // Rail inner edge
    ctx.strokeStyle='#2a5a1a';ctx.lineWidth=3;ctx.strokeRect(R,R,W-R*2,H-R*2)
    // Pocket cuts in rail
    ctx.fillStyle='#1a6b2a'
    for(const p of this.pockets){
      ctx.beginPath();ctx.arc(p.x,p.y,this.POCKET_R+6,0,Math.PI*2);ctx.fill()
    }
    // Pockets
    for(const p of this.pockets){
      ctx.beginPath();ctx.arc(p.x,p.y,this.POCKET_R,0,Math.PI*2)
      ctx.fillStyle='#0a0a0a';ctx.fill()
      ctx.strokeStyle='#333';ctx.lineWidth=2;ctx.stroke()
    }
    // Head string (quarter line)
    ctx.beginPath();ctx.setLineDash([6,8])
    ctx.moveTo(this.W*0.35,R);ctx.lineTo(this.W*0.35,H-R)
    ctx.strokeStyle='rgba(255,255,255,0.08)';ctx.lineWidth=1;ctx.stroke()
    ctx.setLineDash([])
    // Foot spot
    ctx.beginPath();ctx.arc(this.W*0.72,H/2,3,0,Math.PI*2)
    ctx.fillStyle='rgba(255,255,255,0.15)';ctx.fill()

    // Balls
    for(const b of this.balls){
      if(b.pocketed)continue
      const x=b.x,y=b.y,br=this.BALL_R
      ctx.save()
      if(b.num===0){
        // Cue ball
        ctx.beginPath();ctx.arc(x,y,br,0,Math.PI*2)
        ctx.fillStyle='#f0f0f0';ctx.fill()
        ctx.strokeStyle='#ddd';ctx.lineWidth=0.5;ctx.stroke()
        // Sheen
        ctx.beginPath();ctx.arc(x-3,y-3,3,0,Math.PI*2)
        ctx.fillStyle='rgba(255,255,255,0.5)';ctx.fill()
      }else{
        const isStripe=b.num>=9
        if(isStripe){
          ctx.beginPath();ctx.arc(x,y,br,0,Math.PI*2)
          ctx.fillStyle='#f0f0f0';ctx.fill()
          // Stripe band
          ctx.save();ctx.beginPath();ctx.arc(x,y,br,0,Math.PI*2);ctx.clip()
          ctx.fillStyle=this.COLORS[b.num]
          ctx.fillRect(x-br,y-br*0.4,br*2,br*0.8)
          ctx.restore()
        }else{
          ctx.beginPath();ctx.arc(x,y,br,0,Math.PI*2)
          ctx.fillStyle=this.COLORS[b.num];ctx.fill()
        }
        // Number dot
        ctx.beginPath();ctx.arc(x,y,5,0,Math.PI*2)
        ctx.fillStyle='#fff';ctx.fill()
        ctx.fillStyle='#000';ctx.font='bold 7px sans-serif'
        ctx.textAlign='center';ctx.textBaseline='middle'
        ctx.fillText(b.num,x,y+0.5)
        // Outline
        ctx.beginPath();ctx.arc(x,y,br,0,Math.PI*2)
        ctx.strokeStyle='rgba(0,0,0,0.25)';ctx.lineWidth=0.8;ctx.stroke()
        // Sheen
        ctx.beginPath();ctx.arc(x-2,y-2,2.5,0,Math.PI*2)
        ctx.fillStyle='rgba(255,255,255,0.3)';ctx.fill()
      }
      ctx.restore()
    }

    // Aiming line
    if(this.aiming&&!this.balls[0].pocketed&&this.turn===1){
      const cue=this.balls[0]
      const dx=cue.x-this.aimEnd.x,dy=cue.y-this.aimEnd.y
      const dist=Math.sqrt(dx*dx+dy*dy)
      if(dist>10){
        const ang=Math.atan2(dy,dx)
        // Cue stick
        ctx.beginPath()
        ctx.moveTo(this.aimEnd.x,this.aimEnd.y)
        ctx.lineTo(cue.x-Math.cos(ang)*this.BALL_R,cue.y-Math.sin(ang)*this.BALL_R)
        ctx.strokeStyle='#8B6914';ctx.lineWidth=4;ctx.stroke()
        ctx.strokeStyle='#5a4510';ctx.lineWidth=2;ctx.stroke()
        // Aim line
        ctx.beginPath();ctx.setLineDash([4,8])
        ctx.moveTo(cue.x,cue.y)
        ctx.lineTo(cue.x+Math.cos(ang)*200,cue.y+Math.sin(ang)*200)
        ctx.strokeStyle='rgba(255,255,255,0.25)';ctx.lineWidth=1;ctx.stroke()
        ctx.setLineDash([])
        // Ghost ball (where cue will go)
        const ghostDist=80
        ctx.beginPath()
        ctx.arc(cue.x+Math.cos(ang)*ghostDist,cue.y+Math.sin(ang)*ghostDist,this.BALL_R,0,Math.PI*2)
        ctx.strokeStyle='rgba(255,255,255,0.12)';ctx.lineWidth=1;ctx.stroke()
        // Power bar
        const pct=this.power/this.maxPower
        const barW=W-R*2-40,barH=10
        const barX=R+20,barY=H-R+14
        ctx.fillStyle=pct>0.7?'#ff4040':pct>0.4?CONFIG.colors.amber:CONFIG.colors.green
        ctx.fillRect(barX,barY,barW*pct,barH)
        ctx.strokeStyle='#555';ctx.lineWidth=1;ctx.strokeRect(barX,barY,barW,barH)
        ctx.fillStyle='rgba(255,255,255,0.5)';ctx.font='9px sans-serif'
        ctx.textAlign='center';ctx.fillText('POWER',W/2,barY+barH+10)
      }
    }

    // Placing cue ball indicator
    if(this.placingCue&&this.turn===1){
      const mx=this.W*0.35
      ctx.fillStyle='rgba(255,255,255,0.03)'
      ctx.fillRect(R,R,mx-R,H-R*2)
      ctx.fillStyle='rgba(255,255,255,0.4)';ctx.font='14px VT323, monospace'
      ctx.textAlign='center';ctx.fillText('CLICK TO PLACE CUE BALL',mx/2+R/2,H/2)
    }
  }
}

function closePool(){
  document.getElementById('pool-popup').classList.remove('show')
  if(Pool.botTimer)clearTimeout(Pool.botTimer)
  WindowRegistry.updateIndicators()
}

// ‚ïê‚ïê‚ïê FILES.EXE ‚ïê‚ïê‚ïê
const FILE_SYSTEM=[
  {name:'manifest.log',icon:'üìÑ',size:'1.2 KB',date:'‚ñà‚ñà/‚ñà‚ñà/‚ñà‚ñà',secret:'CAT_MANIFEST',always:true,
   content:()=>{
     let t='<div class="file-heading">‚îÄ‚îÄ MANIFEST ‚îÄ‚îÄ</div>\n';
     t+='ORIGIN:    R‚ñà‚ñàACT‚ñà‚ñà CLUB\n';
     t+='<span class="file-error">PROJECT:   [CLASSIFIED]</span>\n';
     t+=`FILES:     ${CONFIG.tracks.length} indexed\n`;
     t+='<span class="file-error">INTEGRITY: COMPROMISED</span>\n';
     t+='RELEASE:   ‚ñà‚ñà/‚ñà‚ñà/‚ñà‚ñà‚ñà‚ñà\n';
     t+='FORMAT:    320kbps MP3 (WAV originals archived)\n';
     t+='ENCODER:   LAME 3.100\n\n';
     t+='<span class="file-dim">‚îÄ‚îÄ TRACK INDEX ‚îÄ‚îÄ</span>\n';
     CONFIG.tracks.forEach((tk,i)=>{
       const n=String(i+1).padStart(2,'0');
       const unlocked=tk.visible||state.discovered.has(tk.id);
       if(unlocked)t+=`  [${n}] ${tk.id} ‚Äî ${tk.title}\n`;
       else t+=`  <span class="file-error">[${n}] ${tk.id} ‚Äî ‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà [ENCRYPTED]</span>\n`;
     });
     t+='\n<span class="file-ghost">NOTE: not all files are visible in standard directory listing</span>\n';
     t+='<span class="file-ghost">Some payloads require decryption keys obtained via signal intercept</span>';
     return t;
   }},
  {name:'system.log',icon:'üìã',size:'2.8 KB',date:'‚ñà‚ñà/‚ñà‚ñà/‚ñà‚ñà',secret:'CAT_SYSLOG',always:true,
   content:()=>{
     const m=state.progression.milestones;
     let t='<div class="file-heading">‚îÄ‚îÄ SYSTEM LOG ‚îÄ‚îÄ</div>\n';
     t+='<span class="file-dim">[BOOT] System boot ......................... OK</span>\n';
     t+='<span class="file-dim">[BOOT] Audio subsystem ..................... LOADED</span>\n';
     t+='<span class="file-dim">[BOOT] Network interface ................... OFFLINE</span>\n';
     t+='<span class="file-dim">[BOOT] Crypto module ....................... PARTIAL FAILURE</span>\n';
     t+='<span class="file-dim">[BOOT] File integrity check ................ 4/7 PASSED</span>\n\n';
     t+='<span class="file-warn">[WARN] 3 files encrypted ‚Äî decryption keys missing</span>\n';
     t+='<span class="file-warn">[WARN] Signal detected at frequency 97.7 MHz</span>\n';
     t+='<span class="file-ghost">[????] something ‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà the noise floor</span>\n';
     t+='<span class="file-ghost">[????] carrier wave ‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà on sub-band</span>\n';
     if(m.includes('EXPLORATION')){
       t+='\n<span class="file-warn">[NEW ENTRY]</span>\n';
       t+='<span class="file-dim">[SCAN] Anomaly detected in spectrum analyzer module</span>\n';
       t+='<span class="file-dim">[SCAN] SCANNER.EXE attempting to connect.........</span>\n';
       t+='<span class="file-dim">[SCAN] Authorization: PENDING</span>\n';
       t+='<span class="file-ghost">[SCAN] Recommendation: run spectrum scan to investigate</span>\n';
     }
     if(m.includes('SIGNAL_DISCOVERY')){
       t+='\n<span class="file-warn">[DECRYPTED ENTRY]</span>\n';
       t+='<span class="file-dim">[LOCK] Signal intercept confirmed at ‚ñà‚ñà‚ñà.‚ñà MHz</span>\n';
       t+='<span class="file-ghost">[LOCK] Secondary carrier detected ‚Äî frequency 108.0</span>\n';
       t+='<span class="file-dim">[LOCK] Cross-reference: SECURE.EXE access code database</span>\n';
       t+='<span class="file-warn">[LOCK] WARNING: additional signals may exist beyond standard band</span>\n';
     }
     if(m.includes('DEEP_SCAN')){
       t+='\n<span class="file-error">[ALERT] Multiple signal locks detected</span>\n';
       t+='<span class="file-dim">[SYS] Decryption subsystem under heavy load</span>\n';
       t+='<span class="file-ghost">[SYS] Intercepted transmission fragment cached to transmission.log</span>\n';
     }
     return t;
   }},
  {name:'frequencies.log',icon:'üìä',size:'1.6 KB',date:'‚ñà‚ñà/‚ñà‚ñà/‚ñà‚ñà',secret:'CAT_FREQ',always:true,
   content:()=>{
     const m=state.progression.milestones;
     let t='<div class="file-heading">‚îÄ‚îÄ FREQUENCY ANALYSIS ‚îÄ‚îÄ</div>\n';
     t+='Scan range: 85.0 ‚Äî 120.0 MHz\n';
     t+='Noise floor: -40 dBm\n';
     t+='Scan date: ‚ñà‚ñà/‚ñà‚ñà/‚ñà‚ñà‚ñà‚ñà\n\n';
     t+='<span class="file-dim">  85.0  ‚îÄ‚îÄ‚îÄ‚îÄ ‚ñë‚ñë background radiation</span>\n';
     t+='<span class="file-dim">  88.1  ‚îÄ‚îÄ‚îÄ‚îÄ ‚ñë‚ñë noise</span>\n';
     t+='<span class="file-dim">  91.4  ‚îÄ‚îÄ‚îÄ‚îÄ ‚ñë‚ñë noise</span>\n';
     t+='<span class="file-dim">  93.2  ‚îÄ‚îÄ‚îÄ‚îÄ ‚ñë‚ñë noise</span>\n';
     t+='<span class="file-warn">  97.7  ‚îÄ‚îÄ‚îÄ‚îÄ ‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì  ‚Üê SIGNAL DETECTED</span>\n';
     t+='<span class="file-dim">  100.5 ‚îÄ‚îÄ‚îÄ‚îÄ ‚ñë‚ñë noise</span>\n';
     t+='<span class="file-dim">  102.3 ‚îÄ‚îÄ‚îÄ‚îÄ ‚ñë‚ñë noise</span>\n';
     t+='<span class="file-dim">  105.6 ‚îÄ‚îÄ‚îÄ‚îÄ ‚ñë‚ñë noise</span>\n';
     t+='<span class="file-ghost">  108.0 ‚îÄ‚îÄ‚îÄ‚îÄ ‚ñë‚ñë‚ñë (sub-audible carrier?)</span>\n';
     if(m.includes('SIGNAL_DISCOVERY')){
       t+='<span class="file-ghost">  115.3 ‚îÄ‚îÄ‚îÄ‚îÄ ??? (anomalous ‚Äî outside normal band)</span>\n';
     }
     t+='\n';
     t+='<span class="file-dim">Peak signal: 97.7 MHz @ amplitude ~70</span>\n';
     t+='<span class="file-ghost">Hint: use SCANNER.EXE to tune and lock signals</span>\n';
     if(m.includes('DEEP_SCAN')){
       t+='\n<span class="file-dim">NOTE: All three frequencies correlate to encrypted audio payloads</span>\n';
       t+='<span class="file-ghost">Use DECODE.EXE to decrypt. Lock signals first via SCANNER.</span>\n';
     }
     return t;
   }},
  {name:'access.log',icon:'üîê',size:'0.8 KB',date:'‚ñà‚ñà/‚ñà‚ñà/‚ñà‚ñà',secret:null,milestone:'SIGNAL_DISCOVERY',
   content:()=>{
     let t='<div class="file-heading">‚îÄ‚îÄ ACCESS LOG ‚îÄ‚îÄ</div>\n';
     t+='SECURE.EXE authentication system\n';
     t+='Status: ACTIVE\n\n';
     t+='<span class="file-dim">Recent authentication attempts:</span>\n\n';
     t+='  [‚ñà‚ñà:‚ñà‚ñà:‚ñà‚ñà] code 1337 ‚Äî <span class="file-warn">STATUS: AWAITING INPUT</span>\n';
     t+='  [‚ñà‚ñà:‚ñà‚ñà:‚ñà‚ñà] code 9775 ‚Äî <span class="file-warn">STATUS: AWAITING INPUT</span>\n';
     t+='  [‚ñà‚ñà:‚ñà‚ñà:‚ñà‚ñà] code ‚ñà‚ñà‚ñà‚ñà ‚Äî <span class="file-error">STATUS: ‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà</span>\n';
     t+='  [‚ñà‚ñà:‚ñà‚ñà:‚ñà‚ñà] code ‚ñà‚ñà‚ñà‚ñà ‚Äî <span class="file-error">STATUS: ‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà</span>\n\n';
     t+='<span class="file-ghost">NOTE: Valid codes unlock archived materials</span>\n';
     t+='<span class="file-ghost">Two codes visible. Two more are out there.</span>\n';
     return t;
   }},
  {name:'transmission.log',icon:'üì°',size:'0.4 KB',date:'??/??/??',secret:null,milestone:'DEEP_SCAN',
   content:()=>{
     let t='<div class="file-heading">‚îÄ‚îÄ TRANSMISSION LOG ‚îÄ‚îÄ</div>\n';
     t+='<span class="file-dim">INTERCEPTED DATA FRAGMENT</span>\n';
     t+='<span class="file-dim">Source: UNKNOWN</span>\n';
     t+='<span class="file-dim">Encryption: PARTIAL CLEARTEXT</span>\n\n';
     t+='<span class="file-ghost">  ...the signal was never meant to be found...</span>\n';
     t+='<span class="file-ghost">  ...three frequencies, three keys, three doors...</span>\n';
     t+='<span class="file-ghost">  ...but there is a fourth word...</span>\n';
     t+='<span class="file-ghost">  ...not a frequency, not a number...</span>\n';
     t+='<span class="file-ghost">  ...eight letters, spoken only once...</span>\n';
     t+='<span class="file-ghost">  ...the ‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà sees everything...</span>\n\n';
     t+='<span class="file-dim">FRAGMENT ENDS</span>\n';
     t+='<span class="file-error">WARNING: Source signal degrading. Data may be lost.</span>\n';
     return t;
   }},
];

function getVisibleFiles(){
  const m=state.progression.milestones;
  return FILE_SYSTEM.filter(f=>{
    if(f.always)return true;
    if(f.milestone)return m.includes(f.milestone);
    return false;
  });
}

let filesCurrentFolder='root';

function filesRenderTree(){
  const tree=document.getElementById('files-tree');
  const enc=CONFIG.tracks.filter(t=>t.locked&&!state.discovered.has(t.id)).length;
  let html='';
  html+=`<div class="tree-item${filesCurrentFolder==='root'?' active':''}" onclick="filesNavigate('root')">üìÅ C:\\RCPLAYER</div>`;
  html+=`<div class="tree-sub">`;
  html+=`<div class="tree-item${filesCurrentFolder==='logs'?' active':''}" onclick="filesNavigate('logs')">üìÅ logs</div>`;
  html+=`<div class="tree-item${filesCurrentFolder==='assets'||filesCurrentFolder==='audio'?' active':''}" onclick="filesNavigate('assets')">üìÅ redacted_assets</div>`;
  html+=`<div class="tree-sub">`;
  html+=`<div class="tree-item${filesCurrentFolder==='audio'?' active':''}" onclick="filesNavigate('audio')">üìÅ audio${enc>0?' üîí':''}</div>`;
  html+=`</div>`;
  html+=`</div>`;
  tree.innerHTML=html;
}

function filesNavigate(folder){
  filesCurrentFolder=folder;
  filesRenderTree();
  if(folder==='root')filesShowRoot();
  else if(folder==='logs')filesShowLogs();
  else if(folder==='assets')filesShowAssets();
  else if(folder==='audio')filesShowAudio();
}

function filesShowRoot(){
  const list=document.getElementById('files-list');
  document.getElementById('files-addr-path').textContent='C:\\RCPLAYER\\';
  let html='';
  html+=`<div class="file-row" ondblclick="filesNavigate('logs')" onclick="filesSelectRow(this)">`;
  html+=`<span class="file-icon">üìÅ</span>`;
  html+=`<span class="file-name">logs</span>`;
  html+=`<span class="file-size"></span>`;
  html+=`<span class="file-type">Folder</span>`;
  html+=`<span class="file-date">‚ñà‚ñà/‚ñà‚ñà/‚ñà‚ñà</span>`;
  html+=`</div>`;
  html+=`<div class="file-row" ondblclick="filesNavigate('assets')" onclick="filesSelectRow(this)">`;
  html+=`<span class="file-icon">üìÅ</span>`;
  html+=`<span class="file-name">redacted_assets</span>`;
  html+=`<span class="file-size"></span>`;
  html+=`<span class="file-type">Folder</span>`;
  html+=`<span class="file-date">‚ñà‚ñà/‚ñà‚ñà/‚ñà‚ñà</span>`;
  html+=`</div>`;
  list.innerHTML=html;
  document.getElementById('files-status-left').textContent='2 object(s)';
  document.getElementById('files-status-right').textContent='';
}

function filesShowAssets(){
  const list=document.getElementById('files-list');
  document.getElementById('files-addr-path').textContent='C:\\RCPLAYER\\redacted_assets\\';
  const enc=CONFIG.tracks.filter(t=>t.locked&&!state.discovered.has(t.id)).length;
  let html='';
  html+=`<div class="file-row" ondblclick="filesNavigate('audio')" onclick="filesSelectRow(this)">`;
  html+=`<span class="file-icon">üìÅ</span>`;
  html+=`<span class="file-name">audio${enc>0?' üîí':''}</span>`;
  html+=`<span class="file-size"></span>`;
  html+=`<span class="file-type">Folder</span>`;
  html+=`<span class="file-date">‚ñà‚ñà/‚ñà‚ñà/‚ñà‚ñà</span>`;
  html+=`</div>`;
  list.innerHTML=html;
  document.getElementById('files-status-left').textContent='1 object(s)';
  document.getElementById('files-status-right').textContent=enc>0?`${enc} file(s) encrypted`:'';
}

function filesShowLogs(){
  const list=document.getElementById('files-list');
  document.getElementById('files-addr-path').textContent='C:\\RCPLAYER\\logs\\';
  const visible=getVisibleFiles();
  let html='';
  visible.forEach(f=>{
    html+=`<div class="file-row" ondblclick="filesOpenFile('${f.name}')" onclick="filesSelectRow(this)">`;
    html+=`<span class="file-icon">${f.icon}</span>`;
    html+=`<span class="file-name">${f.name}</span>`;
    html+=`<span class="file-size">${f.size}</span>`;
    html+=`<span class="file-type">LOG</span>`;
    html+=`<span class="file-date">${f.date}</span>`;
    html+=`</div>`;
  });
  list.innerHTML=html;
  const enc=CONFIG.tracks.filter(t=>t.locked&&!state.discovered.has(t.id)).length;
  document.getElementById('files-status-left').textContent=`${visible.length} object(s)`;
  document.getElementById('files-status-right').textContent=enc>0?`${enc} file(s) encrypted`:'';
}

function filesShowAudio(){
  const list=document.getElementById('files-list');
  document.getElementById('files-addr-path').textContent='C:\\RCPLAYER\\redacted_assets\\audio\\';
  let html='';
  CONFIG.tracks.forEach((tk,i)=>{
    const unlocked=tk.visible||state.discovered.has(tk.id);
    if(unlocked){
      html+=`<div class="file-row" ondblclick="playTrackByIndex(${i})" onclick="filesSelectRow(this)">`;
      html+=`<span class="file-icon">üéµ</span>`;
      html+=`<span class="file-name">${tk['file_'+CONFIG.format]}</span>`;
      html+=`<span class="file-size">~9 MB</span>`;
      html+=`<span class="file-type">MP3</span>`;
      html+=`<span class="file-date">320kbps</span>`;
      html+=`</div>`;
    }else{
      const isLocked=tk.unlockCode&&scannerState.lockedSignals.find(s=>s.code===tk.unlockCode)
      const dblAction=isLocked?`ondblclick="decodeOpenForSignal('${tk.unlockCode}')" style="cursor:pointer"`:''
      html+=`<div class="file-row locked" ${dblAction}>`;
      html+=`<span class="file-icon">üîí</span>`;
      html+=`<span class="file-name">${isLocked?'‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà.‚ñà‚ñà‚ñà [DECODE]':'‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà.‚ñà‚ñà‚ñà'}</span>`;
      html+=`<span class="file-size">ENC</span>`;
      html+=`<span class="file-type">Encrypted</span>`;
      html+=`<span class="file-date">${isLocked?'ready':'locked'}</span>`;
      html+=`</div>`;
    }
  });
  list.innerHTML=html;
  document.getElementById('files-status-left').textContent=`${CONFIG.tracks.length} object(s)`;
  document.getElementById('files-status-right').textContent='';
}

function filesSelectRow(el){
  document.querySelectorAll('#files-list .file-row').forEach(r=>r.classList.remove('selected'));
  el.classList.add('selected');
}

function filesShowList(){filesNavigate('logs')}

let _notepadCounter=0;
function filesOpenFile(name){
  const file=FILE_SYSTEM.find(f=>f.name===name);
  if(!file)return;
  playSFX('ui_click',0.3);
  // Spawn a new notepad instance
  _notepadCounter++;
  const id='notepad-file-'+_notepadCounter;
  const offset=20*(_notepadCounter%8);
  const np=document.createElement('div');
  np.id=id;
  np.className='notepad-instance show';
  np.style.left=(300+offset)+'px';
  np.style.top=(150+offset)+'px';
  np.innerHTML=`<div class="popup-titlebar"><span>üìù NOTEPAD.EXE ‚Äî ${name}</span><span class="popup-close" onclick="document.getElementById('${id}').remove()">‚úï</span></div><div class="notepad-content">${file.content()}</div>`;
  document.body.appendChild(np);
  WindowRegistry.discover('notepad-popup');
  // Trigger secret + progression
  if(file.secret)addSecret(file.secret);
  const fn=name.replace(/\.log$/,'');
  if(!state.progression.filesRead.includes(fn)){state.progression.filesRead.push(fn);checkProgression()}
}

function openFilesExe(){
  document.getElementById('files-popup').classList.add('show');
  WindowRegistry.discover('files-popup');
  filesRenderTree();
  filesShowRoot();
}

// ‚ïê‚ïê‚ïê DRAGGABLE POPUPS ‚ïê‚ïê‚ïê
var _dragPopup = null, _dragSX = 0, _dragSY = 0, _dragIL = 0, _dragIT = 0;
document.addEventListener('mousedown', function(e) {
  var tb = e.target;
  while (tb && !tb.classList.contains('popup-titlebar')) tb = tb.parentElement;
  if (!tb) return;
  if (e.target.className && e.target.className.indexOf && e.target.className.indexOf('popup-close') !== -1) return;
  if (e.target.tagName === 'BUTTON') return;
  var popup = tb.parentElement;
  if (!popup || !popup.id) return;
  e.preventDefault();
  _dragPopup = popup;
  _dragSX = e.clientX;
  _dragSY = e.clientY;
  var rect = popup.getBoundingClientRect();
  _dragIL = rect.left;
  _dragIT = rect.top;
  popup.style.transform = 'none';
  popup.style.left = _dragIL + 'px';
  popup.style.top = _dragIT + 'px';
  popup.style.right = 'auto';
  popup.style.zIndex = '10000';
});
document.addEventListener('mousemove', function(e) {
  if (!_dragPopup) return;
  e.preventDefault();
  _dragPopup.style.left = (_dragIL + e.clientX - _dragSX) + 'px';
  _dragPopup.style.top = (_dragIT + e.clientY - _dragSY) + 'px';
});
document.addEventListener('mouseup', function() {
  if (_dragPopup) {
    _dragPopup.style.zIndex = '9997';
    _dragPopup = null;
  }
});



// Notepad focus handling
const notepadDiv = document.getElementById('notepad-textarea');
if (notepadDiv) {
  notepadDiv.addEventListener('focus', (e) => {
    if (notepadDiv.textContent === 'Type your notes here...') {
      notepadDiv.textContent = '';
    }
  });
  
  notepadDiv.addEventListener('blur', (e) => {
    if (notepadDiv.textContent.trim() === '') {
      notepadDiv.textContent = 'Type your notes here...';
    }
  });
}


</script>

<!--
‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë

you're reading the source. good.

the frequencies are: 97.7 and 108.0
try: read frequencies.log
try: tune 97.7
try: tune 108.0

the word that opens everything is eight letters long.
it starts with R.

‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ïó‚ñà‚ñà‚ïó ‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ïó ‚ñà‚ñà‚ñà‚ïó   ‚ñà‚ñà‚ïó ‚ñà‚ñà‚ñà‚ñà‚ñà‚ïó ‚ñà‚ñà‚ïó
‚ñà‚ñà‚ïî‚ïê‚ïê‚ïê‚ïê‚ïù‚ñà‚ñà‚ïë‚ñà‚ñà‚ïî‚ïê‚ïê‚ïê‚ïê‚ïù ‚ñà‚ñà‚ñà‚ñà‚ïó  ‚ñà‚ñà‚ïë‚ñà‚ñà‚ïî‚ïê‚ïê‚ñà‚ñà‚ïó‚ñà‚ñà‚ïë
‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ïó‚ñà‚ñà‚ïë‚ñà‚ñà‚ïë  ‚ñà‚ñà‚ñà‚ïó‚ñà‚ñà‚ïî‚ñà‚ñà‚ïó ‚ñà‚ñà‚ïë‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ïë‚ñà‚ñà‚ïë
‚ïö‚ïê‚ïê‚ïê‚ïê‚ñà‚ñà‚ïë‚ñà‚ñà‚ïë‚ñà‚ñà‚ïë   ‚ñà‚ñà‚ïë‚ñà‚ñà‚ïë‚ïö‚ñà‚ñà‚ïó‚ñà‚ñà‚ïë‚ñà‚ñà‚ïî‚ïê‚ïê‚ñà‚ñà‚ïë‚ñà‚ñà‚ïë
‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ïë‚ñà‚ñà‚ïë‚ïö‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ïî‚ïù‚ñà‚ñà‚ïë ‚ïö‚ñà‚ñà‚ñà‚ñà‚ïë‚ñà‚ñà‚ïë  ‚ñà‚ñà‚ïë‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ïó
‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù‚ïö‚ïê‚ïù ‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù ‚ïö‚ïê‚ïù  ‚ïö‚ïê‚ïê‚ïê‚ïù‚ïö‚ïê‚ïù  ‚ïö‚ïê‚ïù‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù

‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë
-->
</body>
</html>
